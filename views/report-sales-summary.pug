extends layout

block content
    form(method='POST' action='/reports-sales-summary' id='salesSummaryForm')
        input(type='hidden' name='viewType' id='viewTypeInput' value=viewType || 'daily')
        
        script.
            // ================================
            // RAW DATA FROM BACKEND (NO TOTAL ROW)
            // ================================
            var SaleSummaryFromServer = !{JSON.stringify(Saleslist)};
            var currentViewType = '#{viewType}' || 'daily';

            // ================================
            // RENDER TABLE
            // ================================
            function renderTable(array, tabletitle, numberColumns = [], tableWidthClass = '') {

                if (array.length === 0) {
                    return "<p class='text-center'><strong> *** No "+tabletitle+" *** </strong></p>";
                }

                // Detect numeric columns
                if (numberColumns.length === 0) {
                    numberColumns = Object.keys(array[0])
                        .filter(key => key !== 'Date' && key !== 'Day' && key !== 'Month');
                }

                var result = "<div class='card' style='margin-bottom: 10px;'>";
                result += "<div class='card-header text-center font-weight-bold'>"+tabletitle+"</div>";
                result += "<div class='card-body "+tableWidthClass+"' style='padding-bottom: 10px;'>";
                result += "<table class='table table-bordered table-sm' style='width:100%; border:1px solid #000;'>";

                // Headers
                result += "<thead class='thead-light text-center'><tr>";
                Object.keys(array[0]).forEach(key => {
                    result += "<th style='border:1px solid #000;'>" + key + "</th>";
                });
                result += "</tr></thead>";

                // Body
                result += "<tbody>";

                for (let i = 0; i < array.length; i++) {

                    let row = array[i];
                    let rowClass = "";

                    // Weekend highlight (only for daily view)
                    if (currentViewType === 'daily' && (row.Day === "Sat" || row.Day === "Sun")) {
                        rowClass += " bg-warning ";
                    }

                    // Total row formatting
                    if (row.Date === "Total" || row.Month === "Total") {
                        rowClass += " font-weight-bold text-danger ";
                    }

                    result += "<tr class='"+rowClass+"'>";

                    Object.keys(row).forEach(key => {
                        let dataValue = row[key];

                        // Numeric formatting
                        if (numberColumns.includes(key) && dataValue !== "" && !isNaN(dataValue)) {

                            let printedValue;

                            // Convert totals to KL
                            if (row.Date === "Total" || row.Month === "Total") {
                                printedValue = (Number(dataValue) / 1000).toLocaleString('en-IN', {
                                    minimumFractionDigits: 2, maximumFractionDigits: 2
                                }) + " KL";
                            } else {
                                printedValue = Number(dataValue).toLocaleString('en-IN', {
                                    minimumFractionDigits: 2, maximumFractionDigits: 2
                                });
                            }

                            result += "<td class='text-right "+rowClass+"' style='border:1px solid #000;'>" + printedValue + "</td>";
                        }
                        else {
                            // CENTER ONLY THE DAY COLUMN
                            let align = (key === "Day") ? "text-center" : "text-left";

                            result += "<td class='"+align+" "+rowClass+"' style='border:1px solid #000;'>" + dataValue + "</td>";
                        }
                    });

                    result += "</tr>";
                }

                result += "</tbody></table></div></div>";
                return result;
            }


            // ================================
            // APPLY FILTERS (Day + Weekend + Totals) - Only for Daily View
            // ================================
            function applyFilters() {

                // For monthly view, just render without filters
                if (currentViewType === 'monthly') {
                    document.getElementById("SalesSummary-table-container").innerHTML =
                        renderTable(SaleSummaryFromServer, "Sales (Ltrs.)");
                    return;
                }

                // Daily view filtering
                let selectedDay = document.getElementById("dayFilter").value;
                let weekendOnly = document.getElementById("weekendOnly").checked;

                // Remove backend total rows if any
                let rows = SaleSummaryFromServer.filter(r => r.Date !== "Total" && r.Month !== "Total");

                // FILTERING
                let filtered = rows.filter(row => {

                    // Weekend-only mode
                    if (weekendOnly) {
                        return (row.Day === "Sat" || row.Day === "Sun");
                    }

                    // Day dropdown filter
                    if (selectedDay && row.Day !== selectedDay) return false;

                    return true;
                });


                // ================================
                // CLIENT-SIDE TOTAL CALCULATION
                // ================================
                if (filtered.length > 0) {

                    let totals = {};
                    let sample = filtered[0];

                    let totalRow = currentViewType === 'monthly' ? { Month: "Total" } : { Date: "Total", Day: "" };

                    Object.keys(sample).forEach(key => {
                        if (!isNaN(sample[key]) && key !== "Date" && key !== "Day" && key !== "Month") {
                            totals[key] = 0;
                        }
                    });

                    filtered.forEach(row => {
                        Object.keys(totals).forEach(key => {
                            totals[key] += Number(row[key] || 0);
                        });
                    });

                    Object.keys(totals).forEach(key => {
                        totalRow[key] = totals[key];
                    });

                    filtered.push(totalRow);
                }

                // RENDER
                document.getElementById("SalesSummary-table-container").innerHTML =
                    renderTable(filtered, "Sales (Ltrs.)");
            }

            // Switch between Day-wise and Month-wise views
            function switchView(viewType) {
                document.getElementById('viewTypeInput').value = viewType;
                document.getElementById('salesSummaryForm').submit();
            }

            // INITIAL TABLE RENDER
            document.addEventListener("DOMContentLoaded", function() {
                applyFilters(); // Automatically calculate totals on first load
                
                // Show/hide filters based on view type
                toggleFilters();
            });

            // Show/hide day filters for monthly view
            function toggleFilters() {
                let dayFilterCell = document.getElementById('dayFilterCell');
                let weekendFilterCell = document.getElementById('weekendFilterCell');
                
                if (currentViewType === 'monthly') {
                    if (dayFilterCell) dayFilterCell.style.display = 'none';
                    if (weekendFilterCell) weekendFilterCell.style.display = 'none';
                } else {
                    if (dayFilterCell) dayFilterCell.style.display = 'table-cell';
                    if (weekendFilterCell) weekendFilterCell.style.display = 'table-cell';
                }
            }

        // ================================
        // TABS for Day-wise and Month-wise
        // ================================
        ul.nav.nav-tabs
            li.nav-item
                a.nav-link(class=viewType === 'daily' ? 'active' : '', href='#', onclick='switchView("daily"); return false;') Day-wise
            li.nav-item
                a.nav-link(class=viewType === 'monthly' ? 'active' : '', href='#', onclick='switchView("monthly"); return false;') Month-wise

        div.row &nbsp;

      
        // ================================
        // FILTER BAR (UI)
        // ================================
        table.center
            tr
                td Date Range:
                td
                    select#dateRange.form-control(onchange="updateDateRange()")
                        option(value='today') Today
                        option(value='yesterday') Yesterday
                        option(value='this_week') This Week
                        option(value='this_month', selected=true) This Month
                        option(value='last_month') Last Month
                        option(value='this_financial_year') This Financial Year
                        option(value='last_financial_year') Last Financial Year
                        option(value='custom') Custom Date
                td &nbsp;

                if viewType === 'daily'
                    td Day:
                    td
                        select#dayFilter.form-control(onchange="applyFilters()")
                            option(value='') All Days
                            option(value='Mon') Mon
                            option(value='Tue') Tue
                            option(value='Wed') Wed
                            option(value='Thu') Thu
                            option(value='Fri') Fri
                            option(value='Sat') Sat
                            option(value='Sun') Sun
                    td &nbsp;

                    td Weekend Only:
                    td
                        input#weekendOnly(type='checkbox', onchange='applyFilters()')
                    td &nbsp;

                td From Date:
                td
                    input#fromclosingDate.form-control(type='date', name='fromClosingDate', value=fromClosingDate, required)
                td &nbsp;

                td To Date:
                td
                    input#toclosingDate.form-control(type='date', name='toClosingDate', value=toClosingDate, required)
                td &nbsp;

                include report-print-download.pug


    // ================================
    // REPORT BODY
    // ================================
    div 
        div.row &nbsp;
        h4.font-weight-bold.text-center= viewType === 'monthly' ? "Fuel Sales Summary - Month-wise" : "Fuel Sales Summary - Day-wise"
        h6.text-center= `${formattedFromDate} to ${formattedToDate}` 
        h4.font-weight-bold.text-success.text-center

    if (Saleslist)
        div.col-md-12
            div.row &nbsp;
            div(id="SalesSummary-table-container")
    else
        div.row.bg-light No Transactions.

    include overlay.pug