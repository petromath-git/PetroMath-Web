extends layout
include mixins/new-closing-mixins
include mixins/summary-mixins

block content
    style.
    - var maxCreditsRowCnt = config.maxCreditsRowCnt;
    - var maxCashSalesRowCnt = config.maxCashSalesRowCnt;
    - var maxExpensesRowCnt = config.maxExpensesRowCnt;
    - var maxDigitalSalesRowCnt = config.maxDigitalSalesRowCnt;
    - var currency = config.currency;
    - var denominationValues = config.denominationValues;
    - var denominationValuesJson = config.denominationValuesJson;
    input(type='hidden' id='currency_hiddenValue' value= currency)
    input(type='hidden' id='denominationValuesJson_hiddenValue' value= denominationValuesJson)
    input(type='hidden' id='productIdAliasMapping_hiddenValue' value= productIdAliasMapping)

    form
        div
            ul.nav.nav-tabs
                li.nav-item.col-md.active
                    a.nav-link.active#closing_tab(data-toggle="tab" href="#new_closing" onclick=`trackMenu(this)`) Closing
                li.nav-item.col-md
                    a.nav-link#attendance_tab(data-toggle="tab" href="#new_attendance" onclick=`trackMenu(this)`) Attendance
                li.nav-item.col-md
                    a.nav-link#reading_tab(data-toggle="tab" href="#new_readings" onclick=`updateProductPrices(this)`) Reading
                if show2TSalesTab
                    li.nav-item.col-md
                        a.nav-link#sales_2t_tab(data-toggle="tab" href="#sales_2t" onclick=`trackMenu(this)`) 2T Sales
                li.nav-item.col-md
                    a.nav-link#cash_sales_tab(data-toggle="tab" href="#new_cash_sales" onclick=`cashSaleOrCreditUpdateProductTypePrices(this, 'cash-sale-')`) Lube Sales
                li.nav-item.col-md
                    a.nav-link#credit_sales_tab(data-toggle="tab" href="#new_credit_sales" onclick=`cashSaleOrCreditUpdateProductTypePrices(this, 'credit-')`) Credit Sales
                li.nav-item.col-md                    
                    a.nav-link#digital_sales_tab(data-toggle="tab" href="#new_digital_sales" onclick=`calculateDigitalSalesAndTrackMenu(this)`) Digital Sales
                li.nav-item.col-md
                    a.nav-link#expenses_tab(data-toggle="tab" href="#new_expenses" onclick=`trackMenu(this)`) Expenses
                li.nav-item.col-md
                    a.nav-link#summary_tab(data-toggle="tab" href="#summary" onclick="populateSummary(this)") Summary

            div.tab-content
                // ----------------------- New closing details ----------------------------
                div.row &nbsp;
                div.container#new_closing(class="tab-pane active")
                    div.row &nbsp;
                    input(type='hidden' name='location' value= location)
                    input(type='hidden' id='user' name='user' value= user)
                    input(type='hidden' id='closing_hiddenId' )
                    input(type='hidden' id='currentTabForSave' value='saveClosing')
                    div.row
                        div.col
                            label(for='cashierId') Cashier Name:
                            select#cashierId.form-control(name='closing__cashierId' required)
                                if cashiers
                                    each val in cashiers
                                        option(value=`${val.personId}`)= val.personName
                            div.invalid-feedback Cashier is required.
                        div.col
                            input(type='hidden' id='h_cashierDate' value= currentDate)
                            label(for='cashierDate') Date:
                            input#cashierDate.form-control(type='date', name='closing__cashierDate', value=currentDate max=currentDate required min=minDateForNewClosing)
                            div.invalid-feedback Closing date is required.
                        div.col
                            label(for='cashGiven') Opening Cash Given:
                            input#cashGiven.form-control(type='number', name='closing__cashGiven' required value=0 min=0 step=0.01 oninput='validity.valid||(value="")')
                            div.invalid-feedback Cash given is required.
                        div.col
                            label(for='notes') Notes:
                            input#notes.form-control(type='text', name='closing__notes')
                    div.row
                        div.col &nbsp;
                    div.row#gasoline-prices
                        if productValues
                            +listProductNames(pumpProductValues, 'rate_')
                    div.row
                        div.col &nbsp;
                    div.row(align="center")
                        div.col
                            button.btn.btn-primary(type="button", onClick="trackMenuWithName('attendance_tab')") Next &raquo;

                                        // ----------------------- Attendance details ----------------------------
                div.tab-pane.fade#new_attendance
                    div
                        div.col-16
                            div.table-responsive
                                table.table#attendance-table
                                    tbody.w-100
                                        thead(class="thead-light")
                                            tr
                                                th(scope="col") Person
                                                th(scope="col") Shift
                                                th(scope="col") IN Date-Time
                                                //-th(scope="col") IN Time
                                                th(scope="col") OUT Date-Time
                                                //-=th(scope="col") OUT Time
                                                th(scope="col") Notes
                                                th(scope="col")

                                                - var rowCnt = 0
                                                while rowCnt < 8
                                                    +addNewAttendance(rowCnt++)
                    div.row
                        div.col &nbsp;
                    div.row
                        div.col(align="center")
                            button.btn.btn-info(type="button", onClick="showAddedRow('attendance')") Add

                    div.row
                        div.col &nbsp;

                    div.row(align="center")
                        div.col
                            button.btn.btn-primary(type="button", onClick="trackMenuWithName('reading_tab')") Next &raquo;

                // ----------------------- New reading details ----------------------------
                div.tab-pane.fade#new_readings
                    div.row.bg-light.p-3.mb-3
                        div.col-md-4
                            label(for="closeReadingTime").font-weight-bold Closing Reading Time *
                            select#closeReadingTime.form-control(name="close_reading_time" required)
                                option(value="") -- Select Reading Time --
                                option(value="00:00:00") 12:00 AM
                                option(value="00:30:00") 12:30 AM
                                option(value="01:00:00") 1:00 AM
                                option(value="01:30:00") 1:30 AM
                                option(value="02:00:00") 2:00 AM
                                option(value="02:30:00") 2:30 AM
                                option(value="03:00:00") 3:00 AM
                                option(value="03:30:00") 3:30 AM
                                option(value="04:00:00") 4:00 AM
                                option(value="04:30:00") 4:30 AM
                                option(value="05:00:00") 5:00 AM
                                option(value="05:30:00") 5:30 AM
                                option(value="06:00:00") 6:00 AM
                                option(value="06:30:00") 6:30 AM
                                option(value="07:00:00") 7:00 AM
                                option(value="07:30:00") 7:30 AM
                                option(value="08:00:00") 8:00 AM
                                option(value="08:30:00") 8:30 AM
                                option(value="09:00:00") 9:00 AM
                                option(value="09:30:00") 9:30 AM
                                option(value="10:00:00") 10:00 AM
                                option(value="10:30:00") 10:30 AM
                                option(value="11:00:00") 11:00 AM
                                option(value="11:30:00") 11:30 AM
                                option(value="12:00:00") 12:00 PM
                                option(value="12:30:00") 12:30 PM
                                option(value="13:00:00") 1:00 PM
                                option(value="13:30:00") 1:30 PM
                                option(value="14:00:00") 2:00 PM
                                option(value="14:30:00") 2:30 PM
                                option(value="15:00:00") 3:00 PM
                                option(value="15:30:00") 3:30 PM
                                option(value="16:00:00") 4:00 PM
                                option(value="16:30:00") 4:30 PM
                                option(value="17:00:00") 5:00 PM
                                option(value="17:30:00") 5:30 PM
                                option(value="18:00:00") 6:00 PM
                                option(value="18:30:00") 6:30 PM
                                option(value="19:00:00") 7:00 PM
                                option(value="19:30:00") 7:30 PM
                                option(value="20:00:00") 8:00 PM
                                option(value="20:30:00") 8:30 PM
                                option(value="21:00:00") 9:00 PM
                                option(value="21:30:00") 9:30 PM
                                option(value="22:00:00") 10:00 PM
                                option(value="22:30:00") 10:30 PM
                                option(value="23:00:00") 11:00 PM
                                option(value="23:30:00") 11:30 PM                        
                            small.text-muted Select time when readings were taken for this shift closure
                        div.col-md-8#smart-reading-section(style="display: none;")
                            label.font-weight-bold Smart Entry
                            div.row
                                div.col-md-8
                                    input#smart-reading-entry.form-control.form-control-sm(
                                        type='number' 
                                        step='0.001' 
                                        min='0'
                                        placeholder='Enter reading & press Enter to auto-fill'
                                        onkeypress='handleSmartReadingKeyPress(event)'
                                    )
                                div.col-md-4
                                    button.btn.btn-success.btn-sm.btn-block(
                                        type='button'
                                        onclick='smartFillClosingReading(parseFloat(document.getElementById("smart-reading-entry").value))'
                                    )
                                        i.fas.fa-check
                                        |  Fill
                            small.text-muted Auto-fills the nozzle with nearest opening reading                    
                    
                    div.row &nbsp;
                    if pumps &&  pumps.length > 0
                        div.row                            
                            each val in pumps                                
                                td
                                    +addProductCodesAsSelected(val, productValues, 'f_', (val.pumpReadings ? val.pumpReadings[0] : null))
                                td
                                    +addProductCodesAsSelected(val, productValues, 's_', (val.pumpReadings ? val.pumpReadings[1] : null))                      
                        div.row
                            table.table
                                tbody
                                    thead.thead-light
                                        th Nozzle
                                        if allowSecondaryPump
                                            th Price
                                        th Action
                                    tr
                                        td
                                            select#reading-pump-name.form-control(onchange="updatePriceOnReadingTab()")
                                                each val in pumps
                                                    option= val.pumpCode
                                        if allowSecondaryPump
                                            td
                                                input#reading-price.form-control(type="number" min="0" step=0.01)
                                        else
                                            input#reading-price(type="hidden")
                                        td
                                            a.btn.btn-info.btn-sm(onclick="showReadingPump()" style="margin-right: 5px;") Add Nozzle
                                            a.btn.btn-success.btn-sm(onclick="addAllPumps()") Add All Nozzles
                    else
                        div.row.bg-warning
                            pre.text-danger= `Note: Pumps data is empty at backend.`
                    div.row
                        div.col &nbsp;
                    div.row(align="center")
                        div.col
                            if show2TSalesTab
                                button.btn.btn-primary(type="button", onClick="trackMenuWithName('sales_2t_tab')") Next &raquo;
                            else
                                button.btn.btn-primary(type="button", onClick="trackMenuWithName('cash_sales_tab')") Next &raquo;

                if show2TSalesTab
                    // ----------------------- New 2T sales ---------------------------------
                    div.tab-pane.fade.container#sales_2t
                        if product2TValues && product2TValues.length > 0
                            div.row
                                each val in product2TValues
                                    +list2TProductNames(val)
                            div.row &nbsp;
                            div.row
                                // 2T details
                                each val in product2TValues
                                    +add2TProducts(val)
                        else
                            div.row.bg-warning
                                pre.text-danger= `Note: 2T oil products' data is empty at backend.`
                        div.row
                            div.col &nbsp;
                        div.row(align="center")
                            div.col
                                button.btn.btn-primary(type="button", onClick=`trackMenuWithName('cash_sales_tab')`) Next &raquo;

                // ----------------------- New cash sales details ----------------------------
                div.tab-pane.fade#new_cash_sales
                    style.
                        /* Header styling */
                        #cash-sale-table thead th {
                            text-align: center;
                            font-weight: 500;
                            color: #333;
                            font-size: 0.95rem;
                            vertical-align: middle;
                            padding-top: 8px;
                            padding-bottom: 8px;
                            letter-spacing: 0.2px;
                            white-space: nowrap; /* keeps headers on one line */
                        }
                    div
                        div.col-16
                            div.table-responsive
                                table.table#cash-sale-table
                                    tbody.w-100
                                        thead(class="thead-light")
                                            tr
                                                th(scope="col") Product
                                                th(scope="col") Bill #
                                                th(scope="col") Price
                                                th(scope="col") Price Discount
                                                th(scope="col") Quantity
                                                th(scope="col") Sale
                                                th(scope="col") Notes
                                                th(scope="col")

                                                - var rowCnt = 0
                                                while rowCnt < maxCashSalesRowCnt
                                                    +addCashSales(rowCnt++)
                                            tr
                                                td(colspan=3)
                                                td Total
                                                td
                                                    input.form-control#cash-sale-total(type='text' name='cash-sale-total' readonly value='0')
                                                td
                    div.row
                        div.col &nbsp;
                    div.row
                        div.col(align="center")
                            button.btn.btn-info(type="button", onClick="showAddedRow('cash-sale')") Add cash sales

                    div.row
                        div.col &nbsp;

                    div.row(align="center")
                        div.col
                            button.btn.btn-primary(type="button", onClick="trackMenuWithName('credit_sales_tab')") Next &raquo;

                // ----------------------- New credit sales details ----------------------------
                div.tab-pane.fade#new_credit_sales
                    style.
                        /* Header styling */
                        #credit-table thead th {
                            text-align: center;
                            font-weight: 500;
                            color: #333;
                            font-size: 0.95rem;
                            vertical-align: middle;
                            padding-top: 8px;
                            padding-bottom: 8px;
                            letter-spacing: 0.2px;
                            white-space: nowrap; /* keeps headers on one line */
                        }

                        /* Column width tuning */
                        #credit-table .col-product   { width: 10%; }
                        #credit-table .col-bill      { width: 7%; }
                        #credit-table .col-company   { width: 16%; }  /* More room for credit party */
                        #credit-table .col-vehicle   { width: 13%; }  /* More room for vehicle dropdown */
                        #credit-table .col-odo       { width: 7%; }
                        #credit-table .col-price     { width: 7%; }
                        #credit-table .col-discount  { width: 5%; }
                        #credit-table .col-qty       { width: 6%; }
                        #credit-table .col-sale      { width: 8%; }
                        #credit-table .col-notes     { width: 9%; }
                        #credit-table th:last-child  { width: 2%; text-align: center; } /* X delete column */

                        #credit-table .col-delete {
                            text-align: center;
                        }
                        #credit-table .col-delete .close {
                            font-size: 1.1rem;
                            color: #dc3545; /* Bootstrap danger red */
                            opacity: 0.7;
                            transition: opacity 0.2s;
                        }
                        #credit-table .col-delete .close:hover {
                            opacity: 1;
                        }

                        /* --- Fix Select2 width for vehicle dropdown --- */
                            #credit-table .select2-container--default .select2-selection--single {
                                display: inline-block;
                                width: auto !important;       /* auto-fit to text */
                                min-width: 120px;
                                max-width: 240px;             /* donâ€™t overflow layout */
                                height: 36px;
                                vertical-align: middle;
                            }

                            #credit-table .select2-container--default .select2-selection__rendered {
                                overflow: visible !important;
                                white-space: nowrap;
                                text-overflow: clip;
                                padding-right: 24px;          /* spacing for arrow */
                            }

                            #credit-table .select2-container--default .select2-selection__arrow {
                                right: 6px;
                            }
                    div
                        div.col-16
                            div.table-responsive
                                table.table#credit-table
                                    tbody.w-100
                                        thead(class="thead-light")
                                            tr
                                                th.col-product(scope="col") Product
                                                th.col-bill(scope="col") Bill #
                                                th.col-company(scope="col") Company
                                                th.col-vehicle(scope="col") Vehicle Number
                                                th.col-odo(scope="col") Odometer
                                                th.col-price(scope="col") Price
                                                th.col-discount(scope="col") Price Discount
                                                th.col-qty(scope="col") Quantity
                                                th.col-sale(scope="col") Sale
                                                th.col-notes(scope="col") Notes
                                                th.col-delete(scope="col")
                                                th(scope="col")
                                            - var rowCnt = 0
                                            while rowCnt < maxCreditsRowCnt
                                                +addCredits(rowCnt++)

                                            tr
                                                td(colspan=4)
                                                td Total
                                                td
                                                    input.form-control#credit-total(type='text' name='credit-total' readonly value='0')
                                                td
                    div.row
                        div.col &nbsp;
                    div.row
                        div.col(align="center")
                            button.btn.btn-info(type="button", onClick="showAddedCreditRow('credit')") Add credits

                    div.row
                        div.col &nbsp;
                    div.row(align="center")
                        div.col
                            button.btn.btn-primary(type="button", onClick="trackMenuWithName('digital_sales_tab')") Next &raquo;
                // ----------------------- New digital sales details ----------------------------
                div.tab-pane.fade#new_digital_sales
                    div
                        div.col-16
                            div.table-responsive
                                table.table#digital-sales-table
                                    tbody.w-100
                                        thead(class="thead-light")
                                            tr
                                                th(scope="col") Vendor
                                                th(scope="col") Amount
                                                th(scope="col") Transaction Date
                                                th(scope="col") Notes
                                                th(scope="col")

                                                - var rowCnt = 0                                                
                                                while rowCnt < maxDigitalSalesRowCnt
                                                    +addDigitalSales(rowCnt++)
                                            tr
                                                td(colspan=2)
                                                td Total
                                                td
                                                    input.form-control#digital-sales-total(type='text' name='digital-sales-total' readonly value='0')
                                                td
                    div.row
                        div.col &nbsp;
                    div.row
                        div.col(align="center")
                            button.btn.btn-info(type="button", onClick="showAddedDigitalSalesRow('digital-sales')") Add Digital Sales

                    div.row
                        div.col &nbsp;
                    div.row(align="center")
                        div.col
                            button.btn.btn-primary(type="button", onClick="trackMenuWithName('expenses_tab')") Next &raquo;

                // ----------------------- New expenses & denominations details ----------------------------
                div.tab-pane.container.fade#new_expenses
                    div.row
                        div.col-6
                            h5.sub-header Expenses
                            if expenseValues && expenseValues.length > 0
                                div.table-responsive
                                    table.table#exp-table
                                        tbody
                                            thead(class="thead-light")
                                                tr
                                                    th(scope="col") Expense
                                                    th(scope="col") Amount
                                                    th(scope="col") Notes
                                                    th(scope="col")
                                                - var rowCnt = 0
                                                while rowCnt < maxExpensesRowCnt
                                                    +addExpenses(rowCnt++, null)
                                                tr
                                                    td
                                                        label Total
                                                    td(colspan=2)
                                                        input.form-control#exp-total(type='text' name='exp-total' readonly value='0')
                                div.row
                                    input(type='hidden' id='firstExpenseDefaultAmt_hiddenValue' value= expenseValues[0].defaultAmt)
                                    div.col(align="center")
                                        button.btn.btn-info(type="button", onClick=`showExpenseAddedRow('exp', calculateExpenseTotal)`) Add new expense
                            else
                                div.row.bg-warning
                                    pre.text-danger= `Note: Master expense data is empty at backend.`

                        div.col-6
                            h5.sub-header Denominations
                            div.table-responsive
                                table.table
                                    tbody
                                        +addDenomRows(denominationValues)
                                        tr
                                            td
                                                label
                                                    Total
                                            td
                                                input.form-control#denominations_total(type='text' name='denominations_total' readonly value='0')

                    div.row
                        div.col &nbsp;
                    div.row(align="center")
                        div.col
                            button.btn.btn-primary(type="button", onClick=`trackMenuWithName('summary_tab')`) Next &raquo;

                // ----------------------- Summary ----------------------------
                div.tab-pane.fade#summary
                    div
                        div#summary-div
                            div
                                // Summary: Closing & Product rate details
                                div.container.table-info#v-closing-details
                                    div.row
                                        div.col-3
                                            span Cashier:&nbsp;
                                            span(id='valText-cashierId')
                                        div.col-3
                                            span Date:&nbsp;
                                            span(id='valDate-cashierDate')
                                        di.col-3
                                            span Opening Cash Given:&nbsp;
                                            span(id='val-cashGiven')
                                    div.table-success.row(align="center")
                                        div.col
                                            span Excess/Shortage:&nbsp;
                                            span#excess_storage_color
                                                b#excess_storage Excess

                                // Summary: pump reading details
                                div#v-pump-readings
                                    div &nbsp;
                                    div.row
                                        each val in pumps
                                            +summaryPumpInstancesData(val, productValues, 'f_')
                                            +summaryPumpInstancesData(val, productValues, 's_')

                                div.row
                                    // Summary: Cash sales
                                    div.col-6#v-cash-sale
                                        h6.sub-header Cash Sales
                                        div.table-responsive#vis-cash-sale-table
                                            table.table.table-sm
                                                thead.thead-light
                                                    tr
                                                        th(scope="col") Product
                                                        th(scope="col") Bill #
                                                        th(scope="col") Price
                                                        th(scope="col") Price Discount
                                                        th(scope="col") Quantity
                                                        th(scope="col") Sale

                                                    - var rowCnt = 0
                                                    while rowCnt < maxCashSalesRowCnt
                                                        +summaryCashSalesData(rowCnt++)
                                                    tr
                                                        td(colspan=3)
                                                        td
                                                            span
                                                                b Total
                                                        td
                                                            span
                                                                b#val-cash-sale-total= 0

                                    // Summary: Credit details
                                    div.col-6#v-credit
                                        h6.sub-header Credit Sales
                                        div.table-responsive#vis-credit-table
                                            table.table.table-sm
                                                thead.thead-light
                                                    tr
                                                        th(scope="col") Product
                                                        th(scope="col") Bill #
                                                        th(scope="col") Company
                                                        th(scope="col") Price
                                                        th(scope="col") Price Discount
                                                        th(scope="col") Quantity
                                                        th(scope="col") Sale
                                                        th(scope="col")

                                                - var rowCnt = 0
                                                while rowCnt < maxCreditsRowCnt
                                                    +summaryCreditsData(rowCnt++)
                                                tr
                                                    td(colspan=4)
                                                    td
                                                        span
                                                            b Total
                                                    td
                                                        span
                                                            b#val-credit-total= 0
                                div.row
                                    // Summary: Digital sales
                                    div.col-6#v-digital-sales
                                        h6.sub-header Digital Sales
                                        div.table-responsive#vis-digital-sales-table
                                            table.table.table-sm
                                                thead.thead-light
                                                    tr
                                                        th(scope="col") Vendor
                                                        th(scope="col") Amount
                                                        th(scope="col") Transaction Date
                                                        th(scope="col") Notes
                                                    - var rowCnt = 0
                                                    - var maxDigitalSalesRowCnt = 10
                                                    while rowCnt < maxDigitalSalesRowCnt
                                                        +summaryDigitalSalesData(rowCnt++)
                                                    tr
                                                        td(colspan=1)
                                                        td
                                                            span
                                                                b Total
                                                        td
                                                            span
                                                                b#val-digital-sales-total= 0
                                                        td                                           
                                    div.col-6
                                div.row
                                    if show2TSalesTab
                                        // 2T loose details
                                        div.col-3#v-2TLoose-sales
                                            span.sub-header 2TLoose Rate :
                                            span(id='val-loose2t-rate')
                                            +summary2TSalesData('loose2t')                                            
                                        // 2T pouch details
                                        div.col-3#v-2TPouch-sales
                                            span.sub-header 2TPouch Rate :
                                            span(id='val-pouch2t-rate')
                                            +summary2TSalesData('pouch2t')                                           
                                    // Summary: Expenses
                                    div.col-3#v-expenses
                                        h6.sub-header Expenses
                                        div.table-responsive
                                            table.table.table-sm#always-vis-summary_expense_table
                                                tbody
                                                    - var rowCnt = 0
                                                    while rowCnt < maxExpensesRowCnt
                                                        +showExpensesData(rowCnt++)
                                                    tr
                                                        td
                                                            span
                                                                b Total
                                                        td(colspan=2)
                                                            span
                                                                b#val-exp-total= 0
                                    // Summary: denominations
                                    div.col-3#v-denominations
                                        h6.sub-header Denominations
                                        div.table-responsive
                                            table.table.table-sm
                                                tbody
                                                    +showDenominationsData(denominationValues)
                                                    tr
                                                        td
                                                            span
                                                                b Total
                                                        td
                                                            span
                                                                b#val-denominations_total= 0
                    div.row(style="margin-top: 20px;")
                        div.col-md-4.col-lg-3
                            h6.sub-header Sales Revenue
                            +gasSalesTotal()
                    div.row
                        div.col &nbsp;
                    div(align="center")
                        span
                            button.btn.btn-dark(type="button", onClick='finishClosing(\'closing\',\'close-closing\', \'home_tab\')') CLOSE &raquo;

    script.    
        var vehicleData = !{JSON.stringify(vehicleData || {})};        
        window.pumpsData = !{JSON.stringify(pumps)};    
        window.productValuesData = !{JSON.stringify(productValues)};
        window.allowSecondaryPump = !{allowSecondaryPump};
                // Initialize Select2 for vehicle dropdowns
            function initVehicleSelect2() {
                $('.select2-vehicle').each(function() {
                    if ($(this).data('select2')) {
                        $(this).select2('destroy');
                    }
                    $(this).select2({
                        width: 'style',           // uses CSS width
                        dropdownAutoWidth: true,  // dropdown expands to content
                        minimumResultsForSearch: 5,
                        placeholder: 'Select Vehicle'
                    });
                });
            }

            // Initialize when DOM ready
            $(document).ready(function() {
                initVehicleSelect2();
            });

            // Re-init when "Add credits" adds new rows dynamically
            const _origShowAddedCreditRow = window.showAddedCreditRow;
            window.showAddedCreditRow = function(prefix) {
                if (typeof _origShowAddedCreditRow === 'function') {
                    _origShowAddedCreditRow(prefix);
                }
                initVehicleSelect2(); // ensure new row gets Select2 applied
            };
    script(src=`/javascripts/shift-products.js?v=${CACHE_BUST}`)   