extends layout

block content
    style.
        .system-table th {
            background-color: #e3f2fd !important;
        }
        .bank-table th {
            background-color: #fff3e0 !important;
        }
        .table-responsive {
            max-height: 65vh;
            overflow-y: auto;
        }
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .unmatched-row {
            background-color: #fff3cd !important;
            border-left: 3px solid #ffc107 !important;
        }
        .unmatched-row:hover {
            background-color: #ffe69c !important;
        }
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        .card-header.bg-primary-pastel {
            background: linear-gradient(135deg, #b3d9ff 0%, #cce5ff 100%) !important;
            color: #004085 !important;
        }
        .card-header.bg-warning-pastel {
            background: linear-gradient(135deg, #ffe6b3 0%, #fff2d9 100%) !important;
            color: #856404 !important;
        }
        .btn-group .btn {
            margin-right: 10px;
        }
        .btn-group .btn:last-child {
            margin-right: 0;
        }
        
    script.
        const currentDate = new Date().toISOString().split('T')[0];

        function updateDateRangev1() {
            const rangeSelect = document.getElementById('dateRange');
            const selectedRange = rangeSelect.value;
            const today = new Date();
            let fromDate, toDate;

            if (selectedRange === 'this_month') {
                fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            } else if (selectedRange === 'last_month') {
                fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                toDate = new Date(today.getFullYear(), today.getMonth(), 0);
            } else {
                return;
            }

            document.getElementById('fromclosingDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('toclosingDate').value = toDate.toISOString().split('T')[0];
        }

        function liveSearch() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toUpperCase();
            
            const systemRows = document.querySelectorAll('#system-table tbody tr');
            systemRows.forEach(row => {
                const txtValue = row.textContent || row.innerText;
                row.style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
            });
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr');
            bankRows.forEach(row => {
                const txtValue = row.textContent || row.innerText;
                row.style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
            });
        }
        
        function showAllTransactions() {
            const systemRows = document.querySelectorAll('#system-table tbody tr');
            systemRows.forEach(row => row.style.display = '');
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr');
            bankRows.forEach(row => row.style.display = '');
            
            document.getElementById('btn-show-all').classList.add('active');
            document.getElementById('btn-show-unmatched').classList.remove('active');
        }
        
        function showUnmatchedOnly() {
            const systemRows = document.querySelectorAll('#system-table tbody tr.unmatched-row');
            const allSystemRows = document.querySelectorAll('#system-table tbody tr');
            allSystemRows.forEach(row => {
                row.style.display = row.classList.contains('unmatched-row') ? '' : 'none';
            });
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr.unmatched-row');
            const allBankRows = document.querySelectorAll('#bank-table tbody tr');
            allBankRows.forEach(row => {
                row.style.display = row.classList.contains('unmatched-row') ? '' : 'none';
            });
            
            document.getElementById('btn-show-all').classList.remove('active');
            document.getElementById('btn-show-unmatched').classList.add('active');
        }
        
        let syncScrollEnabled = false;
        let isScrolling = false;
        
        function toggleSyncScroll() {
            syncScrollEnabled = !syncScrollEnabled;
            const btn = document.getElementById('btn-sync-scroll');
            
            if (syncScrollEnabled) {
                btn.classList.add('active');
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                
                const systemScroll = document.querySelector('#system-table').closest('.table-responsive');
                const bankScroll = document.querySelector('#bank-table').closest('.table-responsive');
                
                systemScroll.addEventListener('scroll', syncSystemToBankScroll);
                bankScroll.addEventListener('scroll', syncBankToSystemScroll);
            } else {
                btn.classList.remove('active');
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
                
                const systemScroll = document.querySelector('#system-table').closest('.table-responsive');
                const bankScroll = document.querySelector('#bank-table').closest('.table-responsive');
                
                systemScroll.removeEventListener('scroll', syncSystemToBankScroll);
                bankScroll.removeEventListener('scroll', syncBankToSystemScroll);
            }
        }
        
        function syncSystemToBankScroll(e) {
            if (isScrolling) return;
            isScrolling = true;
            
            const bankScroll = document.querySelector('#bank-table').closest('.table-responsive');
            bankScroll.scrollTop = e.target.scrollTop;
            
            setTimeout(() => { isScrolling = false; }, 50);
        }
        
        function syncBankToSystemScroll(e) {
            if (isScrolling) return;
            isScrolling = true;
            
            const systemScroll = document.querySelector('#system-table').closest('.table-responsive');
            systemScroll.scrollTop = e.target.scrollTop;
            
            setTimeout(() => { isScrolling = false; }, 50);
        }
        
        let currentTxnId = null;
        
        async function showImpactAnalysis(txnId) {
            currentTxnId = txnId;
            
            const modal = new bootstrap.Modal(document.getElementById('impactModal'));
            modal.show();
            
            document.getElementById('impactContent').innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading impact analysis...</p>
                </div>
            `;
            document.getElementById('btnConfirmDelete').disabled = true;
            
            try {
                const response = await fetch(`/reports-bank-recon/impact/${txnId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayImpact(data.impact);
                    document.getElementById('btnConfirmDelete').disabled = false;
                } else {
                    document.getElementById('impactContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            Error: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching impact:', error);
                document.getElementById('impactContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        Failed to load impact analysis.
                    </div>
                `;
            }
        }
        
        function displayImpact(impact) {
            let html = `
                <div class="mb-3">
                    <h6 class="text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        This will DELETE the following:
                    </h6>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong>Transaction Details</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Date:</strong> ${impact.transaction.trans_date}</p>
                        <p><strong>Remarks:</strong> ${impact.transaction.remarks || '-'}</p>
                        <p><strong>Amount:</strong> 
                            ${impact.transaction.credit_amount > 0 ? 
                                ` ₹${parseFloat(impact.transaction.credit_amount).toFixed(2)} (Credit)` : 
                                `₹${parseFloat(impact.transaction.debit_amount).toFixed(2)} (Debit)`}
                        </p>
                    </div>
                </div>
            `;
            
            if (impact.receipts && impact.receipts.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-receipt me-2"></i>${impact.receipts.length} Receipt(s) will be DELETED:</strong>
                        <ul class="mt-2 mb-0">
                `;
                impact.receipts.forEach(r => {
                    html += `<li>Receipt #${r.receipt_no || r.treceipt_id} - ₹${parseFloat(r.amount).toFixed(2)}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (impact.reconRecords && impact.reconRecords.length > 0) {
                html += `
                    <div class="alert alert-info">
                        <strong><i class="bi bi-link-45deg me-2"></i>${impact.reconRecords.length} Digital Reconciliation(s) will be CLEARED:</strong>
                        <ul class="mt-2 mb-0">
                `;
                impact.reconRecords.forEach(r => {
                    html += `<li>${r.source_table} (ID: ${r.source_id})</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (!impact.receipts || impact.receipts.length === 0) {
                html += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        No receipts linked. Safe to delete.
                    </div>
                `;
            }
            
            document.getElementById('impactContent').innerHTML = html;
        }
        
        let uploadedTransactions = [];
        
        function showUploadModal() {
            const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
            modal.show();
            
            document.getElementById('uploadStep1').style.display = 'block';
            document.getElementById('uploadStep2').style.display = 'none';
            document.getElementById('btnConfirmUpload').style.display = 'none';
            document.getElementById('bankStatementFile').value = '';
            uploadedTransactions = [];
        }
        
        async function uploadAndPreview() {
            const fileInput = document.getElementById('bankStatementFile');
            const bankId = document.getElementById('upload_bank_id').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            
            if (!bankId) {
                alert('Please select a bank');
                return;
            }
            
            const formData = new FormData();
            formData.append('bankStatement', fileInput.files[0]);
            formData.append('bank_id', bankId);
            
            document.getElementById('uploadStep1').style.display = 'none';
            document.getElementById('uploadStep2').style.display = 'block';
            
            try {
                const response = await fetch('/reports-bank-recon/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    uploadedTransactions = data.transactions;
                    displayPreview(data);
                    document.getElementById('btnConfirmUpload').style.display = 'block';
                } else {
                    document.getElementById('previewContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            Error: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('previewContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        Failed to process file.
                    </div>
                `;
            }
        }
        
        function displayPreview(data) {
            const previewDiv = document.getElementById('previewContent');
            
            let summaryHtml = `
                <div class="alert alert-info mb-3">
                    <strong><i class="bi bi-file-earmark-spreadsheet me-2"></i>Preview: ${data.summary.total} transactions found</strong>
                    ${data.summary.duplicates > 0 ? 
                        `<br><i class="bi bi-exclamation-triangle me-2 text-warning"></i>${data.summary.duplicates} possible duplicate(s) detected` 
                        : ''}
                </div>
            `;
            
            let tableHtml = `
                <div style="max-height: 500px; overflow-y: auto; overflow-x: auto; border: 1px solid #dee2e6;">
                    <table class="table table-sm table-hover table-bordered mb-0">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
                            <tr>
                                <th style="min-width: 100px;">Date</th>
                                <th style="min-width: 250px;">Description</th>
                                <th style="min-width: 100px; text-align: right;">Credit</th>
                                <th style="min-width: 100px; text-align: right;">Debit</th>
                                <th style="min-width: 100px; text-align: right;">Balance</th>
                                <th style="min-width: 80px; text-align: center;">Include</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.transactions.forEach((txn, index) => {
                const isDuplicate = data.duplicates.some(dup => 
                    dup.txn_date === txn.txn_date && 
                    dup.description === txn.description &&
                    parseFloat(dup.credit_amount) === parseFloat(txn.credit_amount) &&
                    parseFloat(dup.debit_amount) === parseFloat(txn.debit_amount)
                );
                
                const rowClass = isDuplicate ? 'table-warning' : '';
                const checked = isDuplicate ? '' : 'checked';
                const dupLabel = isDuplicate ? '<br><small class="text-warning">Dup?</small>' : '';
                
                tableHtml += `
                    <tr class="${rowClass}">
                        <td>${txn.txn_date}</td>
                        <td><div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${txn.description}">${txn.description}</div></td>
                        <td style="text-align: right;">${txn.credit_amount > 0 ? txn.credit_amount.toFixed(2) : '-'}</td>
                        <td style="text-align: right;">${txn.debit_amount > 0 ? txn.debit_amount.toFixed(2) : '-'}</td>
                        <td style="text-align: right;">${txn.balance_amount ? txn.balance_amount.toFixed(2) : '-'}</td>
                        <td style="text-align: center;">
                            <input type="checkbox" 
                                   class="form-check-input txn-checkbox" 
                                   data-index="${index}" 
                                   ${checked}>
                            ${dupLabel}
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            previewDiv.innerHTML = summaryHtml + tableHtml;
        }
        
        async function confirmSave() {
            const checkboxes = document.querySelectorAll('.txn-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one transaction to save');
                return;
            }
            
            const selectedTransactions = [];
            let debugInfo = 'SELECTED TRANSACTIONS:\n\n';
            
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                if (uploadedTransactions[index]) {
                    const txn = uploadedTransactions[index];
                    selectedTransactions.push(txn);
                    
                    debugInfo += `Index ${index}:\n`;
                    debugInfo += `  Date: ${txn.txn_date}\n`;
                    debugInfo += `  Description: ${txn.description.substring(0, 50)}...\n`;
                    debugInfo += `  Credit: ${txn.credit_amount}\n`;
                    debugInfo += `  Debit: ${txn.debit_amount}\n\n`;
                }
            });
            
            console.log(debugInfo);
            console.log('Full transaction objects:', selectedTransactions);
            
            const proceed = confirm(`You are about to save ${selectedTransactions.length} transaction(s).\n\nCheck console (F12) for details.\n\nProceed?`);
            if (!proceed) return;
            
            const bankId = document.getElementById('upload_bank_id').value;
            document.getElementById('btnConfirmUpload').disabled = true;
            document.getElementById('btnConfirmUpload').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            try {
                const response = await fetch('/reports-bank-recon/save-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bank_id: bankId,
                        transactions: selectedTransactions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message + '. Refreshing page...');
                    location.reload();
                } else {
                    alert(`Error: ${data.error}`);
                    document.getElementById('btnConfirmUpload').disabled = false;
                    document.getElementById('btnConfirmUpload').innerHTML = '<i class="bi bi-save me-1"></i> Confirm & Save';
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save transactions');
                document.getElementById('btnConfirmUpload').disabled = false;
                document.getElementById('btnConfirmUpload').innerHTML = '<i class="bi bi-save me-1"></i> Confirm & Save';
            }
        }
        
        async function showAddEntryModal(date, description, credit, debit) {
            const dateParts = date.split('-');
            const formattedDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; // '2025-12-06'
            document.getElementById('modal_trans_date').value = formattedDate;
            document.getElementById('modal_description').value = description;
            document.getElementById('modal_debit_amount').value = debit > 0 ? debit.toFixed(2) : '0.00';
            document.getElementById('modal_credit_amount').value = credit > 0 ? credit.toFixed(2) : '0.00';
            document.getElementById('modal_remarks').value = description;
            
            const entryType = credit > 0 ? 'CREDIT' : 'DEBIT';
            const bankId = document.getElementById('modal_bank_id').value;
            
            if (bankId) {
                await loadFilteredLedgers(bankId, entryType);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addEntryModal'));
            modal.show();
        }

        async function loadFilteredLedgers(bankId, entryType) {
            const ledgerSelect = document.getElementById('modal_ledger_name');
            ledgerSelect.innerHTML = '<option value="">Loading...</option>';
            ledgerSelect.disabled = true;
            
            try {
                const response = await fetch(`/bank-statement/ledgers?bank_id=${bankId}`);
                const data = await response.json();
                
                if (data.success) {
                    ledgerSelect.innerHTML = '<option value="">Select Ledger</option>';
                    
                    data.ledgers.forEach(ledger => {
                        const allowedType = ledger.allowed_entry_type;
                        
                        if (allowedType === 'BOTH' || allowedType === entryType) {
                            const option = document.createElement('option');
                            option.value = ledger.ledger_name;
                            option.textContent = ledger.ledger_display_name;
                            option.setAttribute('data-entry-type', ledger.allowed_entry_type);
                            option.setAttribute('data-external-id', ledger.external_id || '');
                            option.setAttribute('data-source-type', ledger.source_type || '');
                            ledgerSelect.appendChild(option);
                        }
                    });
                    
                    ledgerSelect.disabled = false;
                    
                    if (ledgerSelect.options.length === 1) {
                        ledgerSelect.innerHTML = '<option value="">No matching ledgers found</option>';
                        alert(`No ledgers available for ${entryType} entries. Please configure ledgers in the system.`);
                    }
                } else {
                    ledgerSelect.innerHTML = '<option value="">Error loading ledgers</option>';
                    alert('Error loading ledgers');
                }
            } catch (error) {
                console.error('Error loading ledgers:', error);
                ledgerSelect.innerHTML = '<option value="">Error loading ledgers</option>';
                alert('Failed to load ledgers');
            }
        }

        async function saveNewEntry() {
            const form = document.getElementById('addEntryForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const ledgerSelect = document.getElementById('modal_ledger_name');
            const selectedOption = ledgerSelect.options[ledgerSelect.selectedIndex];
            
            const transactionData = {
                trans_date: document.getElementById('modal_trans_date').value,
                bank_id: document.getElementById('modal_bank_id').value,
                ledger_name: document.getElementById('modal_ledger_name').value,
                credit_amount: parseFloat(document.getElementById('modal_credit_amount').value) || 0,
                debit_amount: parseFloat(document.getElementById('modal_debit_amount').value) || 0,
                remarks: document.getElementById('modal_remarks').value || '',
                external_id: selectedOption.getAttribute('data-external-id'),
                external_source: selectedOption.getAttribute('data-source-type')
            };
            
            const saveBtn = document.getElementById('btnSaveEntry');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            try {
                const response = await fetch('/reports-bank-recon/add-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Entry added successfully! Refreshing page...');
                    location.reload();
                } else {
                    alert(`Error: ${result.error}`);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Save Entry';
                }
            } catch (error) {
                console.error('Error saving entry:', error);
                alert('Failed to save entry');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Save Entry';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            const btnDelete = document.getElementById('btnConfirmDelete');
            if (btnDelete) {
                btnDelete.addEventListener('click', async function() {
                    if (!currentTxnId) return;
                    
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
                    
                    try {
                        const response = await fetch(`/reports-bank-recon/delete/${currentTxnId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Transaction deleted successfully. Refreshing page...');
                            location.reload();
                        } else {
                            alert(`Error: ${data.error}`);
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-trash me-1"></i> Confirm Delete';
                        }
                    } catch (error) {
                        console.error('Error deleting:', error);
                        alert('Failed to delete transaction.');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-trash me-1"></i> Confirm Delete';
                    }
                });
            }
            
            const impactModal = document.getElementById('impactModal');
            if (impactModal) {
                impactModal.addEventListener('hidden.bs.modal', function () {
                    currentTxnId = null;
                    document.getElementById('btnConfirmDelete').disabled = true;
                });
            }
            
            const modalElement = document.getElementById('impactModal');
            const cancelButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"]');
            cancelButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                });
            });
        });

    .container-fluid.p-3
        .card.mb-3.shadow-sm
            .card-body
                form#bankReconForm(method='POST' action='/reports-bank-recon')
                    input(type='hidden' name='caller' value='notpdf')
                    .row.g-3.align-items-end
                        .col-md-2
                            label.form-label Date Range:
                            select#dateRange.form-control(onchange='updateDateRangev1()')
                                option(value='this_month') This Month
                                option(value='last_month') Last Month
                                option(value='custom' selected) Custom
                        .col-md-2
                            label.form-label From Date:
                            input#fromclosingDate.form-control(type='date', name='fromClosingDate', value=fromClosingDate, max=currentDate, required)
                        .col-md-2
                            label.form-label To Date:
                            input#toclosingDate.form-control(type='date', name='toClosingDate', value=toClosingDate, max=currentDate, required)
                        .col-md-3
                            label.form-label Bank Account:
                            select#bank_id.form-control(name='bank_id' required)
                                if banks
                                    each val in banks
                                        option(value=`${val.bank_id}`, selected=bank_id == val.bank_id ? true : undefined)= `${val.bank_name} - ${val.account_nickname}`
                        .col-md-2
                            label.form-label Search:
                            input#searchInput.form-control(type='text', placeholder='Search...', oninput='liveSearch()')
                        .col-md-1
                            label.form-label &nbsp;
                            button.btn.btn-primary.w-100(type='submit')
                                i.bi.bi-search.me-1
                                | Load

    .container-fluid.px-3
        if systemTransactions !== undefined && bankTransactions !== undefined
            - var bankName = selectedBank ? `${selectedBank.bank_name} - ${selectedBank.account_nickname}` : 'Bank'
            
            h4.text-center.mb-1 Bank Reconciliation Report
            h5.text-center.text-primary= bankName
            p.text-center.text-muted
                i.bi.bi-calendar-range.me-2
                = `${formattedFromDate} to ${formattedToDate}`

            if summaryTotals
                .row.mb-4
                    .col-md-6
                        .card.border-primary.shadow-sm
                            .card-body
                                h6.mb-3.text-primary
                                    i.bi.bi-laptop.me-2
                                    | System (PetroMath)
                                .row.text-center
                                    .col-4
                                        strong Transactions
                                        h5.mb-0= summaryTotals.system_count
                                        - var txnDiff = summaryTotals.system_count - summaryTotals.bank_count
                                        if txnDiff > 0
                                            small.text-danger +#{txnDiff} excess
                                        else if txnDiff < 0
                                            small.text-warning #{txnDiff} missing
                                    .col-4
                                        strong Credit
                                        h5.mb-0.text-success ₹#{summaryTotals.system_credit.toFixed(2)}
                                        - var creditDiff = summaryTotals.system_credit - summaryTotals.bank_credit
                                        if creditDiff > 0
                                            small.text-danger +#{creditDiff.toFixed(2)}
                                        else if creditDiff < 0
                                            small.text-warning #{creditDiff.toFixed(2)}
                                    .col-4
                                        strong Debit
                                        h5.mb-0.text-danger ₹#{summaryTotals.system_debit.toFixed(2)}
                                        - var debitDiff = summaryTotals.system_debit - summaryTotals.bank_debit
                                        if debitDiff > 0
                                            small.text-danger +#{debitDiff.toFixed(2)}
                                        else if debitDiff < 0
                                            small.text-warning #{debitDiff.toFixed(2)}
                    .col-md-6
                        .card.border-warning.shadow-sm
                            .card-body
                                h6.mb-3.text-warning
                                    i.bi.bi-bank.me-2
                                    | Bank Statement
                                .row.text-center
                                    .col-4
                                        strong Transactions
                                        h5.mb-0= summaryTotals.bank_count
                                    .col-4
                                        strong Credit
                                        h5.mb-0.text-success ₹#{summaryTotals.bank_credit.toFixed(2)}
                                    .col-4
                                        strong Debit
                                        h5.mb-0.text-danger ₹#{summaryTotals.bank_debit.toFixed(2)}

            .row.mb-3
                .col-12.text-center
                    .btn-group(role='group')
                        button#btn-show-all.btn.btn-outline-primary.active(type='button' onclick='showAllTransactions()')
                            i.bi.bi-list-ul.me-2
                            | Show All Transactions
                        button#btn-show-unmatched.btn.btn-outline-warning(type='button' onclick='showUnmatchedOnly()')
                            i.bi.bi-exclamation-triangle.me-2
                            | Show Only Unmatched
                        button#btn-sync-scroll.btn.btn-outline-secondary(type='button' onclick='toggleSyncScroll()')
                            i.bi.bi-arrow-down-up.me-2
                            | Sync Scroll

            .row
                .col-md-6
                    .card.shadow-sm
                        .card-header.bg-primary-pastel
                            i.bi.bi-laptop.me-2
                            strong System Transactions (PetroMath)
                        .card-body.p-0
                            .table-responsive
                                table#system-table.table.table-sm.table-hover.system-table.mb-0
                                    thead.sticky-top
                                        tr
                                            th Date
                                            th Remarks
                                            th.text-end Credit
                                            th.text-end Debit
                                            th.text-center Receipts
                                    tbody
                                        each txn in systemTransactions
                                            tr(class=txn.isUnmatched ? 'unmatched-row' : '' 
                                               style='cursor: pointer;'
                                               onclick=`showImpactAnalysis(${txn.t_bank_id})`
                                               data-txn-id=txn.t_bank_id
                                               data-date=txn.trans_date
                                               data-remarks=txn.remarks
                                               data-credit=txn.credit_amount
                                               data-debit=txn.debit_amount)
                                                td
                                                    = txn.trans_date
                                                    if txn.isNearMatch
                                                        br
                                                        small.text-warning
                                                            i.bi.bi-exclamation-triangle-fill(
                                                                title=`Date mismatch: System=${txn.trans_date}, Bank=${txn.bankDate} (±${txn.dateOffBy} day)`
                                                                style="cursor: help;"
                                                            )
                                                            |  ±#{txn.dateOffBy}d
                                                td.truncate-text(title=txn.remarks)= txn.remarks || '-'
                                                td.text-end
                                                    if txn.credit_amount > 0
                                                        = txn.credit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-end
                                                    if txn.debit_amount > 0
                                                        = txn.debit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-center
                                                    if txn.receipt_count > 0
                                                        span.badge.bg-info= txn.receipt_count
                                                    else
                                                        | -
                                        if systemTransactions.length === 0
                                            tr
                                                td.text-center.text-muted(colspan='5') No transactions found

                .col-md-6
                    .card.shadow-sm
                        .card-header.bg-warning-pastel
                            i.bi.bi-bank.me-2
                            strong Bank Statement Transactions
                        .card-body.p-0
                            .table-responsive
                                table#bank-table.table.table-sm.table-hover.bank-table.mb-0
                                    thead.sticky-top
                                        tr
                                            th Date
                                            th Description
                                            th.text-end Credit
                                            th.text-end Debit
                                            th.text-center Action
                                    tbody
                                        each txn in bankTransactions
                                            tr(class=txn.isUnmatched ? 'unmatched-row' : '')
                                                td= txn.txn_date
                                                td.truncate-text(title=txn.description)= txn.description || '-'
                                                td.text-end
                                                    if txn.credit_amount > 0
                                                        = txn.credit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-end
                                                    if txn.debit_amount > 0
                                                        = txn.debit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-center
                                                    if txn.isUnmatched
                                                        button.btn.btn-sm.btn-success(
                                                            type='button'
                                                            onclick=`showAddEntryModal('${txn.txn_date}', '${txn.description.replace(/'/g, "\\'")}', ${txn.credit_amount}, ${txn.debit_amount})`
                                                            title='Add entry to PetroMath'
                                                        )
                                                            i.bi.bi-plus-circle
                                        if bankTransactions.length === 0
                                            tr
                                                td.text-center.text-muted(colspan='5') No transactions found
        else
            .alert.alert-info.text-center.mt-5(role='alert')
                i.bi.bi-info-circle.me-2
                | Select a bank and date range, then click "Load" to view the reconciliation report.

    #uploadModal.modal.fade(tabindex='-1' aria-labelledby='uploadModalLabel' aria-hidden='true')
        .modal-dialog.modal-xl
            .modal-content
                .modal-header.bg-success.text-white
                    h5#uploadModalLabel.modal-title
                        i.bi.bi-upload.me-2
                        | Upload Bank Statement
                    button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
                .modal-body
                    #uploadStep1
                        .row
                            .col-md-6
                                label.form-label Select Bank:
                                select#upload_bank_id.form-control(required)
                                    if banks
                                        each val in banks
                                            option(value=`${val.bank_id}`)= `${val.bank_name} - ${val.account_nickname}`
                            .col-md-6
                                label.form-label Select Excel File:
                                input#bankStatementFile.form-control(type='file' accept='.xlsx,.xls' required)
                        .row.mt-3
                            .col-12
                                button.btn.btn-primary(type='button' onclick='uploadAndPreview()')
                                    i.bi.bi-eye.me-1
                                    | Upload & Preview
                    
                    #uploadStep2(style='display: none;')
                        #previewContent
                            .text-center.p-4
                                .spinner-border.text-primary(role='status')
                                p.mt-2 Processing file...
                .modal-footer
                    button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close
                    button#btnConfirmUpload.btn.btn-success(type='button' style='display: none;' onclick='confirmSave()')
                        i.bi.bi-save.me-1
                        | Confirm & Save

    #impactModal.modal.fade(tabindex='-1' aria-labelledby='impactModalLabel' aria-hidden='true')
        .modal-dialog.modal-lg
            .modal-content
                .modal-header.bg-danger.text-white
                    h5#impactModalLabel.modal-title
                        i.bi.bi-exclamation-triangle.me-2
                        | Delete Transaction - Impact Analysis
                    button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
                .modal-body
                    #impactContent
                        .text-center.p-4
                            .spinner-border.text-primary(role='status')
                            p.mt-2 Loading impact analysis...
                .modal-footer
                    button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
                    button#btnConfirmDelete.btn.btn-danger(type='button' disabled)
                        i.bi.bi-trash.me-1
                        | Confirm Delete

    #addEntryModal.modal.fade(tabindex='-1' aria-labelledby='addEntryModalLabel' aria-hidden='true')
        .modal-dialog.modal-lg
            .modal-content
                .modal-header.bg-success.text-white
                    h5#addEntryModalLabel.modal-title
                        i.bi.bi-plus-circle.me-2
                        | Add Entry to PetroMath
                    button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
                .modal-body
                    form#addEntryForm
                        .row.g-3
                            .col-md-6
                                label.form-label Transaction Date
                                input#modal_trans_date.form-control(type='date' required readonly)
                            .col-md-6
                                label.form-label Bank Account
                                select#modal_bank_id.form-control(required disabled)
                                    if selectedBank
                                        option(value=selectedBank.bank_id selected)= `${selectedBank.bank_name} - ${selectedBank.account_nickname}`
                            .col-md-12
                                label.form-label Description (from Bank)
                                input#modal_description.form-control(type='text' readonly)
                            .col-md-12
                                label.form-label Ledger
                                    span.text-danger  *
                                select#modal_ledger_name.form-control(required)
                                    option(value='') Select Ledger
                            .col-md-6
                                label.form-label Debit Amount
                                input#modal_debit_amount.form-control(type='number' step='0.01' min='0' readonly)
                            .col-md-6
                                label.form-label Credit Amount
                                input#modal_credit_amount.form-control(type='number' step='0.01' min='0' readonly)
                            .col-md-12
                                label.form-label Remarks
                                input#modal_remarks.form-control(type='text' maxlength='1000' placeholder='Optional remarks...')
                .modal-footer
                    button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
                    button#btnSaveEntry.btn.btn-success(type='button' onclick='saveNewEntry()')
                        i.bi.bi-save.me-1
                        | Save Entry
