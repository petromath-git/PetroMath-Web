extends layout

block content
    style.
        .system-table th {
            background-color: #e3f2fd !important;
        }
        .bank-table th {
            background-color: #fff3e0 !important;
        }
        .table-responsive {
            max-height: 65vh;
            overflow-y: auto;
        }
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .unmatched-row {
            background-color: #fff3cd !important;
            border-left: 3px solid #ffc107 !important;
        }
        .unmatched-row:hover {
            background-color: #ffe69c !important;
        }
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        .card-header.bg-primary-pastel {
            background: linear-gradient(135deg, #b3d9ff 0%, #cce5ff 100%) !important;
            color: #004085 !important;
        }
        .card-header.bg-warning-pastel {
            background: linear-gradient(135deg, #ffe6b3 0%, #fff2d9 100%) !important;
            color: #856404 !important;
        }
        .btn-group .btn {
            margin-right: 10px;
        }
        .btn-group .btn:last-child {
            margin-right: 0;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            font-weight: 600;
        }
        
    script.
        const currentDate = new Date().toISOString().split('T')[0];

        function updateDateRangev1() {
            const rangeSelect = document.getElementById('dateRange');
            const selectedRange = rangeSelect.value;
            const today = new Date();
            let fromDate, toDate;

            if (selectedRange === 'this_month') {
                fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            } else if (selectedRange === 'last_month') {
                fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                toDate = new Date(today.getFullYear(), today.getMonth(), 0);
            } else {
                return;
            }

            document.getElementById('fromclosingDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('toclosingDate').value = toDate.toISOString().split('T')[0];
        }

        function liveSearch() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toUpperCase();
            
            const systemRows = document.querySelectorAll('#system-table tbody tr');
            systemRows.forEach(row => {
                const txtValue = row.textContent || row.innerText;
                row.style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
            });
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr');
            bankRows.forEach(row => {
                const txtValue = row.textContent || row.innerText;
                row.style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
            });
        }
        
        function showAllTransactions() {
            const systemRows = document.querySelectorAll('#system-table tbody tr');
            systemRows.forEach(row => row.style.display = '');
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr');
            bankRows.forEach(row => row.style.display = '');
            
            document.getElementById('btn-show-all').classList.add('active');
            document.getElementById('btn-show-unmatched').classList.remove('active');
        }
        
        function showUnmatchedOnly() {
            const systemRows = document.querySelectorAll('#system-table tbody tr.unmatched-row');
            const allSystemRows = document.querySelectorAll('#system-table tbody tr');
            allSystemRows.forEach(row => {
                row.style.display = row.classList.contains('unmatched-row') ? '' : 'none';
            });
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr.unmatched-row');
            const allBankRows = document.querySelectorAll('#bank-table tbody tr');
            allBankRows.forEach(row => {
                row.style.display = row.classList.contains('unmatched-row') ? '' : 'none';
            });
            
            document.getElementById('btn-show-all').classList.remove('active');
            document.getElementById('btn-show-unmatched').classList.add('active');
        }
        
        let syncScrollEnabled = false;
        let isScrolling = false;
        
        function toggleSyncScroll() {
            syncScrollEnabled = !syncScrollEnabled;
            const btn = document.getElementById('btn-sync-scroll');
            
            if (syncScrollEnabled) {
                btn.classList.add('active');
                btn.classList.remove('btn-outline-secondary');
                btn.classList.add('btn-success');
                
                const systemScroll = document.querySelector('#system-table').closest('.table-responsive');
                const bankScroll = document.querySelector('#bank-table').closest('.table-responsive');
                
                systemScroll.addEventListener('scroll', syncSystemToBankScroll);
                bankScroll.addEventListener('scroll', syncBankToSystemScroll);
            } else {
                btn.classList.remove('active');
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-secondary');
                
                const systemScroll = document.querySelector('#system-table').closest('.table-responsive');
                const bankScroll = document.querySelector('#bank-table').closest('.table-responsive');
                
                systemScroll.removeEventListener('scroll', syncSystemToBankScroll);
                bankScroll.removeEventListener('scroll', syncBankToSystemScroll);
            }
        }
        
        function syncSystemToBankScroll(e) {
            if (isScrolling) return;
            isScrolling = true;
            
            const bankScroll = document.querySelector('#bank-table').closest('.table-responsive');
            bankScroll.scrollTop = e.target.scrollTop;
            
            setTimeout(() => { isScrolling = false; }, 50);
        }
        
        function syncBankToSystemScroll(e) {
            if (isScrolling) return;
            isScrolling = true;
            
            const systemScroll = document.querySelector('#system-table').closest('.table-responsive');
            systemScroll.scrollTop = e.target.scrollTop;
            
            setTimeout(() => { isScrolling = false; }, 50);
        }
        
        let currentTxnId = null;
        
        async function showImpactAnalysis(txnId) {
            currentTxnId = txnId;
            
            const modal = new bootstrap.Modal(document.getElementById('impactModal'));
            modal.show();
            
            document.getElementById('impactContent').innerHTML = `
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading impact analysis...</p>
                </div>
            `;
            document.getElementById('btnConfirmDelete').disabled = true;
            
            try {
                const response = await fetch(`/reports-bank-recon/impact/${txnId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayImpact(data.impact);
                    document.getElementById('btnConfirmDelete').disabled = false;
                } else {
                    document.getElementById('impactContent').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-x-circle me-2"></i>
                            Error: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching impact:', error);
                document.getElementById('impactContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-x-circle me-2"></i>
                        Failed to load impact analysis.
                    </div>
                `;
            }
        }
        
        function displayImpact(impact) {
            let html = `
                <div class="mb-3">
                    <h6 class="text-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        This will DELETE the following:
                    </h6>
                </div>
                
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <strong>Transaction Details</strong>
                    </div>
                    <div class="card-body">
                        <p><strong>Date:</strong> ${impact.transaction.trans_date}</p>
                        <p><strong>Remarks:</strong> ${impact.transaction.remarks || '-'}</p>
                        <p><strong>Amount:</strong> 
                            ${impact.transaction.credit_amount > 0 ? 
                                ` ₹${parseFloat(impact.transaction.credit_amount).toFixed(2)} (Credit)` : 
                                `₹${parseFloat(impact.transaction.debit_amount).toFixed(2)} (Debit)`}
                        </p>
                    </div>
                </div>
            `;
            
            if (impact.receipts && impact.receipts.length > 0) {
                html += `
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-receipt me-2"></i>${impact.receipts.length} Receipt(s) will be DELETED:</strong>
                        <ul class="mt-2 mb-0">
                `;
                impact.receipts.forEach(r => {
                    html += `<li>Receipt #${r.receipt_no || r.treceipt_id} - ₹${parseFloat(r.amount).toFixed(2)}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (impact.reconRecords && impact.reconRecords.length > 0) {
                html += `
                    <div class="alert alert-info">
                        <strong><i class="bi bi-link-45deg me-2"></i>${impact.reconRecords.length} Digital Reconciliation(s) will be CLEARED:</strong>
                        <ul class="mt-2 mb-0">
                `;
                impact.reconRecords.forEach(r => {
                    html += `<li>${r.source_table} (ID: ${r.source_id})</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (!impact.receipts || impact.receipts.length === 0) {
                html += `
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle me-2"></i>
                        No receipts linked. Safe to delete.
                    </div>
                `;
            }
            
            document.getElementById('impactContent').innerHTML = html;
        }
        
        // UPLOAD TAB FUNCTIONS
        let uploadedTransactions = [];
        
        async function uploadAndPreview() {
            const fileInput = document.getElementById('bankStatementFile');
            const bankId = document.getElementById('upload_bank_id').value;
            
            if (!fileInput.files[0]) {
                alert('Please select a file');
                return;
            }
            
            if (!bankId) {
                alert('Please select a bank');
                return;
            }
            
            const formData = new FormData();
            formData.append('bankStatement', fileInput.files[0]);
            formData.append('bank_id', bankId);
            
            // Show loading state
            document.getElementById('uploadStep1').style.display = 'none';
            document.getElementById('uploadStep2').style.display = 'block';
            document.getElementById('previewContent').innerHTML = `
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Processing file...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/reports-bank-recon/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    uploadedTransactions = data.transactions;
                    displayPreview(data);
                    document.getElementById('btnConfirmUpload').style.display = 'block';
                } else {
                    document.getElementById('previewContent').innerHTML = `
                        <div class="alert alert-danger m-3">
                            <i class="bi bi-x-circle me-2"></i>
                            Error: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Upload error:', error);
                document.getElementById('previewContent').innerHTML = `
                    <div class="alert alert-danger m-3">
                        <i class="bi bi-x-circle me-2"></i>
                        Failed to process file.
                    </div>
                `;
            }
        }
        
        function displayPreview(data) {
            const previewDiv = document.getElementById('previewContent');
            
            let summaryHtml = `
                <div class="alert alert-info m-3 mb-0">
                    <strong><i class="bi bi-file-earmark-spreadsheet me-2"></i>Preview: ${data.summary.total} transactions found</strong>
                    ${data.summary.duplicates > 0 ? 
                        `<br><i class="bi bi-exclamation-triangle me-2 text-warning"></i>${data.summary.duplicates} duplicate(s) detected (will be skipped)` 
                        : ''}
                    ${data.summary.excluded_today > 0 ?
                        `<br><i class="bi bi-info-circle me-2 text-info"></i>${data.summary.excluded_today} transaction(s) from today excluded (only imports up to ${data.summary.yesterday_date})` 
                        : ''}
                </div>
            `;
            
            let tableHtml = `
                <div class="table-responsive" style="max-height: 60vh;">
                    <table class="table table-sm table-hover table-bordered mb-0">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
                            <tr>
                                <th style="width: 100px;">Date</th>
                                <th style="min-width: 250px;">Description</th>
                                <th style="width: 120px; text-align: right;">Credit</th>
                                <th style="width: 120px; text-align: right;">Debit</th>
                                <th style="width: 120px; text-align: right;">Balance</th>
                                <th style="width: 80px; text-align: center;">Include</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.transactions.forEach((txn, index) => {
                 const isDuplicate = txn.is_duplicate;
                
                const rowClass = isDuplicate ? 'table-warning' : '';
                const checked = isDuplicate ? '' : 'checked';
                const dupLabel = isDuplicate ? '<br><small class="text-warning">Dup?</small>' : '';
                
                tableHtml += `
                    <tr class="${rowClass}">
                        <td>${txn.txn_date}</td>
                        <td><div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${txn.description}">${txn.description}</div></td>
                        <td style="text-align: right;">${txn.credit_amount > 0 ? txn.credit_amount.toFixed(2) : '-'}</td>
                        <td style="text-align: right;">${txn.debit_amount > 0 ? txn.debit_amount.toFixed(2) : '-'}</td>
                        <td style="text-align: right;">${txn.balance_amount ? txn.balance_amount.toFixed(2) : '-'}</td>
                        <td style="text-align: center;">
                            ${isDuplicate ? 
                                `<span class="text-muted">-</span>
                                <br><span class="badge badge-warning">Already Uploaded</span>` : 
                                `<input type="checkbox" 
                                    class="form-check-input txn-checkbox" 
                                    data-index="${index}" 
                                    checked>`
                            }                                  
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            previewDiv.innerHTML = summaryHtml + tableHtml;

            const nonDuplicateCount = data.summary.total - data.summary.duplicates;
            if (nonDuplicateCount > 0) {
                document.getElementById('btnConfirmUploadRow').style.display = 'block';
            } else {
                document.getElementById('btnConfirmUploadRow').style.display = 'none';
            }
        }
        
        function resetUploadForm() {
            document.getElementById('uploadStep1').style.display = 'block';
            document.getElementById('uploadStep2').style.display = 'none';
            document.getElementById('btnConfirmUpload').style.display = 'none';
            document.getElementById('bankStatementFile').value = '';
            uploadedTransactions = [];
        }
        
        async function confirmSave() {
            const checkboxes = document.querySelectorAll('.txn-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one transaction to save');
                return;
            }
            
            const selectedTransactions = [];
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                if (uploadedTransactions[index]) {
                    selectedTransactions.push(uploadedTransactions[index]);
                }
            });
            
            const proceed = confirm(`You are about to save ${selectedTransactions.length} transaction(s). Proceed?`);
            if (!proceed) return;
            
            const bankId = document.getElementById('upload_bank_id').value;
            document.getElementById('btnConfirmUpload').disabled = true;
            document.getElementById('btnConfirmUpload').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            try {
                const response = await fetch('/reports-bank-recon/save-statement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        bank_id: bankId,
                        transactions: selectedTransactions
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message + '. Page will reload.');
                    location.reload();
                } else {
                    alert(`Error: ${data.error}`);
                    document.getElementById('btnConfirmUpload').disabled = false;
                    document.getElementById('btnConfirmUpload').innerHTML = '<i class="bi bi-save me-1"></i> Confirm & Save';
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save transactions');
                document.getElementById('btnConfirmUpload').disabled = false;
                document.getElementById('btnConfirmUpload').innerHTML = '<i class="bi bi-save me-1"></i> Confirm & Save';
            }
        }
        
        async function showAddEntryModal(date, description, credit, debit) {
                // Convert date from DD-MM-YYYY to YYYY-MM-DD for HTML date input
                const convertedDate = convertDateFormat(date);
                
                document.getElementById('modal_trans_date').value = convertedDate;
                document.getElementById('modal_description').value = description;
                document.getElementById('modal_debit_amount').value = debit > 0 ? debit.toFixed(2) : '0.00';
                document.getElementById('modal_credit_amount').value = credit > 0 ? credit.toFixed(2) : '0.00';
                document.getElementById('modal_remarks').value = description;
                
                const entryType = credit > 0 ? 'CREDIT' : 'DEBIT';
                const bankId = document.getElementById('modal_bank_id').value;
                
                if (bankId) {
                    await loadFilteredLedgers(bankId, entryType);
                }
                
                const modal = new bootstrap.Modal(document.getElementById('addEntryModal'));
                modal.show();
            }

            // ADD this helper function right AFTER showAddEntryModal:

            function convertDateFormat(dateStr) {
                // Convert DD-MM-YYYY to YYYY-MM-DD
                // Input: "02-01-2026" Output: "2026-01-02"
                
                if (!dateStr) return '';
                
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const day = parts[0];
                    const month = parts[1];
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
                
                return dateStr;
            }

        async function loadFilteredLedgers(bankId, entryType) {
            const ledgerSelect = document.getElementById('modal_ledger_name');
            ledgerSelect.innerHTML = '<option value="">Loading...</option>';
            ledgerSelect.disabled = true;
            
            try {
                const response = await fetch(`/bank-statement/ledgers?bank_id=${bankId}`);
                const data = await response.json();
                
                if (data.success) {
                    ledgerSelect.innerHTML = '<option value="">Select Ledger</option>';
                    
                    data.ledgers.forEach(ledger => {
                        const allowedType = ledger.allowed_entry_type;
                        
                        if (allowedType === 'BOTH' || allowedType === entryType) {
                            const option = document.createElement('option');
                            option.value = ledger.ledger_name;
                            option.textContent = ledger.ledger_display_name;
                            option.setAttribute('data-entry-type', ledger.allowed_entry_type);
                            option.setAttribute('data-external-id', ledger.external_id || '');
                            option.setAttribute('data-source-type', ledger.source_type || '');
                            ledgerSelect.appendChild(option);
                        }
                    });
                    
                    ledgerSelect.disabled = false;
                    
                    if (ledgerSelect.options.length === 1) {
                        ledgerSelect.innerHTML = '<option value="">No matching ledgers found</option>';
                        alert(`No ledgers available for ${entryType} entries. Please configure ledgers in the system.`);
                    }
                } else {
                    ledgerSelect.innerHTML = '<option value="">Error loading ledgers</option>';
                    alert('Error loading ledgers');
                }
            } catch (error) {
                console.error('Error loading ledgers:', error);
                ledgerSelect.innerHTML = '<option value="">Error loading ledgers</option>';
                alert('Failed to load ledgers');
            }
        }

        async function saveNewEntry() {
            const form = document.getElementById('addEntryForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const ledgerSelect = document.getElementById('modal_ledger_name');
            const selectedOption = ledgerSelect.options[ledgerSelect.selectedIndex];
            
            const transactionData = {
                trans_date: document.getElementById('modal_trans_date').value,
                bank_id: document.getElementById('modal_bank_id').value,
                ledger_name: document.getElementById('modal_ledger_name').value,
                credit_amount: parseFloat(document.getElementById('modal_credit_amount').value) || 0,
                debit_amount: parseFloat(document.getElementById('modal_debit_amount').value) || 0,
                remarks: document.getElementById('modal_remarks').value || '',
                external_id: selectedOption.getAttribute('data-external-id'),
                external_source: selectedOption.getAttribute('data-source-type')
            };
            
            const saveBtn = document.getElementById('btnSaveEntry');
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
            
            try {
                const response = await fetch('/reports-bank-recon/add-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transactionData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Entry added successfully! Refreshing page...');
                    // Remember to return to reconciliation tab after refresh
                    sessionStorage.setItem('activeTab', 'reconciliation');
                    location.reload();
                } else {
                    alert(`Error: ${result.error}`);
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Save Entry';
                }
            } catch (error) {
                console.error('Error saving entry:', error);
                alert('Failed to save entry');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-save me-1"></i> Save Entry';
            }
        }

        // UPLOAD HISTORY FUNCTIONS
        async function loadUploadHistory() {
            const bankId = document.getElementById('upload_bank_id').value;
            if (!bankId) {
                document.getElementById('uploadHistoryTable').innerHTML = `
                    <div class="alert alert-info text-center m-3">
                        <i class="bi bi-info-circle me-2"></i>
                        Select a bank account to view upload history
                    </div>
                `;
                return;
            }
            
            try {
                const response = await fetch(`/reports-bank-recon/upload-history?bank_id=${bankId}&limit=20`);
                const data = await response.json();
                
                if (data.success && data.history.length > 0) {
                    displayUploadHistory(data.history);
                } else {
                    document.getElementById('uploadHistoryTable').innerHTML = `
                        <div class="alert alert-info text-center m-3">
                            <i class="bi bi-info-circle me-2"></i>
                            No upload history found for this bank account.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading upload history:', error);
                document.getElementById('uploadHistoryTable').innerHTML = `
                    <div class="alert alert-danger text-center m-3">
                        <i class="bi bi-x-circle me-2"></i>
                        Error loading upload history
                    </div>
                `;
            }
        }

        function displayUploadHistory(history) {
            let html = `
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover table-bordered mb-0">
                        <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 5;">
                            <tr>
                                <th>Upload Date</th>
                                <th>File Name</th>
                                <th>First Date</th>
                                <th>Last Date</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Imported</th>
                                <th class="text-center">Duplicates</th>
                                <th>Uploaded By</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            history.forEach(h => {
                const statusBadge = h.status === 'COMPLETED' ? 'badge-success' : 
                                h.status === 'FAILED' ? 'badge-danger' : 'badge-warning';
                                
                html += `
                    <tr>
                        <td style="white-space: nowrap;">${h.upload_date}</td>
                        <td><small>${h.source_file}</small></td>
                        <td style="white-space: nowrap;">${h.first_txn_date || '-'}</td>
                        <td style="white-space: nowrap;">${h.last_txn_date || '-'}</td>
                        <td class="text-center">${h.total_transactions}</td>
                        <td class="text-center"><strong class="text-success">${h.transactions_imported}</strong></td>
                        <td class="text-center">${h.duplicates_found > 0 ? `<span class="text-warning">${h.duplicates_found}</span>` : '-'}</td>
                        <td><small>${h.uploaded_by}</small></td>
                        <td class="text-center"><span class="badge ${statusBadge}">${h.status}</span></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('uploadHistoryTable').innerHTML = html;
        }

        function rememberReconTab() {
            sessionStorage.setItem('activeTab', 'reconciliation');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // TAB PERSISTENCE - Check if we should return to reconciliation tab after refresh
            const returnToRecon = sessionStorage.getItem('activeTab');
            
            if (returnToRecon === 'reconciliation') {
                // Switch to reconciliation tab
                const reconTab = document.getElementById('reconciliation-tab');
                const uploadTab = document.getElementById('upload-tab');
                const reconPanel = document.getElementById('reconciliation-panel');
                const uploadPanel = document.getElementById('upload-panel');
                
                if (reconTab && uploadTab && reconPanel && uploadPanel) {
                    // Remove active from upload
                    uploadTab.classList.remove('active');
                    uploadPanel.classList.remove('show', 'active');
                    
                    // Add active to reconciliation
                    reconTab.classList.add('active');
                    reconPanel.classList.add('show', 'active');
                }
                
                // Clear the storage
                sessionStorage.removeItem('activeTab');
            }
            
            // EXISTING CODE - Delete button handler
            const btnDelete = document.getElementById('btnConfirmDelete');
            if (btnDelete) {
                btnDelete.addEventListener('click', async function() {
                    if (!currentTxnId) return;
                    
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
                    
                    try {
                        const response = await fetch(`/reports-bank-recon/delete/${currentTxnId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            alert('Transaction deleted successfully. Refreshing page...');
                            // ADDED: Remember to return to reconciliation tab
                            sessionStorage.setItem('activeTab', 'reconciliation');
                            location.reload();
                        } else {
                            alert(`Error: ${data.error}`);
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-trash me-1"></i> Confirm Delete';
                        }
                    } catch (error) {
                        console.error('Error deleting:', error);
                        alert('Failed to delete transaction.');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-trash me-1"></i> Confirm Delete';
                    }
                });
            }
            
            // EXISTING CODE - Impact modal handler
            const impactModal = document.getElementById('impactModal');
            if (impactModal) {
                impactModal.addEventListener('hidden.bs.modal', function () {
                    currentTxnId = null;
                    document.getElementById('btnConfirmDelete').disabled = true;
                });
            }

            // EXISTING CODE - Upload bank select handler
            const uploadBankSelect = document.getElementById('upload_bank_id');
            if (uploadBankSelect) {
                uploadBankSelect.addEventListener('change', function() {
                    loadUploadHistory();
                });
                // Load on page load if bank is already selected
                if (uploadBankSelect.value) {
                    loadUploadHistory();
                }
            }
        });

    .container-fluid.p-3
        // Tab Navigation
        ul.nav.nav-tabs.mb-3(role='tablist')
            li.nav-item(role='presentation')
                a#upload-tab.nav-link.active(data-toggle='tab' href='#upload-panel' role='tab') 
                    i.bi.bi-upload.me-2
                    | Upload Bank Statement
            li.nav-item(role='presentation')
                a#reconciliation-tab.nav-link(data-toggle='tab' href='#reconciliation-panel' role='tab')
                    i.bi.bi-clipboard-check.me-2
                    | Reconciliation Report
        
        // Tab Content
        .tab-content
            // ===== TAB 1: UPLOAD BANK STATEMENT =====
            #upload-panel.tab-pane.fade.show.active(role='tabpanel')
                .card.shadow-sm
                    .card-header.bg-success.text-white
                        h5.mb-0
                            i.bi.bi-upload.me-2
                            | Upload Bank Statement
                    .card-body
                        #uploadStep1
                            .row.g-3
                                .col-md-6
                                    label.form-label 
                                        | Select Bank:
                                        span.text-danger  *
                                    select#upload_bank_id.form-control(required)
                                        option(value='') Select Bank Account
                                        if banks
                                            each val in banks
                                                option(value=`${val.bank_id}`)= `${val.bank_name} - ${val.account_nickname}`
                                .col-md-6
                                    label.form-label 
                                        | Select Excel File:
                                        span.text-danger  *
                                    input#bankStatementFile.form-control(type='file' accept='.xlsx,.xls' required)
                                .col-12
                                    .alert.alert-info.mb-0
                                        i.bi.bi-info-circle.me-2
                                        | Upload your bank statement in Excel format (.xlsx or .xls). The system will automatically detect and preview transactions.
                            .row.mt-3
                                .col-12
                                    button.btn.btn-primary.btn-lg(type='button' onclick='uploadAndPreview()')
                                        i.bi.bi-eye.me-2
                                        | Upload & Preview
                        
                        #uploadStep2(style='display: none;')
                            .d-flex.justify-content-between.align-items-center.mb-3
                                h6.mb-0 Transaction Preview
                                button.btn.btn-secondary.btn-sm(type='button' onclick='resetUploadForm()')
                                    i.bi.bi-arrow-left.me-1
                                    | Back to Upload
                            #previewContent
                            .row.mt-3(style='display: none;' id='btnConfirmUploadRow')
                                .col-12.text-center
                                    button#btnConfirmUpload.btn.btn-success.btn-lg(type='button' onclick='confirmSave()')
                                        i.bi.bi-save.me-2
                                        | Confirm & Save Selected Transactions
                // Upload History Section
                .card.shadow-sm.mt-4
                    .card-header.bg-info.text-white
                        h6.mb-0
                            i.bi.bi-clock-history.me-2
                            | Upload History
                    .card-body.p-0
                        #uploadHistoryTable
                            .alert.alert-info.text-center.m-3
                                i.bi.bi-info-circle.me-2
                                | Select a bank account to view upload history            
            // ===== TAB 2: RECONCILIATION REPORT =====
            #reconciliation-panel.tab-pane.fade(role='tabpanel')
                .card.mb-3.shadow-sm
                    .card-body
                        form#bankReconForm(method='POST' action='/reports-bank-recon')
                            input(type='hidden' name='caller' value='notpdf')
                            .row.g-3.align-items-end
                                .col-md-2
                                    label.form-label Date Range:
                                    select#dateRange.form-control(onchange='updateDateRangev1()')
                                        option(value='this_month') This Month
                                        option(value='last_month') Last Month
                                        option(value='custom' selected) Custom
                                .col-md-2
                                    label.form-label From Date:
                                    input#fromclosingDate.form-control(type='date', name='fromClosingDate', value=fromClosingDate, max=currentDate, required)
                                .col-md-2
                                    label.form-label To Date:
                                    input#toclosingDate.form-control(type='date', name='toClosingDate', value=toClosingDate, max=currentDate, required)
                                .col-md-3
                                    label.form-label Bank Account:
                                    select#bank_id.form-control(name='bank_id' required)
                                        if banks
                                            each val in banks
                                                option(value=`${val.bank_id}`, selected=bank_id == val.bank_id ? true : undefined)= `${val.bank_name} - ${val.account_nickname}`
                                .col-md-2
                                    label.form-label Search:
                                    input#searchInput.form-control(type='text', placeholder='Search...', oninput='liveSearch()')
                                .col-md-1
                                    label.form-label &nbsp;
                                    button.btn.btn-primary.w-100(type='submit' onclick='rememberReconTab()')
                                        i.bi.bi-search.me-1
                                        | Load

                if systemTransactions !== undefined && bankTransactions !== undefined
                    - var bankName = selectedBank ? `${selectedBank.bank_name} - ${selectedBank.account_nickname}` : 'Bank'
                    
                    h4.text-center.mb-1 Bank Reconciliation Report
                    h5.text-center.text-primary= bankName
                    p.text-center.text-muted
                        i.bi.bi-calendar-range.me-2
                        = `${formattedFromDate} to ${formattedToDate}`

                    if summaryTotals
                        .row.mb-4
                            .col-md-6
                                .card.border-primary.shadow-sm
                                    .card-body
                                        h6.mb-3.text-primary
                                            i.bi.bi-laptop.me-2
                                            | System (PetroMath)
                                        .row.text-center
                                            .col-4
                                                strong Transactions
                                                h5.mb-0= summaryTotals.system_count
                                                - var txnDiff = summaryTotals.system_count - summaryTotals.bank_count
                                                if txnDiff > 0
                                                    small.text-danger +#{txnDiff} excess
                                                else if txnDiff < 0
                                                    small.text-warning #{txnDiff} missing
                                            .col-4
                                                strong Credit
                                                h5.mb-0.text-success ₹#{summaryTotals.system_credit.toFixed(2)}
                                                - var creditDiff = summaryTotals.system_credit - summaryTotals.bank_credit
                                                if creditDiff > 0
                                                    small.text-danger +#{creditDiff.toFixed(2)}
                                                else if creditDiff < 0
                                                    small.text-warning #{creditDiff.toFixed(2)}
                                            .col-4
                                                strong Debit
                                                h5.mb-0.text-danger ₹#{summaryTotals.system_debit.toFixed(2)}
                                                - var debitDiff = summaryTotals.system_debit - summaryTotals.bank_debit
                                                if debitDiff > 0
                                                    small.text-danger +#{debitDiff.toFixed(2)}
                                                else if debitDiff < 0
                                                    small.text-warning #{debitDiff.toFixed(2)}
                            .col-md-6
                                .card.border-warning.shadow-sm
                                    .card-body
                                        h6.mb-3.text-warning
                                            i.bi.bi-bank.me-2
                                            | Bank Statement
                                        .row.text-center
                                            .col-4
                                                strong Transactions
                                                h5.mb-0= summaryTotals.bank_count
                                            .col-4
                                                strong Credit
                                                h5.mb-0.text-success ₹#{summaryTotals.bank_credit.toFixed(2)}
                                            .col-4
                                                strong Debit
                                                h5.mb-0.text-danger ₹#{summaryTotals.bank_debit.toFixed(2)}

                    .row.mb-3
                        .col-12.text-center
                            .btn-group(role='group')
                                button#btn-show-all.btn.btn-outline-primary.active(type='button' onclick='showAllTransactions()')
                                    i.bi.bi-list-ul.me-2
                                    | Show All Transactions
                                button#btn-show-unmatched.btn.btn-outline-warning(type='button' onclick='showUnmatchedOnly()')
                                    i.bi.bi-exclamation-triangle.me-2
                                    | Show Only Unmatched
                                button#btn-sync-scroll.btn.btn-outline-secondary(type='button' onclick='toggleSyncScroll()')
                                    i.bi.bi-arrow-down-up.me-2
                                    | Sync Scroll

                    .row
                        .col-md-6
                            .card.shadow-sm
                                .card-header.bg-primary-pastel
                                    i.bi.bi-laptop.me-2
                                    strong System Transactions (PetroMath)
                                .card-body.p-0
                                    .table-responsive
                                        table#system-table.table.table-sm.table-hover.system-table.mb-0
                                            thead.sticky-top
                                                tr
                                                    th Date
                                                    th Remarks
                                                    th.text-end Credit
                                                    th.text-end Debit
                                                    th.text-center Receipts
                                            tbody
                                                each txn in systemTransactions
                                                    tr(class=txn.isUnmatched ? 'unmatched-row' : '' 
                                                       style='cursor: pointer;'
                                                       onclick=`showImpactAnalysis(${txn.t_bank_id})`)
                                                        td= txn.trans_date
                                                        td.truncate-text(title=txn.remarks)= txn.remarks || '-'
                                                        td.text-end
                                                            if txn.credit_amount > 0
                                                                = txn.credit_amount.toFixed(2)
                                                            else
                                                                | -
                                                        td.text-end
                                                            if txn.debit_amount > 0
                                                                = txn.debit_amount.toFixed(2)
                                                            else
                                                                | -
                                                        td.text-center
                                                            if txn.receipt_count > 0
                                                                span.badge.bg-info= txn.receipt_count
                                                            else
                                                                | -
                                                if systemTransactions.length === 0
                                                    tr
                                                        td.text-center.text-muted(colspan='5') No transactions found

                        .col-md-6
                            .card.shadow-sm
                                .card-header.bg-warning-pastel
                                    i.bi.bi-bank.me-2
                                    strong Bank Statement Transactions
                                .card-body.p-0
                                    .table-responsive
                                        table#bank-table.table.table-sm.table-hover.bank-table.mb-0
                                            thead.sticky-top
                                                tr
                                                    th Date
                                                    th Description
                                                    th.text-end Credit
                                                    th.text-end Debit
                                                    th.text-center Action
                                            tbody
                                                each txn in bankTransactions
                                                    tr(class=txn.isUnmatched ? 'unmatched-row' : '')
                                                        td= txn.txn_date
                                                        td.truncate-text(title=txn.description)= txn.description || '-'
                                                        td.text-end
                                                            if txn.credit_amount > 0
                                                                = txn.credit_amount.toFixed(2)
                                                            else
                                                                | -
                                                        td.text-end
                                                            if txn.debit_amount > 0
                                                                = txn.debit_amount.toFixed(2)
                                                            else
                                                                | -
                                                        td.text-center
                                                            if txn.isUnmatched
                                                                button.btn.btn-sm.btn-success(
                                                                    type='button'
                                                                    onclick=`showAddEntryModal('${txn.txn_date}', '${txn.description.replace(/'/g, "\\'")}', ${txn.credit_amount}, ${txn.debit_amount})`
                                                                    title='Add entry to PetroMath'
                                                                )
                                                                    i.bi.bi-plus-circle
                                                if bankTransactions.length === 0
                                                    tr
                                                        td.text-center.text-muted(colspan='5') No transactions found
                else
                    .alert.alert-info.text-center.mt-5(role='alert')
                        i.bi.bi-info-circle.me-2
                        | Select a bank and date range, then click "Load" to view the reconciliation report.

    // MODALS
    #impactModal.modal.fade(tabindex='-1' aria-labelledby='impactModalLabel' aria-hidden='true')
        .modal-dialog.modal-lg
            .modal-content
                .modal-header.bg-danger.text-white
                    h5#impactModalLabel.modal-title
                        i.bi.bi-exclamation-triangle.me-2
                        | Delete Transaction - Impact Analysis
                    button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
                .modal-body
                    #impactContent
                        .text-center.p-4
                            .spinner-border.text-primary(role='status')
                            p.mt-2 Loading impact analysis...
                .modal-footer
                    button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
                    button#btnConfirmDelete.btn.btn-danger(type='button' disabled)
                        i.bi.bi-trash.me-1
                        | Confirm Delete

    #addEntryModal.modal.fade(tabindex='-1' aria-labelledby='addEntryModalLabel' aria-hidden='true')
        .modal-dialog.modal-lg
            .modal-content
                .modal-header.bg-success.text-white
                    h5#addEntryModalLabel.modal-title
                        i.bi.bi-plus-circle.me-2
                        | Add Entry to PetroMath
                    button.btn-close.btn-close-white(type='button' data-bs-dismiss='modal' aria-label='Close')
                .modal-body
                    form#addEntryForm
                        .row.g-3
                            .col-md-6
                                label.form-label Transaction Date
                                input#modal_trans_date.form-control(type='date' required readonly)
                            .col-md-6
                                label.form-label Bank Account
                                select#modal_bank_id.form-control(required disabled)
                                    if selectedBank
                                        option(value=selectedBank.bank_id selected)= `${selectedBank.bank_name} - ${selectedBank.account_nickname}`
                            .col-md-12
                                label.form-label Description (from Bank)
                                input#modal_description.form-control(type='text' readonly)
                            .col-md-12
                                label.form-label Ledger
                                    span.text-danger  *
                                select#modal_ledger_name.form-control(required)
                                    option(value='') Select Ledger
                            .col-md-6
                                label.form-label Debit Amount
                                input#modal_debit_amount.form-control(type='number' step='0.01' min='0' readonly)
                            .col-md-6
                                label.form-label Credit Amount
                                input#modal_credit_amount.form-control(type='number' step='0.01' min='0' readonly)
                            .col-md-12
                                label.form-label Remarks
                                input#modal_remarks.form-control(type='text' maxlength='1000' placeholder='Optional remarks...')
                .modal-footer
                    button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
                    button#btnSaveEntry.btn.btn-success(type='button' onclick='saveNewEntry()')
                        i.bi.bi-save.me-1
                        | Save Entry
