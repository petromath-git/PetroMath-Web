extends layout

block content
    style.
        .system-table th {
            background-color: #e3f2fd !important;
        }
        .bank-table th {
            background-color: #fff3e0 !important;
        }
        .table-responsive {
            max-height: 65vh;
            overflow-y: auto;
        }
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .unmatched-row {
            background-color: #fff3cd !important;
            border-left: 3px solid #ffc107 !important;
        }
        .unmatched-row:hover {
            background-color: #ffe69c !important;
        }
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
        }
        
    script.
        const currentDate = new Date().toISOString().split('T')[0];

        function updateDateRangev1() {
            const rangeSelect = document.getElementById('dateRange');
            const selectedRange = rangeSelect.value;
            const today = new Date();
            let fromDate, toDate;

            if (selectedRange === 'this_month') {
                fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
                toDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            } else if (selectedRange === 'last_month') {
                fromDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                toDate = new Date(today.getFullYear(), today.getMonth(), 0);
            } else {
                return;
            }

            document.getElementById('fromclosingDate').value = fromDate.toISOString().split('T')[0];
            document.getElementById('toclosingDate').value = toDate.toISOString().split('T')[0];
        }

        function liveSearch() {
            const searchInput = document.getElementById('searchInput');
            const filter = searchInput.value.toUpperCase();
            
            const systemRows = document.querySelectorAll('#system-table tbody tr');
            systemRows.forEach(row => {
                const txtValue = row.textContent || row.innerText;
                row.style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
            });
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr');
            bankRows.forEach(row => {
                const txtValue = row.textContent || row.innerText;
                row.style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? '' : 'none';
            });
        }
        
        function showAllTransactions() {
            const systemRows = document.querySelectorAll('#system-table tbody tr');
            systemRows.forEach(row => row.style.display = '');
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr');
            bankRows.forEach(row => row.style.display = '');
            
            document.getElementById('btn-show-all').classList.add('active');
            document.getElementById('btn-show-unmatched').classList.remove('active');
        }
        
        function showUnmatchedOnly() {
            const systemRows = document.querySelectorAll('#system-table tbody tr.unmatched-row');
            const allSystemRows = document.querySelectorAll('#system-table tbody tr');
            allSystemRows.forEach(row => {
                row.style.display = row.classList.contains('unmatched-row') ? '' : 'none';
            });
            
            const bankRows = document.querySelectorAll('#bank-table tbody tr.unmatched-row');
            const allBankRows = document.querySelectorAll('#bank-table tbody tr');
            allBankRows.forEach(row => {
                row.style.display = row.classList.contains('unmatched-row') ? '' : 'none';
            });
            
            document.getElementById('btn-show-all').classList.remove('active');
            document.getElementById('btn-show-unmatched').classList.add('active');
        }

    .container-fluid.p-3
        .card.mb-3.shadow-sm
            .card-body
                form#bankReconForm(method='POST' action='/reports-bank-recon')
                    input(type='hidden' name='caller' value='notpdf')
                    .row.g-3.align-items-end
                        .col-md-2
                            label.form-label Date Range:
                            select#dateRange.form-control(onchange='updateDateRangev1()')
                                option(value='this_month') This Month
                                option(value='last_month') Last Month
                                option(value='custom' selected) Custom
                        .col-md-2
                            label.form-label From Date:
                            input#fromclosingDate.form-control(type='date', name='fromClosingDate', value=fromClosingDate, max=currentDate, required)
                        .col-md-2
                            label.form-label To Date:
                            input#toclosingDate.form-control(type='date', name='toClosingDate', value=toClosingDate, max=currentDate, required)
                        .col-md-3
                            label.form-label Bank Account:
                            select#bank_id.form-control(name='bank_id' required)
                                if banks
                                    each val in banks
                                        option(value=`${val.bank_id}`, selected=bank_id == val.bank_id ? true : undefined)= `${val.bank_name} - ${val.account_nickname}`
                        .col-md-2
                            label.form-label Search:
                            input#searchInput.form-control(type='text', placeholder='Search...', oninput='liveSearch()')
                        .col-md-1
                            label.form-label &nbsp;
                            button.btn.btn-primary.w-100(type='submit')
                                i.bi.bi-search.me-1
                                | Load

    .container-fluid.px-3
        if systemTransactions !== undefined && bankTransactions !== undefined
            - var bankName = selectedBank ? `${selectedBank.bank_name} - ${selectedBank.account_nickname}` : 'Bank'
            
            h4.text-center.mb-1 Bank Reconciliation Report
            h5.text-center.text-primary= bankName
            p.text-center.text-muted
                i.bi.bi-calendar-range.me-2
                = `${formattedFromDate} to ${formattedToDate}`

            // Summary Cards
            if summaryTotals
                .row.mb-4
                    .col-md-6
                        .card.border-primary.shadow-sm
                            .card-body
                                h6.mb-3.text-primary
                                    i.bi.bi-laptop.me-2
                                    | System (PetroMath)
                                .row.text-center
                                    .col-4
                                        strong Transactions
                                        h5.mb-0= summaryTotals.system_count
                                        - var txnDiff = summaryTotals.system_count - summaryTotals.bank_count
                                        if txnDiff > 0
                                            small.text-danger +#{txnDiff} excess
                                        else if txnDiff < 0
                                            small.text-warning #{txnDiff} missing
                                    .col-4
                                        strong Credit
                                        h5.mb-0.text-success ₹#{summaryTotals.system_credit.toFixed(2)}
                                        - var creditDiff = summaryTotals.system_credit - summaryTotals.bank_credit
                                        if creditDiff > 0
                                            small.text-danger +#{creditDiff.toFixed(2)}
                                        else if creditDiff < 0
                                            small.text-warning #{creditDiff.toFixed(2)}
                                    .col-4
                                        strong Debit
                                        h5.mb-0.text-danger ₹#{summaryTotals.system_debit.toFixed(2)}
                                        - var debitDiff = summaryTotals.system_debit - summaryTotals.bank_debit
                                        if debitDiff > 0
                                            small.text-danger +#{debitDiff.toFixed(2)}
                                        else if debitDiff < 0
                                            small.text-warning #{debitDiff.toFixed(2)}
                    .col-md-6
                        .card.border-warning.shadow-sm
                            .card-body
                                h6.mb-3.text-warning
                                    i.bi.bi-bank.me-2
                                    | Bank Statement
                                .row.text-center
                                    .col-4
                                        strong Transactions
                                        h5.mb-0= summaryTotals.bank_count
                                    .col-4
                                        strong Credit
                                        h5.mb-0.text-success ₹#{summaryTotals.bank_credit.toFixed(2)}
                                    .col-4
                                        strong Debit
                                        h5.mb-0.text-danger ₹#{summaryTotals.bank_debit.toFixed(2)}

            // Filter Buttons
            .row.mb-3
                .col-12.text-center
                    .btn-group(role='group')
                        button#btn-show-all.btn.btn-outline-primary.active(type='button' onclick='showAllTransactions()')
                            i.bi.bi-list-ul.me-2
                            | Show All Transactions
                        button#btn-show-unmatched.btn.btn-outline-warning(type='button' onclick='showUnmatchedOnly()')
                            i.bi.bi-exclamation-triangle.me-2
                            | Show Only Unmatched

            // Side-by-side Tables
            .row
                .col-md-6
                    .card.shadow-sm
                        .card-header.bg-primary.text-white
                            i.bi.bi-laptop.me-2
                            strong System Transactions (PetroMath)
                            span.badge.bg-light.text-primary.ms-2= systemTransactions.length
                        .card-body.p-0
                            .table-responsive
                                table#system-table.table.table-sm.table-hover.system-table.mb-0
                                    thead.sticky-top
                                        tr
                                            th Date
                                            th Remarks
                                            th.text-end Credit
                                            th.text-end Debit
                                            th.text-center Receipts
                                    tbody
                                        each txn in systemTransactions
                                            tr(class=txn.isUnmatched ? 'unmatched-row' : '')
                                                td= txn.trans_date
                                                td.truncate-text(title=txn.remarks)= txn.remarks || '-'
                                                td.text-end
                                                    if txn.credit_amount > 0
                                                        = txn.credit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-end
                                                    if txn.debit_amount > 0
                                                        = txn.debit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-center
                                                    if txn.receipt_count > 0
                                                        span.badge.bg-info= txn.receipt_count
                                                    else
                                                        | -
                                        if systemTransactions.length === 0
                                            tr
                                                td.text-center.text-muted(colspan='5') No transactions found

                .col-md-6
                    .card.shadow-sm
                        .card-header.bg-warning.text-dark
                            i.bi.bi-bank.me-2
                            strong Bank Statement Transactions
                            span.badge.bg-dark.ms-2= bankTransactions.length
                        .card-body.p-0
                            .table-responsive
                                table#bank-table.table.table-sm.table-hover.bank-table.mb-0
                                    thead.sticky-top
                                        tr
                                            th Date
                                            th Description
                                            th.text-end Credit
                                            th.text-end Debit
                                    tbody
                                        each txn in bankTransactions
                                            tr(class=txn.isUnmatched ? 'unmatched-row' : '')
                                                td= txn.txn_date
                                                td.truncate-text(title=txn.description)= txn.description || '-'
                                                td.text-end
                                                    if txn.credit_amount > 0
                                                        = txn.credit_amount.toFixed(2)
                                                    else
                                                        | -
                                                td.text-end
                                                    if txn.debit_amount > 0
                                                        = txn.debit_amount.toFixed(2)
                                                    else
                                                        | -
                                        if bankTransactions.length === 0
                                            tr
                                                td.text-center.text-muted(colspan='4') No transactions found
        else
            .alert.alert-info.text-center.mt-5(role='alert')
                i.bi.bi-info-circle.me-2
                | Select a bank and date range, then click "Load" to view the reconciliation report.
