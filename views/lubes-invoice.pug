extends layout
include mixins/mixins
include mixins/lubes-invoice-mixins

block content
    - const maxInvoiceRows = config.maxInvoiceRowsCnt || 10;
    - let divClass = "";
    if(invoiceStatus == 'CLOSED')
        - divClass = 'disabledInputs';
    
    form#lubesInvoiceForm(class=divClass)
        if !isNew
            input(type='hidden' id='lubes_hdr_id' name='lubes_hdr_id' value=invoice.lubes_hdr_id)
        
        div.card
            div.card-header.text-white.bg-dark
                h4 Purchase Invoice
            div.card-body
                div.row
                    div.col-md-3
                        div.form-group
                            label(for='invoice_number') Invoice Number
                            input#invoice_number.form-control(type='text' name='invoice_number' required
                                value=invoice ? invoice.invoice_number : '')
                    div.col-md-3
                        div.form-group
                            label(for='invoice_date') Invoice Date
                            input#invoice_date.form-control(type='date' name='invoice_date' required
                                value=invoice ? dateFormat(invoice.invoice_date, 'yyyy-mm-dd') : dateFormat(new Date(), 'yyyy-mm-dd'))
                    div.col-md-3
                        div.form-group
                            label(for='supplier_id') Supplier
                            select#supplier_id.form-control(name='supplier_id' required)
                                option(value='') Select Supplier
                                each supplier in suppliers
                                    option(value=supplier.supplier_id
                                        selected=invoice && invoice.supplier_id == supplier.supplier_id)= supplier.supplier_name
                    div.col-md-3
                        div.form-group
                            label(for='location_id') Location
                        input#location_id.form-control(
                            type='text' 
                            value=user.location_code 
                            readonly
                        )
                        input(
                            type='hidden' 
                            name='location_id' 
                            value=location_id
                        )
                        input#location_code(
                            type='hidden' 
                            name='location_code'
                            value=user.location_code
                        )
        
        div.card.mt-4
            div.card-header.text-white.bg-dark
                h4 Invoice Items
            div.card-body
                table.table.table-bordered#invoice-items-table
                    thead.bg-light
                        tr
                            th #
                            th Product
                            th Unit
                            th MRP
                            th Net Rate
                            th Quantity
                            th Amount
                            th Notes
                            th Action
                    tbody
                        - var rowCnt = 0
                        if invoiceLines && invoiceLines.length > 0
                            each line, index in invoiceLines
                                tr
                                    td= index + 1
                                    td
                                        select.form-control.product-select(
                                            name=`items[${index}][product_id]` 
                                            required
                                        )
                                            option(value='') Select Product
                                            each product in products
                                                option(
                                                    value=product.product_id,
                                                    'data-unit': product.unit,
                                                    selected=line.product_id == product.product_id
                                                )= product.product_name
                                    td.product-unit= line.Product ? line.Product.unit : ''
                                    td
                                        input.form-control.mrp(
                                            type='number'
                                            name=`items[${index}][mrp]`
                                            step='0.01'
                                            min='0'
                                            value=(line && line.mrp !== undefined) ? parseFloat(line.mrp).toFixed(2) : '0.00'
                                            required
                                        )
                                    td
                                        input.form-control.net-rate(
                                            type='number'
                                            name=`items[${index}][net_rate]`
                                            step='0.01'
                                            min='0'
                                            value=(line && line.net_rate !== undefined) ? parseFloat(line.net_rate).toFixed(2) : '0.00'
                                            required
                                        )
                                    td
                                        input.form-control.quantity(
                                            type='number' 
                                            name=`items[${index}][qty]` 
                                            step='0.01' 
                                            min='0.01' 
                                            value=line.qty 
                                            required
                                        )
                                    td
                                        input.form-control.amount(
                                            type='number' 
                                            name=`items[${index}][amount]` 
                                            value=(line && line.amount !== undefined) ? parseFloat(line.amount).toFixed(2) : '0.00' 
                                            readonly
                                        )
                                    td
                                        input.form-control.notes(
                                            type='text' 
                                            name=`items[${index}][notes]` 
                                            value=line.notes || ''
                                        )
                                    td
                                        button.btn.btn-danger.remove-row(type='button') Remove
                        else
                            tr
                                td 1
                                td
                                    select.form-control.product-select(name='items[0][product_id]' required)
                                        option(value='') Select Product
                                        each product in products
                                            option(
                                                value=product.product_id,
                                                'data-unit': product.unit
                                            )= product.product_name
                                td.product-unit
                                td
                                    input.form-control.mrp(
                                        type='number'
                                        name='items[0][mrp]'
                                        step='0.01'
                                        min='0'
                                        required
                                    )
                                td
                                    input.form-control.net-rate(
                                        type='number'
                                        name='items[0][net_rate]'
                                        step='0.01'
                                        min='0'
                                        required
                                    )
                                td
                                    input.form-control.quantity(
                                        type='number' 
                                        name='items[0][qty]' 
                                        step='0.01' 
                                        min='0.01' 
                                        required
                                    )
                                td
                                    input.form-control.amount(
                                        type='number' 
                                        name='items[0][amount]' 
                                        readonly
                                    )
                                td
                                    input.form-control.notes(
                                        type='text' 
                                        name='items[0][notes]'
                                    )
                                td
                                    button.btn.btn-danger.remove-row(type='button') Remove
                
                div.row.mt-3
                    div.col-md-4
                        if(invoiceStatus != 'CLOSED')
                            button#add-row-btn.btn.btn-secondary(type='button') Add Row
                    div.col-md-4
                        div.form-group
                            label(for='notes') Notes
                            textarea#notes.form-control(name='notes' rows='2')=invoice ? invoice.notes : ''
                    div.col-md-4
                        div.form-group
                            label.fw-bold Total Amount:
                            input#invoice_amount.form-control.fw-bold(
                                type='number' 
                                name='invoice_amount' 
                                readonly
                                value=(invoice && invoice.invoice_amount !== undefined) ? parseFloat(invoice.invoice_amount).toFixed(2) : '0.00'
                            )
        
        div.row.mt-4
            div.col-12.text-center
                if(invoiceStatus != 'CLOSED')
                    button.btn.btn-primary.me-2#save-btn(type='button') Save Invoice
                    button.btn.btn-dark#close-btn(type='button' disabled=true) Close Invoice
                a.btn.btn-secondary(href='/lubes-invoice-home') Back to List

    //- Embed data for JavaScript
    script.
        const products = !{JSON.stringify(products)};
        const userLocationCode = '#{user.location_code}';
        const userLocationId = '#{user.location_id}';

    //- Include lubes invoice specific JavaScript
    script(src=`/javascripts/lubes-invoice.js?v=${CACHE_BUST}`)