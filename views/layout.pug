doctype html
html
  head
    title PetroMath:#{title}
    - var mobileReadyPages = ['Shift Closing', 'Login', 'Select Location','Credit/Debit Adjustment Entry','Products','Tank Master','Create New Bill']
    if mobileReadyPages.includes(title)
      meta(name="viewport" content="width=device-width, initial-scale=1.0")   
    link(rel='stylesheet', href=`/stylesheets/style.css?v=${CACHE_BUST}`)        
    link(rel='stylesheet', href='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css')
    link(rel="stylesheet",href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css")
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.0/font/css/open-iconic-bootstrap.min.css')
    link(rel='stylesheet', href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css')  
    link(id="favicon" rel="shortcut icon" type="image/png" href=`/images/mc_logo.jpg?v=${CACHE_BUST}` src=`/images/mc_logo.jpg?v=${CACHE_BUST}`)
    link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.0/font/bootstrap-icons.min.css")
    script(src='https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment.min.js')
    script(src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js")        
    script(src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js')
    script(src='https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js')
    script(src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js')
    script(src=`/javascripts/app-validator.js?v=${CACHE_BUST}`)
    script(src=`/javascripts/app-scripts.js?v=${CACHE_BUST}`)
    script(src=`/javascripts/app-master-page-scripts.js?v=${CACHE_BUST}`)
    script(src=`/javascripts/draft-edit-scripts.js?v=${CACHE_BUST}`)
    script(src=`/javascripts/app-generate-pdf.js?v=${CACHE_BUST}`, defer)
    script(src=`/javascripts/app-report-date.js?v=${CACHE_BUST}`, defer)
    script(src=`/javascripts/app-report-table-generator.js?v=${CACHE_BUST}`)
    
    style.
      @media print {
        table.table-bordered {
          border-collapse: collapse !important;
        }
        table.table-bordered,
        table.table-bordered th,
        table.table-bordered td {
          border: 1px solid #000 !important;
        }
      }

  - var isFreezedRecord = false;
  if (closingData && closingData.closingStatus === 'CLOSED')
    - isFreezedRecord = true;

  body(onload='populateSummaryFn(' + isFreezedRecord +');')
    
    if user
      div#ajax-loading.d-sm-none
        img#loading-image(src=`/images/ajax-loader.gif?v=${CACHE_BUST}`, alt="Loading...", width="300px", height="300px")

      // Vertical Sidebar
      nav.sidebar#sidebar
        .sidebar-header
          a.sidebar-logo(href="/") PetroMath
          .sidebar-user
            | Logged in as #{user.Person_Name}
            br
            // Check if user has multiple location access
            if user.hasMultipleLocations
              // Make location clickable with switch icon
              a.location-switcher(href="/select-location", title="Click to switch location")
                i.bi.bi-geo-alt.me-1
                | Location: #{user.location_code}
                i.bi.bi-chevron-down.ms-1(style="font-size: 0.8rem;")
            else
              // Regular location display for single-location users
              span
                i.bi.bi-geo-alt.me-1
                | Location: #{user.location_code}
            if APP_VERSION === 'canary'
              br
              span(style='background-color: orange; color: white; font-size: 0.6rem; padding: 1px 3px; border-radius: 2px;') CANARY

        
        // Dynamic Menu Grouping Logic - Unified approach
        - var dropdownGroups = {}
        - var allGroups = {}

        // First pass: organize menus by parent/child
        each m in user.menuDetails
          if m.parent_code
            - dropdownGroups[m.parent_code] = dropdownGroups[m.parent_code] || []
            - dropdownGroups[m.parent_code].push(m)

        // Second pass: create unified group structure
        each m in user.menuDetails
          if !m.parent_code
            - var children = dropdownGroups[m.menu_code] || []
            if m.group_name && m.group_code
              if children.length === 0
                // Standalone menu group
                - allGroups[m.group_code] = allGroups[m.group_code] || { group_name: m.group_name, group_sequence: m.group_sequence, type: 'standalone', menus: [] }
                - allGroups[m.group_code].menus.push(m)
              else
                // Dropdown menu group
                - allGroups[m.group_code] = allGroups[m.group_code] || { group_name: m.group_name, group_sequence: m.group_sequence, type: 'dropdown', parent: m, children: children }
            else
              // Fallback to Administration if no group
              - allGroups['ADMIN'] = allGroups['ADMIN'] || { group_name: 'Administration', group_sequence: 999, type: 'standalone', menus: [] }
              - allGroups['ADMIN'].menus.push(m)

        // Convert to sorted array by group_sequence
        - var sortedGroups = Object.values(allGroups).sort((a, b) => parseInt(a.group_sequence || 999) - parseInt(b.group_sequence || 999))

        // Helper function for menu icons
        -
           function getMenuIcon(menuName, groupName) {
            // DAILY_OPS group icons
            if (menuName === 'Shift Closing') return 'bi-clock';
            if (menuName === 'Day Close') return 'bi-sunrise';
            if (menuName === 'Day-Close Report') return 'bi-file-earmark-text';
            
            // TRANSACTIONS group icons
            if (menuName === 'Credit Receipts') return 'bi-credit-card';
            if (menuName === 'Tank Receipts') return 'bi-receipt';
            if (menuName === 'Tank Dip Entry') return 'bi-rulers';
            if (menuName === 'Bank Transaction') return 'bi-bank';
            if (menuName === 'Purchase Invoice') return 'bi-file-earmark-text';
            if (menuName === 'Adjustment Entry') return 'bi-arrows-angle-contract';
            
            // REPORTS_SECTION group icons
            if (menuName === 'Reports') return 'bi-graph-up';
            if (menuName === 'Credit Ledger Account') return 'bi-journal-text';
            if (menuName === 'Credit Customer Detail Report') return 'bi-person-lines-fill';
            if (menuName === 'Digital Reconciliation Report') return 'bi-credit-card-2-front';
            if (menuName === 'Credit Customer Balance Report') return 'bi-calculator';
            if (menuName === 'GST Summary Report') return 'bi-receipt-cutoff';
            if (menuName === 'Sales Summary Report') return 'bi-bar-chart';
            if (menuName === 'Cashflow (Use for Agro Center)') return 'bi-cash-stack';
            if (menuName === 'Tally Daybook Report') return 'bi-journal-bookmark';
            if (menuName === 'Adjustment History') return 'bi-clock-history';
            
            // ADMIN group icons
            if (menuName === 'Deadline Manager') return 'bi-calendar-check';
            if (menuName === 'Select Location') return 'bi-geo-alt';
            if (menuName === 'Truck Management') return 'bi-truck';
            if (menuName === 'Truck Load') return 'bi-truck';
            if (menuName === 'Truck Expense') return 'bi-receipt';
            if (menuName === 'Password Reset') return 'bi-key';
            if (menuName === 'Dev Tracker') return 'bi-kanban';
            
            // MASTERS group icons
            if (menuName === 'Masters') return 'bi-gear';
            if (menuName === 'Users') return 'bi-people';
            if (menuName === 'Products') return 'bi-box';
            if (menuName === 'Suppliers') return 'bi-building';
            if (menuName === 'Customers') return 'bi-person-badge';
            if (menuName === 'Digital') return 'bi-credit-card-2-front';
            
            // AUDITING group icons
            if (menuName === 'Utilities') return 'bi-tools';
            if (menuName === 'Auditing Utilities') return 'bi-search';
            
            // Default icons by group
            if (groupName === 'DAILY_OPS') return 'bi-clock';
            if (groupName === 'TRANSACTIONS') return 'bi-credit-card';
            if (groupName === 'REPORTS_SECTION') return 'bi-graph-up';
            if (groupName === 'ADMIN') return 'bi-gear';
            if (groupName === 'MASTERS') return 'bi-gear';
            if (groupName === 'AUDITING') return 'bi-tools';
            
            // Fallback icon
            return 'bi-circle';
          }

        // Render all groups in database sequence order
        each group in sortedGroups
          if group.type === 'standalone' && group.menus && group.menus.length > 0
            // Standalone menu group
            .menu-section
              .menu-section-title= group.group_name
              each menu in group.menus
                a.menu-item(href=menu.url_path, class=(title === menu.menu_name ? 'active' : ''))
                  span.menu-item-icon
                    - var iconClass = getMenuIcon(menu.menu_name, group.group_name)
                    i.bi(class=iconClass)
                  | #{menu.menu_name}
          else if group.type === 'dropdown' && group.children && group.children.length > 0
            // Dropdown menu group
            .menu-section
              .menu-section-title.collapsible-header(onclick=`toggleMenuSection('${group.parent.menu_code}')`, style="cursor: pointer;")
                i.bi.bi-chevron-right.collapse-icon(id=`icon-${group.parent.menu_code}`, style="margin-right: 8px; transition: transform 0.3s ease;")
                | #{group.group_name}
              .menu-submenu(id=`submenu-${group.parent.menu_code}`, style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;")
                each child in group.children
                  a.menu-item.submenu-item(href=child.url_path, class=(title === child.menu_name ? 'active' : ''))
                    span.menu-item-icon
                      i.bi.bi-circle(style="font-size: 8px; margin-left: 4px;")
                    | #{child.menu_name}

      // Main Content Area
      .main-content#mainContent
        .top-bar
          .d-flex.align-items-center
            button.sidebar-toggle#sidebarToggle(type="button")
              i.bi.bi-list
            .breadcrumb-nav Dashboard > #{title}
          
          .top-bar-actions
            .user-info
              small Logged in as 
              strong #{user.Person_Name}
            a.logout-btn(href='/logout') Logout

        .content-wrapper
          if messages.error
            .alert.alert-danger #{messages.error}

          if messages.success
            .alert.alert-success #{messages.success}

          if messages.warning
            .alert.alert-warning #{messages.warning}

          div#static-snackbar.alert.alert-danger.d-md-none
          div#snackbar
          
          block content

    else
      // When user is not logged in, show original layout
      h1.text-center#petromath-heading PetroMath
      
      if messages.error
        div &nbsp;
        div.alert.alert-danger #{messages.error}

      if messages.success
        div &nbsp;
        div.alert.alert-success #{messages.success}

      if messages.warning
        div &nbsp;
        div.alert.alert-warning #{messages.warning}

      div &nbsp;
      div#static-snackbar.alert.alert-danger.d-md-none
      div#snackbar
      block content

    script.
      // Sidebar toggle functionality
      document.addEventListener('DOMContentLoaded', function() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        
        if (sidebarToggle && sidebar && mainContent) {
          sidebarToggle.addEventListener('click', function() {
            if (window.innerWidth <= 768) {
              // Mobile: toggle sidebar visibility
              sidebar.classList.toggle('show');
            } else {
              // Desktop: toggle sidebar collapse
              sidebar.classList.toggle('hidden');
              mainContent.classList.toggle('expanded');
            }
          });

          // Close sidebar when clicking outside on mobile
          document.addEventListener('click', function(event) {
            if (window.innerWidth <= 768 && 
                sidebar.classList.contains('show') &&
                !sidebar.contains(event.target) && 
                !sidebarToggle.contains(event.target)) {
              sidebar.classList.remove('show');
            }
          });

          // Handle window resize
          window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
              sidebar.classList.remove('show');
            }
          });
        }

        // Auto-expand submenu if current page is in it
        const menuItems = document.querySelectorAll('.menu-item.active');
        menuItems.forEach(item => {
          const submenu = item.closest('.menu-submenu');
          if (submenu) {
            const menuCode = submenu.id.replace('submenu-', '');
            expandMenuSection(menuCode);
          }
        });

      
      });

      // Toggle menu section function
      function toggleMenuSection(menuCode) {
        const submenu = document.getElementById('submenu-' + menuCode);
        const icon = document.getElementById('icon-' + menuCode);
        
        if (submenu && icon) {
          if (submenu.style.maxHeight === '0px' || submenu.style.maxHeight === '') {
            expandMenuSection(menuCode);
          } else {
            collapseMenuSection(menuCode);
          }
        }
      }

      function expandMenuSection(menuCode) {
        const submenu = document.getElementById('submenu-' + menuCode);
        const icon = document.getElementById('icon-' + menuCode);
        
        if (submenu && icon) {
          submenu.style.maxHeight = submenu.scrollHeight + 'px';
          icon.style.transform = 'rotate(90deg)';
        }
      }

      function collapseMenuSection(menuCode) {
        const submenu = document.getElementById('submenu-' + menuCode);
        const icon = document.getElementById('icon-' + menuCode);
        
        if (submenu && icon) {
          submenu.style.maxHeight = '0px';
          icon.style.transform = 'rotate(0deg)';
        }
      }