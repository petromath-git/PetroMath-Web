extends layout

block content
    style.
        /* Sticky header styling */
        .person-location-header-sticky {
            position: sticky;
            top: 0;
            z-index: 1020;
            background: white;
            border-bottom: 2px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .person-location-container {
            padding: 20px;
        }

        .section-card {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        /* Responsive Views */
        @media (min-width: 992px) {
            .mobile-cards-view {
                display: none !important;
            }
            .desktop-table-view {
                display: block !important;
            }
            .person-location-header-sticky h4 {
                font-size: 24px;
            }
        }

        @media (max-width: 991.98px) {
            .desktop-table-view {
                display: none !important;
            }
            .mobile-cards-view {
                display: block !important;
            }
            .person-location-header-sticky h4 {
                font-size: 18px;
            }
            .person-location-header-sticky .btn {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* Table styling */
        .table-responsive {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
        }

        /* Badge & Card Styling */
        .badge-custom {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
        }

        .location-assignment-card {
            border-radius: 12px;
            margin-bottom: 15px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .location-assignment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        .location-assignment-card .card-header {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 12px 16px;
        }

        /* Form refinements */
        .form-label {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .form-control, .form-select {
            border: 1px solid #ced4da;
            border-radius: 6px;
            height: 38px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.15rem rgba(0,123,255,0.25);
        }

        .section-card .row.g-3 > [class*='col'] {
            margin-bottom: 10px;
        }

        button.btn {
            height: 38px;
            line-height: 1.2;
        }

        #addLocationBtn {
            min-width: 40px;
        }

    // Sticky Header
    .person-location-header-sticky
        .container-fluid
            .row.align-items-center.py-2.justify-content-between
                .col-auto
                    h4.mb-0.text-primary
                        i.bi.bi-geo-alt-fill.me-2
                        | Assign User Locations
                .col-auto
                    .btn-group
                        button.btn.btn-info.btn-sm#refreshBtn(type="button")
                            i.bi.bi-arrow-clockwise.me-1
                            span.d-none.d-sm-inline Refresh
                            span.d-inline.d-sm-none Refresh

    // Main Content
    .person-location-container.container-fluid

        // Alerts
        .row
            .col-12
                #alertMessage.alert.alert-dismissible.fade(role="alert" style="display: none;")
                    span#messageText
                    button.btn-close(type="button" aria-label="Close" onclick="closeAlert()")

        // User Selection Section
        .row
            .col-12
                .section-card
                    h5.mb-3.text-primary
                        i.bi.bi-person-fill.me-2
                        | Select User
                    .row.g-3
                        .col-md-6.col-12
                            label.form-label(for="personSelect") Select a User
                            select#personSelect.form-select
                                option(value="") -- Select a User --
                        .col-md-6.col-12
                            label.form-label User Details
                            #userDetails.mt-2
                                .text-muted.small Select a user to view details

        // Add Location Access Section
        .row
            .col-12
                #addLocationSection.section-card(style="display: none;")
                    h5.mb-3.text-primary
                        i.bi.bi-plus-circle.me-2
                        | Add Location Access
                    .row.g-3.align-items-end
                        .col-md-4.col-12
                            label.form-label.text-muted.fw-semibold(for="locationSelect") Location
                            select#locationSelect.form-select
                                option(value="") -- Select Location --
                        .col-md-3.col-12
                            label.form-label.text-muted.fw-semibold(for="roleSelect") Role
                            select#roleSelect.form-select
                                option(value="") -- Select Role --
                        .col-md-2.col-6
                            label.form-label.text-muted.fw-semibold(for="startDate") Start Date
                            input#startDate.form-control(type="date")
                        .col-md-2.col-6
                            label.form-label.text-muted.fw-semibold(for="endDate") End Date
                            input#endDate.form-control(type="date")
                        .col-md-1.col-12
                            button#addLocationBtn.btn.btn-success.w-100(type="button")
                                i.bi.bi-plus-lg

        // Assigned Locations Section
        .row
            .col-12
                #assignedLocationsSection.section-card.mt-3(style="display: none;")
                    .d-flex.justify-content-between.align-items-center.mb-3
                        h5.mb-0.text-primary
                            i.bi.bi-list-ul.me-2
                            | Assigned Locations
                        span#locationCount.badge.bg-primary 0

                    // Desktop table view
                    .desktop-table-view
                        .table-responsive
                            table#assignedLocationsTable.table.table-hover.table-striped
                                thead.thead-dark.sticky-top
                                    tr
                                        th(scope="col") #
                                        th(scope="col") Location
                                        th(scope="col") Role
                                        th(scope="col") Start Date
                                        th(scope="col") End Date
                                        th(scope="col") Actions
                                tbody#assignedLocationsBody
                                    tr
                                        td.text-center(colspan="6")
                                            .spinner-border.text-primary(role="status")
                                                span.visually-hidden Loading...

                    // Mobile card view
                    .mobile-cards-view
                        #assignedLocationsMobile
                            .text-center
                                .spinner-border.text-primary(role="status")
                                    span.visually-hidden Loading...

    // JavaScript
    script.
        let selectedPersonId = null;
        let allPersons = [];
        let allLocations = [];
        let allRoles = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadPersons();
            loadLocations();
            loadRoles();
            setDefaultDates();

            document.getElementById('personSelect').addEventListener('change', handlePersonChange);
            document.getElementById('addLocationBtn').addEventListener('click', addLocationAccess);
            document.getElementById('refreshBtn').addEventListener('click', refreshData);
        });

        async function loadPersons() {
            try {
                const res = await fetch('/person-locations/api/persons');
                const result = await res.json();
                if (result.success) {
                    allPersons = result.data;
                    populatePersonSelect();
                }
            } catch (err) {
                console.error(err);
                showAlert('Error loading users', 'danger');
            }
        }

        async function loadLocations() {
            try {
                const res = await fetch('/person-locations/api/locations');
                const result = await res.json();
                if (result.success) {
                    allLocations = result.data;
                    populateLocationSelect();
                }
            } catch (err) { console.error(err); }
        }

        async function loadRoles() {
            try {
                const res = await fetch('/person-locations/api/roles');
                const result = await res.json();
                if (result.success) {
                    allRoles = result.data;
                    populateRoleSelect();
                }
            } catch (err) { console.error(err); }
        }

        function populatePersonSelect() {
            const select = document.getElementById('personSelect');
            select.innerHTML = '<option value="">-- Select a User --</option>';
            allPersons.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.person_id;
                opt.textContent = `${p.person_name} (${p.username}) - ${p.role}`;
                opt.dataset.person = JSON.stringify(p);
                select.appendChild(opt);
            });
        }

        function populateLocationSelect() {
            const select = document.getElementById('locationSelect');
            select.innerHTML = '<option value="">-- Select Location --</option>';
            allLocations.forEach(l => {
                const opt = document.createElement('option');
                opt.value = l.location_code;
                opt.textContent = `${l.location_name} (${l.location_code})`;
                select.appendChild(opt);
            });
        }

        function populateRoleSelect() {
            const select = document.getElementById('roleSelect');
            select.innerHTML = '<option value="">-- Select Role --</option>';
            allRoles.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.role_name;
                opt.textContent = r.role_display_name;
                select.appendChild(opt);
            });
        }

        function handlePersonChange() {
            const select = document.getElementById('personSelect');
            const opt = select.options[select.selectedIndex];
            if (select.value) {
                selectedPersonId = select.value;
                const person = JSON.parse(opt.dataset.person);
                displayUserDetails(person);
                document.getElementById('addLocationSection').style.display = 'block';
                document.getElementById('assignedLocationsSection').style.display = 'block';
                loadPersonLocations(selectedPersonId);
            } else {
                selectedPersonId = null;
                document.getElementById('userDetails').innerHTML = '<div class="text-muted small">Select a user to view details</div>';
                document.getElementById('addLocationSection').style.display = 'none';
                document.getElementById('assignedLocationsSection').style.display = 'none';
            }
        }

        function displayUserDetails(person) {
            const html = `
                <div class="row g-2">
                    <div class="col-md-6">
                        <small class="text-muted">Username:</small>
                        <div class="fw-bold">${person.username}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Role:</small>
                        <div class="fw-bold">${person.role}</div>
                    </div>
                    <div class="col-12">
                        <small class="text-muted">Primary Location:</small>
                        <div class="fw-bold">${person.primary_location_name} (${person.primary_location})</div>
                    </div>
                </div>`;
            document.getElementById('userDetails').innerHTML = html;
        }

        async function loadPersonLocations(id) {
            try {
                const res = await fetch(`/person-locations/api/person/${id}/locations`);
                const result = await res.json();
                if (result.success) displayAssignedLocations(result.data);
            } catch (err) {
                console.error(err);
                showAlert('Error loading assigned locations', 'danger');
            }
        }

        function displayAssignedLocations(locations) {
            const tbody = document.getElementById('assignedLocationsBody');
            const mobile = document.getElementById('assignedLocationsMobile');
            const count = document.getElementById('locationCount');
            count.textContent = locations.length;

            if (!locations.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No locations assigned yet</td></tr>';
                mobile.innerHTML = '<div class="text-center text-muted py-3">No locations assigned yet</div>';
                return;
            }

            tbody.innerHTML = '';
            locations.forEach((loc, i) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${loc.location_name}</strong><br><small class="text-muted">${loc.location_code}</small></td>
                        <td><span class="badge badge-custom bg-info">${loc.role}</span></td>
                        <td>${loc.effective_start_date}</td>
                        <td>${loc.effective_end_date}</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeLocation(${loc.personloc_id})"><i class="bi bi-trash"></i></button></td>
                    </tr>`;
            });

            mobile.innerHTML = '';
            locations.forEach((loc) => {
                mobile.innerHTML += `
                    <div class="card location-assignment-card shadow-sm">
                        <div class="card-header"><strong>${loc.location_name}</strong><small class="d-block mt-1">${loc.location_code}</small></div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-6">
                                    <small class="text-muted">Role:</small>
                                    <div><span class="badge badge-custom bg-info">${loc.role}</span></div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Start Date:</small>
                                    <div class="fw-bold">${loc.effective_start_date}</div>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">End Date:</small>
                                    <div class="fw-bold">${loc.effective_end_date}</div>
                                </div>
                                <div class="col-6 text-end">
                                    <button class="btn btn-danger btn-sm" onclick="removeLocation(${loc.personloc_id})">
                                        <i class="bi bi-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            });
        }

        async function addLocationAccess() {
            const location = document.getElementById('locationSelect').value;
            const role = document.getElementById('roleSelect').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value || '2400-01-01';
            if (!selectedPersonId || !location || !role || !start)
                return showAlert('Please fill all required fields', 'warning');

            try {
                const res = await fetch('/person-locations/api/assign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        person_id: selectedPersonId,
                        locations: [{ location_code: location, role, effective_start_date: start, effective_end_date: end }]
                    })
                });
                const result = await res.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    clearLocationForm();
                    loadPersonLocations(selectedPersonId);
                } else showAlert(result.error || 'Error assigning location', 'danger');
            } catch (err) {
                console.error(err);
                showAlert('Error adding location access', 'danger');
            }
        }

        async function removeLocation(id) {
            if (!confirm('Are you sure you want to remove this location assignment?')) return;
            try {
                const res = await fetch(`/person-locations/api/assignment/${id}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    showAlert(result.message, 'success');
                    loadPersonLocations(selectedPersonId);
                } else showAlert(result.error || 'Error removing location', 'danger');
            } catch (err) {
                console.error(err);
                showAlert('Error removing location assignment', 'danger');
            }
        }

        function clearLocationForm() {
            document.getElementById('locationSelect').value = '';
            document.getElementById('roleSelect').value = '';
            setDefaultDates();
        }

        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = '2400-01-01';
        }

        function refreshData() {
            loadPersons(); loadLocations(); loadRoles();
            if (selectedPersonId) loadPersonLocations(selectedPersonId);
            showAlert('Data refreshed successfully', 'success');
        }

        function showAlert(msg, type) {
            const div = document.getElementById('alertMessage');
            const text = document.getElementById('messageText');
            div.className = `alert alert-${type} alert-dismissible fade show`;
            text.textContent = msg;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 5000);
        }

        function closeAlert() {
            document.getElementById('alertMessage').style.display = 'none';
        }
