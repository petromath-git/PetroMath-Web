extends ../layout

block content
    .container-fluid.mt-4
        .row.mb-4
            .col-12
                nav(aria-label='breadcrumb')
                    ol.breadcrumb
                        li.breadcrumb-item
                            a(href='/gst') GST Returns
                        li.breadcrumb-item
                            a(href=`/gst/generate/${returnType}`) Generate #{returnType}
                        li.breadcrumb-item.active Preview
                
                h4= `${returnType} Preview - ${returnPeriod}`
        
        //- Validation Results
        .row.mb-3
            .col-12
                .card
                    .card-header.bg-info.text-white
                        i.bi.bi-check-circle.me-2
                        | Validation Results
                    .card-body
                        if validation.valid
                            p.text-success.mb-0
                                i.bi.bi-check-circle.me-2
                                | All validations passed
                        else
                            if validation.errors && validation.errors.length > 0
                                .alert.alert-danger
                                    strong Errors:
                                    ul.mb-0
                                        each error in validation.errors
                                            li= error
                        
                        if validation.warnings && validation.warnings.length > 0
                            .alert.alert-warning.mt-2.mb-0
                                strong Warnings:
                                ul.mb-0
                                    each warning in validation.warnings
                                        li= warning
        
        //- Summary Statistics
        if returnType === 'GSTR1'
            .row.mb-3
                .col-12
                    .card.border-primary
                        .card-header.bg-primary.text-white
                            i.bi.bi-bar-chart.me-2
                            | GSTR-1 Summary Report
                        .card-body
                            //- Quick Stats Row
                            .row.mb-4
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 Total Sales
                                            h4.text-primary.mb-0= `₹${(summary.total_taxable_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 B2B Invoices
                                            h4.text-success.mb-0= summary.total_b2b_invoices || 0
                                
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 B2C Invoices
                                            h4.text-info.mb-0= (summary.total_b2cl_invoices || 0) + (summary.total_b2cs_entries || 0)
                                
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 GST Collected
                                            h4.text-danger.mb-0= `₹${((summary.total_tax || 0)).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                            
                            hr
                            
                            //- HSN Summary Table
                            h6.mb-3
                                i.bi.bi-table.me-2
                                | HSN-wise Breakdown
                            .table-responsive
                                table.table.table-sm.table-hover
                                    thead.table-light
                                        tr
                                            th HSN Code
                                            th Product
                                            th Quantity
                                            th Taxable Value
                                            th GST Rate
                                            th CGST
                                            th SGST
                                            th Total GST
                                    tbody
                                        - let nilRatedTotal = 0
                                        - let taxable28Total = 0
                                        - let taxable18Total = 0
                                        - let taxable5Total = 0
                                        - let totalGST = 0
                                        - let gst28Total = 0
                                        - let gst18Total = 0
                                        - let gst5Total = 0

                                        if returnJson.hsn && returnJson.hsn.data
                                            each item in returnJson.hsn.data
                                                - let itemGST = parseFloat(item.camt || 0) + parseFloat(item.samt || 0) + parseFloat(item.iamt || 0)
                                                - totalGST += itemGST
                                                - let txval = parseFloat(item.txval || 0)
                                                - let gstRate = parseFloat(item.rt || 0)
                                                
                                                - if (gstRate === 0) {
                                                -   nilRatedTotal += txval
                                                - } else if (gstRate >= 27 && gstRate <= 29) {
                                                -   taxable28Total += txval
                                                -   gst28Total += itemGST
                                                - } else if (gstRate >= 17 && gstRate <= 19) {
                                                -   taxable18Total += txval
                                                -   gst18Total += itemGST
                                                - } else if (gstRate >= 4 && gstRate <= 6) {
                                                -   taxable5Total += txval
                                                -   gst5Total += itemGST
                                                - }
                                                
                                                tr(class=gstRate === 0 ? 'table-secondary' : (gstRate >= 27 && gstRate <= 29) ? 'table-warning' : (gstRate >= 17 && gstRate <= 19) ? 'table-info' : (gstRate >= 4 && gstRate <= 6) ? 'table-success' : '')
                                                    td= item.hsn_sc
                                                    td= item.desc
                                                    td.text-end= parseFloat(item.qty).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})
                                                    td.text-end= `₹${parseFloat(item.txval).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                    td.text-center
                                                        if gstRate === 0
                                                            span.badge.bg-secondary 0%
                                                        else if gstRate >= 27 && gstRate <= 29
                                                            span.badge.bg-warning.text-dark= `${gstRate}%`
                                                        else if gstRate >= 17 && gstRate <= 19
                                                            span.badge.bg-info= `${gstRate}%`
                                                        else if gstRate >= 4 && gstRate <= 6
                                                            span.badge.bg-success= `${gstRate}%`
                                                        else
                                                            span.badge.bg-primary= `${gstRate}%`
                                                    td.text-end= `₹${parseFloat(item.camt || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                    td.text-end= `₹${parseFloat(item.samt || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                    td.text-end
                                                        strong= `₹${itemGST.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                    tfoot.table-light
                                        tr
                                            th(colspan='3') Total
                                            th.text-end= `₹${(nilRatedTotal + taxable28Total + taxable18Total + taxable5Total).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                            th
                                            th(colspan='2')
                                            th.text-end
                                                strong= `₹${totalGST.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                            
                            hr
                            
                            //- Category Breakdown
                            .row
                                if nilRatedTotal > 0
                                    .col-md-4.mb-3
                                        .card.border-secondary
                                            .card-body
                                                h6.text-muted
                                                    i.bi.bi-circle-fill.text-secondary.me-2
                                                    | Nil-Rated (0% GST)
                                                h5.mb-0= `₹${nilRatedTotal.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                small.text-muted Fuel (Petrol/Diesel)
                                
                                if taxable5Total > 0
                                    .col-md-4.mb-3
                                        .card.border-success
                                            .card-body
                                                h6.text-muted
                                                    i.bi.bi-circle-fill.text-success.me-2
                                                    | Taxable @ 5%
                                                h5.mb-0= `₹${taxable5Total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                small.text-muted= `GST: ₹${gst5Total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                
                                if taxable18Total > 0
                                    .col-md-4.mb-3
                                        .card.border-info
                                            .card-body
                                                h6.text-muted
                                                    i.bi.bi-circle-fill.text-info.me-2
                                                    | Taxable @ 18%
                                                h5.mb-0= `₹${taxable18Total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                small.text-muted= `GST: ₹${gst18Total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                
                                if taxable28Total > 0
                                    .col-md-4.mb-3
                                        .card.border-warning
                                            .card-body
                                                h6.text-muted
                                                    i.bi.bi-circle-fill.text-warning.me-2
                                                    | Taxable @ 28%
                                                h5.mb-0= `₹${taxable28Total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                                small.text-muted= `GST: ₹${gst28Total.toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
        
        //- GSTR-3B Summary
        if returnType === 'GSTR3B'
            .row.mb-3
                .col-12
                    .card.border-success
                        .card-header.bg-success.text-white
                            i.bi.bi-calculator.me-2
                            | GSTR-3B Summary Report
                        .card-body
                            //- Summary Cards
                            .row.mb-4
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 Output Tax
                                            h4.text-danger.mb-0= `₹${(summary.total_tax || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 Input Tax Credit
                                            h4.text-success.mb-0= `₹${(summary.total_itc || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 Net Tax Payable
                                            h4.text-primary.mb-0= `₹${(summary.net_tax_payable || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                                
                                .col-md-3
                                    .card.text-center.border-0.bg-light
                                        .card-body
                                            h6.text-muted.mb-2 Total Taxable Value
                                            h4.text-info.mb-0= `₹${(summary.total_taxable_value || 0).toLocaleString('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`
                            
                            //- Nil-Rated/Exempt Supplies Summary
                            if summary.nil_rated_sales || summary.nil_rated_purchases
                                .row.mb-3
                                    .col-12
                                        .alert.alert-light.border.mb-0
                                            .d-flex.align-items-center.mb-2
                                                i.bi.bi-info-circle.text-info.fs-5.me-2
                                                strong Nil-Rated/Exempt Supplies (0% GST)
                                                small.text-muted.ms-2 These values are included in Table 5 of GSTR-3B JSON
                                            .row.mt-2
                                                .col-md-6
                                                    .d-flex.justify-content-between.align-items-center.p-2.bg-white.rounded
                                                        span
                                                            i.bi.bi-arrow-up-right.text-secondary.me-2
                                                            strong Outward Supplies (Sales):
                                                        span.text-primary
                                                            strong= `₹${parseFloat(summary.nil_rated_sales || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                    small.text-muted.ms-4 Mainly fuel (Petrol/Diesel)
                                                .col-md-6
                                                    .d-flex.justify-content-between.align-items-center.p-2.bg-white.rounded
                                                        span
                                                            i.bi.bi-arrow-down-left.text-secondary.me-2
                                                            strong Inward Supplies (Purchases):
                                                        span.text-success
                                                            strong= `₹${parseFloat(summary.nil_rated_purchases || 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                    small.text-muted.ms-4 Mainly fuel purchases
                            
                            hr
                            
                            //- OUTPUT TAX BREAKDOWN
                            .row.mb-4
                                .col-12
                                    h6.mb-3
                                        i.bi.bi-arrow-up-circle.text-danger.me-2
                                        | Output Tax Breakdown (Sales)
                                    
                                    //- Merge cash and 2T oil sales
                                    - let allCashSales = []
                                    - if (salesBreakdown) {
                                    -     if (salesBreakdown.cashSales) allCashSales = allCashSales.concat(salesBreakdown.cashSales)
                                    -     if (salesBreakdown.twoTOilSales) allCashSales = allCashSales.concat(salesBreakdown.twoTOilSales)
                                    - }
                                    
                                    //- Credit Sales
                                    .card.mb-3.border-secondary
                                        .card-header.bg-light(style='cursor: pointer;' onclick='toggleSection("creditSalesDetails")')
                                            .d-flex.justify-content-between.align-items-center
                                                div
                                                    strong.me-3
                                                        i.bi.bi-credit-card.me-2
                                                        | Credit Sales
                                                    if salesBreakdown && salesBreakdown.creditSales && salesBreakdown.creditSales.length > 0
                                                        - let creditTotal = salesBreakdown.creditSales.reduce((sum, s) => sum + parseFloat(s.cgst || 0) + parseFloat(s.sgst || 0), 0)
                                                        span.badge.bg-secondary.me-2 #{salesBreakdown.creditSales.length} invoices
                                                        span.badge.bg-danger GST: ₹#{creditTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                                    else
                                                        span.badge.bg-secondary No GST items
                                                i.bi.bi-plus-circle.fs-5.text-primary#creditSalesIcon
                                        #creditSalesDetails.collapse
                                            .card-body
                                                if salesBreakdown && salesBreakdown.creditSales && salesBreakdown.creditSales.length > 0
                                                    .table-responsive
                                                        table.table.table-sm.table-hover.mb-0
                                                            thead.table-light
                                                                tr
                                                                    th Bill No
                                                                    th Date
                                                                    th Customer
                                                                    th Product
                                                                    th Qty
                                                                    th Taxable Value
                                                                    th GST%
                                                                    th CGST
                                                                    th SGST
                                                                    th Total GST
                                                            tbody
                                                                each sale in salesBreakdown.creditSales
                                                                    tr
                                                                        td= sale.bill_no
                                                                        td= sale.invoice_date
                                                                        td.small= sale.customer_name || 'N/A'
                                                                        td.small= sale.product_name
                                                                        td.text-end= parseFloat(sale.quantity).toFixed(2)
                                                                        td.text-end= `₹${parseFloat(sale.taxable_value).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-center
                                                                            span.badge.bg-info= `${parseFloat(sale.gst_rate).toFixed(0)}%`
                                                                        td.text-end= `₹${parseFloat(sale.cgst).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-end= `₹${parseFloat(sale.sgst).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-end
                                                                            strong= `₹${(parseFloat(sale.cgst) + parseFloat(sale.sgst)).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                else
                                                    p.text-center.text-muted.mb-0.py-3 All credit sales are fuel (0% GST)
                                    
                                    //- Cash Sales (MERGED)
                                    .card.mb-3.border-info
                                        .card-header.bg-light(style='cursor: pointer;' onclick='toggleSection("cashSalesDetails")')
                                            .d-flex.justify-content-between.align-items-center
                                                div
                                                    strong.me-3
                                                        i.bi.bi-cash-coin.me-2
                                                        | Cash Sales (includes 2T Oil)
                                                    if allCashSales.length > 0
                                                        - let cashTotal = allCashSales.reduce((sum, s) => sum + parseFloat(s.cgst || 0) + parseFloat(s.sgst || 0), 0)
                                                        span.badge.bg-info.me-2 #{allCashSales.length} transactions
                                                        span.badge.bg-danger GST: ₹#{cashTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                                    else
                                                        span.badge.bg-secondary No GST items
                                                i.bi.bi-plus-circle.fs-5.text-primary#cashSalesIcon
                                        #cashSalesDetails.collapse
                                            .card-body
                                                if allCashSales.length > 0
                                                    .table-responsive
                                                        table.table.table-sm.table-hover.mb-0
                                                            thead.table-light
                                                                tr
                                                                    th Bill No
                                                                    th Date
                                                                    th Product
                                                                    th Qty
                                                                    th Rate
                                                                    th Taxable Value
                                                                    th GST%
                                                                    th CGST
                                                                    th SGST
                                                                    th Total GST
                                                            tbody
                                                                each sale in allCashSales
                                                                    tr
                                                                        td= sale.bill_no || '-'
                                                                        td= sale.invoice_date
                                                                        td.small= sale.product_name
                                                                        td.text-end= parseFloat(sale.quantity).toFixed(2)
                                                                        td.text-end= sale.rate ? `₹${parseFloat(sale.rate).toFixed(2)}` : '-'
                                                                        td.text-end= `₹${parseFloat(sale.taxable_value).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-center
                                                                            span.badge.bg-info= `${parseFloat(sale.gst_rate).toFixed(0)}%`
                                                                        td.text-end= `₹${parseFloat(sale.cgst).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-end= `₹${parseFloat(sale.sgst).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-end
                                                                            strong= `₹${(parseFloat(sale.cgst) + parseFloat(sale.sgst)).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                else
                                                    p.text-center.text-muted.mb-0.py-3 No cash sales with GST
                            
                            hr
                            
                            //- INPUT TAX CREDIT
                            .row
                                .col-12
                                    h6.mb-3
                                        i.bi.bi-arrow-down-circle.text-success.me-2
                                        | Input Tax Credit Breakdown (Purchases)
                                    
                                    .card.mb-3.border-success
                                        .card-header.bg-light(style='cursor: pointer;' onclick='toggleSection("purchaseDetails")')
                                            .d-flex.justify-content-between.align-items-center
                                                div
                                                    strong.me-3
                                                        i.bi.bi-cart-check.me-2.text-success
                                                        | Purchase Invoices
                                                    if purchaseBreakdown && purchaseBreakdown.length > 0
                                                        - let purchaseTotal = purchaseBreakdown.reduce((sum, p) => sum + parseFloat(p.cgst || 0) + parseFloat(p.sgst || 0), 0)
                                                        span.badge.bg-success.me-2 #{purchaseBreakdown.length} invoices
                                                        span.badge.bg-info ITC: ₹#{purchaseTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}
                                                    else
                                                        span.badge.bg-secondary No purchases
                                                i.bi.bi-plus-circle.fs-5.text-primary#purchaseIcon
                                        #purchaseDetails.collapse
                                            .card-body
                                                if purchaseBreakdown && purchaseBreakdown.length > 0
                                                    .table-responsive
                                                        table.table.table-sm.table-hover.mb-0
                                                            thead.table-light
                                                                tr
                                                                    th Invoice No
                                                                    th Date
                                                                    th Supplier
                                                                    th Product
                                                                    th Qty
                                                                    th Taxable Value
                                                                    th GST%
                                                                    th CGST
                                                                    th SGST
                                                                    th Total ITC
                                                            tbody
                                                                each purchase in purchaseBreakdown
                                                                    tr
                                                                        td= purchase.invoice_number
                                                                        td= purchase.invoice_date
                                                                        td.small= purchase.supplier_name
                                                                        td.small= purchase.product_name
                                                                        td.text-end= parseFloat(purchase.quantity).toFixed(2)
                                                                        td.text-end= `₹${parseFloat(purchase.taxable_value).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-center
                                                                            span.badge.bg-success= `${parseFloat(purchase.gst_rate).toFixed(0)}%`
                                                                        td.text-end= `₹${parseFloat(purchase.cgst).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-end= `₹${parseFloat(purchase.sgst).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                        td.text-end
                                                                            strong= `₹${(parseFloat(purchase.cgst) + parseFloat(purchase.sgst)).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                            tfoot.table-light
                                                                tr
                                                                    td(colspan='5')
                                                                        strong Total
                                                                    td.text-end
                                                                        strong= `₹${purchaseBreakdown.reduce((sum, p) => sum + parseFloat(p.taxable_value), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                    td
                                                                    td.text-end
                                                                        strong= `₹${purchaseBreakdown.reduce((sum, p) => sum + parseFloat(p.cgst), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                    td.text-end
                                                                        strong= `₹${purchaseBreakdown.reduce((sum, p) => sum + parseFloat(p.sgst), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                                    td.text-end
                                                                        strong= `₹${purchaseBreakdown.reduce((sum, p) => sum + parseFloat(p.cgst) + parseFloat(p.sgst), 0).toLocaleString('en-IN', {minimumFractionDigits: 2})}`
                                                else
                                                    p.text-center.text-muted.mb-0.py-3 No purchase invoices
        
        //- Summary Cards (Original)
        .row.mb-3
            .col-12
                .card
                    .card-header.bg-secondary.text-white
                        i.bi.bi-list-check.me-2
                        | Detailed Summary
                    .card-body
                        .row
                            each value, key in summary
                                .col-md-3.mb-2
                                    strong= key.replace(/_/g, ' ').toUpperCase() + ':'
                                    br
                                    span= typeof value === 'number' ? value.toLocaleString('en-IN') : value
        
        //- JSON Preview
        .row.mb-3
            .col-12
                .card
                    .card-header.d-flex.justify-content-between
                        span
                            i.bi.bi-code-square.me-2
                            | Complete JSON (for GST Portal Upload)
                        button.btn.btn-sm.btn-outline-secondary(onclick='copyJson()')
                            i.bi.bi-clipboard.me-1
                            | Copy JSON
                    .card-body
                        pre#jsonData.bg-light.p-3.border.rounded(style='max-height: 500px; overflow-y: auto; font-size: 0.85rem;')= JSON.stringify(returnJson, null, 2)
        
        //- Actions
        .row
            .col-12
                .text-center
                    form.d-inline(method='POST' action='/gst/download')
                        input(type='hidden' name='return_type' value=returnType)
                        input(type='hidden' name='return_period' value=returnPeriod)
                        button.btn.btn-success.btn-lg(type='submit')
                            i.bi.bi-download.me-2
                            | Download JSON File
                    
                    a.btn.btn-outline-secondary.btn-lg.ms-3(href='/gst') Back to Dashboard

        //- JavaScript
        script.
            function copyJson() {
                const jsonText = document.getElementById('jsonData').textContent;
                navigator.clipboard.writeText(jsonText).then(function() {
                    alert('JSON copied to clipboard!');
                }).catch(function(err) {
                    alert('Failed to copy');
                });
            }
            
            function toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const iconId = sectionId.replace('Details', 'Icon');
                const icon = document.getElementById(iconId);
                
                if (section.classList.contains('show')) {
                    section.classList.remove('show');
                    section.classList.add('collapse');
                    if (icon) {
                        icon.classList.remove('bi-dash-circle');
                        icon.classList.add('bi-plus-circle');
                    }
                } else {
                    section.classList.remove('collapse');
                    section.classList.add('show');
                    if (icon) {
                        icon.classList.remove('bi-plus-circle');
                        icon.classList.add('bi-dash-circle');
                    }
                }
            }
