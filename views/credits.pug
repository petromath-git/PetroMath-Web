extends layout

block content
    // Alert for messages
    div#messageAlert.alert.alert-dismissible.fade(role="alert" style="display: none;")
        span#messageText
        button.close(type="button", data-dismiss="alert", aria-label="Close")
            span(aria-hidden="true") &times;
    
    // Sticky header
    .customers-header-sticky
        .container-fluid
            .row.align-items-center.py-3
                .col
                    h4.mb-0.text-primary Customer Master
                .col-auto
                    if canAdd
                        button.btn.btn-success.btn-sm#addCustomerBtn(type="button", data-toggle="modal", data-target="#addCustomerModal")
                            i.bi.bi-plus-circle.me-1
                            | Add Customer
                    button.btn.btn-warning.btn-sm.ms-2#viewDisabledBtn(type="button", onclick="window.location.href='/credit-master/enable'")
                        i.bi.bi-eye-slash.me-1
                        | View Disabled
                    button.btn.btn-info.btn-sm.ms-2#refreshDataBtn(type="button")
                        i.bi.bi-arrow-clockwise.me-1
                        | Refresh

    // Customers content
    .customers-container
        // Search Box
        .row.mb-3
            .col-12.col-md-6.col-lg-4
                .input-group
                    .input-group-prepend
                        span.input-group-text
                            i.bi.bi-search
                    input.form-control#searchInput(
                        type="text",
                        placeholder="Search by name, phone, GST...",
                        autocomplete="off"
                    )
                    .input-group-append
                        button.btn.btn-outline-secondary#clearSearch(type="button", style="display: none;")
                            i.bi.bi-x-circle
        
        // Desktop table view
        .table-responsive
            table.table.table-hover.table-striped(id="customers-master-table")
                thead.thead-dark.sticky-top
                    tr
                        th #
                        th Company Name
                        if customerTypes && customerTypes.length > 1
                            th Type
                        th Short Name
                        th Phone
                        th Address
                        th GST
                        th Remittance Bank
                        if canEdit || canDisable
                            th Actions
                tbody#customersTableBody
                    if credits && credits.length > 0
                        each val, index in credits
                            tr(data-customer-id=val.creditlist_id)
                                td= index + 1
                                td= val.Company_Name
                                if customerTypes && customerTypes.length > 1
                                    td= val.type || '-'
                                td= val.short_name || '-'
                                td= val.phoneno || '-'
                                td= val.address || '-'
                                td= val.gst || '-'
                                td= val.bank_name || '-'
                                if canEdit || canDisable
                                    td
                                        if canEdit
                                            button.btn.btn-sm.btn-outline-primary.edit-customer-btn(
                                                type="button",
                                                data-customer-id=val.creditlist_id,
                                                data-toggle="modal",
                                                data-target="#editCustomerModal"
                                            )
                                                i.bi.bi-pencil
                                        if canDisable
                                            button.btn.btn-sm.btn-outline-danger.ms-1.disable-customer-btn(
                                                type="button",
                                                data-customer-id=val.creditlist_id,
                                                data-customer-name=val.Company_Name
                                            )
                                                i.bi.bi-trash
                    else
                        tr
                            td.text-center(colspan="9") No customers found

    // Add Customer Modal
    .modal.fade#addCustomerModal(tabindex="-1", role="dialog")
        .modal-dialog.modal-lg(role="document")
            .modal-content
                .modal-header
                    h5.modal-title Add New Customer
                    button.close(type="button", data-dismiss="modal", aria-label="Close")
                        span(aria-hidden="true") &times;
                .modal-body
                    form#addCustomerForm(method='POST', action='/credit-master')
                        .row
                            .col-md-6.mb-3
                                label.form-label Company Name *
                                input.form-control.text-uppercase(type="text", name="m_credit_name_0", required)
                            if customerTypes && customerTypes.length > 1
                                .col-md-6.mb-3
                                    label.form-label Type *
                                    select.form-control(name="m_credit_type_0", required)
                                        each type in customerTypes
                                            option(value=type.description, selected=type.is_default)= type.description
                            else
                                input(type="hidden", name="m_credit_type_0", value=customerTypes[0].description)
                            .col-md-6.mb-3
                                label.form-label Short Name
                                input.form-control.text-uppercase(type="text", name="m_credit_short_name_0", maxlength="20")
                            .col-md-6.mb-3
                                label.form-label Phone
                                input.form-control(type="text", name="m_credit_phoneno_0", maxlength="50")
                            .col-md-12.mb-3
                                label.form-label Address
                                textarea.form-control.text-uppercase(name="m_credit_address_0", rows="2", maxlength="300")
                            .col-md-6.mb-3
                                label.form-label GST Number
                                input.form-control.text-uppercase(type="text", name="m_credit_gst_0", maxlength="15")
                            .col-md-6.mb-3
                                label.form-label Remittance Bank
                                select.form-control(name="m_credit_remittance_bank_id_0")
                                    option(value="") Select Bank
                                    if banks
                                        each bank in banks
                                            option(value=bank.bank_id)= bank.account_nickname || bank.bank_name
                .modal-footer
                    button.btn.btn-secondary(type="button", data-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit", form="addCustomerForm") Save Customer

    // Edit Customer Modal
    .modal.fade#editCustomerModal(tabindex="-1", role="dialog")
        .modal-dialog.modal-lg(role="document")
            .modal-content
                .modal-header
                    h5.modal-title Edit Customer
                    button.close(type="button", data-dismiss="modal", aria-label="Close")
                        span(aria-hidden="true") &times;
                .modal-body
                    form#editCustomerForm(method='POST')
                        input(type="hidden", name="customer_id", id="edit_customer_id")
                        .row
                            .col-md-6.mb-3
                                label.form-label Company Name *
                                input.form-control.text-uppercase(type="text", name="Company_Name", id="edit_company_name", required)
                            .col-md-6.mb-3
                                label.form-label Short Name
                                input.form-control.text-uppercase(type="text", name="short_name", id="edit_short_name", maxlength="20")
                            .col-md-6.mb-3
                                label.form-label Phone
                                input.form-control(type="text", name="phoneno", id="edit_phoneno", maxlength="50")
                            .col-md-12.mb-3
                                label.form-label Address
                                textarea.form-control.text-uppercase(name="address", id="edit_address", rows="2", maxlength="300")
                            .col-md-6.mb-3
                                label.form-label GST Number
                                input.form-control.text-uppercase(type="text", name="gst", id="edit_gst", maxlength="15")
                            .col-md-6.mb-3
                                label.form-label Remittance Bank
                                select.form-control(name="remittance_bank_id", id="edit_remittance_bank_id")
                                    option(value="") Select Bank
                                    if banks
                                        each bank in banks
                                            option(value=bank.bank_id)= bank.account_nickname || bank.bank_name
                .modal-footer
                    button.btn.btn-secondary(type="button", data-dismiss="modal") Cancel
                    button.btn.btn-primary(type="submit", form="editCustomerForm") Update Customer

    // Custom CSS
    style.
        .customers-header-sticky {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .customers-container {
            padding: 20px;
        }
        .text-uppercase {
            text-transform: uppercase;
        }

    // JavaScript
    script.
        let creditsData = !{JSON.stringify(credits || [])};
        let banksData = !{JSON.stringify(banks || [])};
        let customerTypesData = !{JSON.stringify(customerTypes || [])};

        // Show message function
        function showMessage(message, type) {
            const alertDiv = document.getElementById('messageAlert');
            const messageText = document.getElementById('messageText');
            
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            messageText.textContent = message;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const clearBtn = document.getElementById('clearSearch');
            
            if (searchTerm) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }
            
            filterCustomers(searchTerm);
        });

        document.getElementById('clearSearch').addEventListener('click', function() {
            document.getElementById('searchInput').value = '';
            this.style.display = 'none';
            filterCustomers('');
        });

        function filterCustomers(searchTerm) {
            const tbody = document.getElementById('customersTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            Array.from(rows).forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Refresh functionality
        document.getElementById('refreshDataBtn').addEventListener('click', function() {
            location.reload();
        });

        // Edit customer functionality
        document.querySelectorAll('.edit-customer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const customerId = this.getAttribute('data-customer-id');
                const customer = creditsData.find(c => c.creditlist_id == customerId);
                
                if (customer) {
                    document.getElementById('edit_customer_id').value = customer.creditlist_id;
                    document.getElementById('edit_company_name').value = customer.Company_Name;
                    document.getElementById('edit_short_name').value = customer.short_name || '';
                    document.getElementById('edit_phoneno').value = customer.phoneno || '';
                    document.getElementById('edit_address').value = customer.address || '';
                    document.getElementById('edit_gst').value = customer.gst || '';
                    document.getElementById('edit_remittance_bank_id').value = customer.remittance_bank_id || '';
                }
            });
        });

        // Edit form submission
        document.getElementById('editCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const customerId = formData.get('customer_id');
            
            fetch(`/credit-master/api/${customerId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData))
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMessage('Customer updated successfully', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showMessage(data.error || 'Error updating customer', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Error updating customer', 'danger');
            });
        });

        // Disable customer functionality
        document.querySelectorAll('.disable-customer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const customerId = this.getAttribute('data-customer-id');
                const customerName = this.getAttribute('data-customer-name');
                
                if (confirm(`Are you sure you want to disable customer "${customerName}"?`)) {
                    fetch(`/credit-master/disable/${customerId}`, {
                        method: 'PUT'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            showMessage('Customer disabled successfully', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            showMessage(data.error || 'Error disabling customer', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showMessage('Error disabling customer', 'danger');
                    });
                }
            });
        });