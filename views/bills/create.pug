extends ../layout

block content
    .container-fluid
        .card
            .card-header
                .d-flex.justify-content-between.align-items-center
                    .d-flex.align-items-center.gap-3
                        button.btn.btn-secondary(onclick="window.location.href='/bills'")
                            i.bi.bi-arrow-left
                            |  Back to Bills
                        h5.card-title.mb-0 Create New Bill
                    .float-right.d-none.d-md-block
                        button.btn.btn-info#addRowDesktop(type='button')
                            i.bi.bi-plus
                            |  Add Item

            .card-body               
                
                form#billForm(method='POST' action='/bills')
                    //- Desktop Selection Section
                    
                    .row.mb-3.d-none.d-md-flex
                        .col-md-4.mb-3.mb-md-0
                            .form-group
                                label(for='shift') Select Shift *
                                select#shift.form-control(name='closing_id' required)
                                    option(value='') Select Shift
                                    each shift in shifts
                                        option(
                                            value=shift.closing_id 
                                            selected=(selectedShift && shift.closing_id === selectedShift)
                                        ) #{shift.cashier_name}(#{shift.closing_id}) - #{new Date(shift.creation_date).toLocaleDateString('en-IN')}
                        .col-md-4.mb-3.mb-md-0
                            .form-group
                                label Bill Type *
                                .mt-2
                                    .form-check.form-check-inline
                                        input#cashBill.form-check-input(type='radio' name='bill_type' value='CASH' required checked)
                                        label.form-check-label(for='cashBill') Cash
                                    .form-check.form-check-inline.ms-3
                                        input#creditBill.form-check-input(type='radio' name='bill_type' value='CREDIT' required)
                                        label.form-check-label(for='creditBill') Credit
                        .col-md-4.mb-3.mb-md-0
                            //- Customer/Vehicle fields will go here for desktop
                    
                    //- Mobile Selection Section
                    .d-block.d-md-none.mb-3
                        .mobile-form-section
                            //- Shift Selection - Mobile (different name)
                            .form-group.mb-3
                                label(for='shiftMobile').form-label.fw-bold Select Shift *
                                select#shiftMobile.form-control.form-control-lg(name='closing_id_mobile' required style='font-size: 16px !important; height: 48px !important;')
                                    option(value='') Select Shift
                                    each shift in shifts
                                        option(
                                            value=shift.closing_id 
                                            selected=(selectedShift && shift.closing_id === selectedShift)
                                        ) #{shift.cashier_name}(#{shift.closing_id}) - #{new Date(shift.creation_date).toLocaleDateString('en-IN')}
                            
                            //- Bill Type - Mobile (different name)
                            .form-group.mb-3
                                label.form-label.fw-bold Bill Type *
                                .row.g-3
                                    .col-6
                                        .form-check
                                            input#cashBillMobile.form-check-input(type='radio' name='bill_type_mobile' value='CASH' required checked)
                                            label.form-check-label(for='cashBillMobile' style='font-weight: 600; font-size: 16px;') Cash
                                    .col-6
                                        .form-check
                                            input#creditBillMobile.form-check-input(type='radio' name='bill_type_mobile' value='CREDIT' required)
                                            label.form-check-label(for='creditBillMobile' style='font-weight: 600; font-size: 16px;') Credit

                            //- Customer Name (Cash) - Mobile (different name)
                            .form-group.mb-3#cashCustomerMobileDiv
                                label(for='cashCustomerMobile').form-label.fw-bold Customer Name
                                input#cashCustomerMobile.form-control.form-control-lg(
                                    type='text' 
                                    name='customer_name'
                                    maxlength='80'
                                    style='text-transform: uppercase; font-size: 16px !important; height: 48px !important;'
                                    placeholder='Enter customer name'
                                )
                            
                            //- Credit Customer Dropdown - Mobile (different name)
                            .form-group.mb-3.d-none#creditCustomerMobileDiv
                                label(for='creditCustomerMobile').form-label.fw-bold Customer *
                                select#creditCustomerMobile.form-control.form-control-lg(name='creditlist_id_mobile' style='font-size: 16px !important; height: 48px !important;')
                                    option(value='') Select Customer
                                    each credit in credits
                                        option(value=credit.creditlist_id) #{credit.Company_Name}

                            //- Vehicle Number - Mobile (different name)
                            .form-group.mb-3
                                //- Cash Vehicle - Mobile
                                div#cashVehicleMobileDiv
                                    label(for='cashVehicleMobile').form-label.fw-bold Vehicle Number
                                    input#cashVehicleMobile.form-control.form-control-lg(
                                        type='text'
                                        name='bill_vehicle_number'
                                        maxlength='12'
                                        style='text-transform: uppercase; font-size: 16px !important; height: 48px !important;'
                                        placeholder='Enter vehicle number'
                                    )
                                
                                //- Credit Vehicle - Mobile
                                div#creditVehicleMobileDiv.d-none
                                    label(for='creditVehicleMobile').form-label.fw-bold Vehicle Number
                                    select#creditVehicleMobile.form-control.form-control-lg(name='bill_vehicle_id_mobile' style='font-size: 16px !important; height: 48px !important;')
                                        option(value='') Select Vehicle

                            //- Odometer Reading - Mobile (different name)
                            .form-group.mb-0
                                label(for='odometerMobile').form-label.fw-bold Odometer Reading
                                input#odometerMobile.form-control.form-control-lg(
                                    type='number'
                                    name='bill_odometer_reading'
                                    step='0.01'
                                    min='0'
                                    placeholder='0.00'
                                    style='font-size: 16px !important; height: 48px !important;'
                                )
                    .d-block.d-md-none.mb-3
                        .mobile-form-section
                            .form-group.mb-3
                                label.form-label.fw-bold Product *
                                select#mobileProduct.form-control.form-control-lg(style='font-size: 16px !important; height: 48px !important;')
                                    option(value='') Select Product
                                    each product in products
                                        option(
                                            value=product.product_id 
                                            data-price=product.price
                                            data-unit=product.unit
                                        ) #{product.product_name}
                            
                            .row.g-2
                                .col-6
                                    .form-group.mb-3
                                        label.form-label.fw-bold Quantity *
                                        input#mobileQty.form-control.form-control-lg(type='number' step='0.001' style='font-size: 16px !important; height: 48px !important;' placeholder='0.000')
                                .col-6
                                    .form-group.mb-3
                                        label.form-label.fw-bold Discount
                                        input#mobileDiscount.form-control.form-control-lg(type='number' step='0.01' style='font-size: 16px !important; height: 48px !important;' placeholder='0.00')
                            
                            .form-group.mb-0
                                button#addRowMobile.btn.btn-primary.w-100(type='button' style='height: 48px !important; font-size: 16px !important;')
                                    i.bi.bi-plus.me-1
                                    | Add Item            
                    //- Desktop Customer/Vehicle Row
                    .row.mb-3.d-none.d-md-flex
                        .col-md-4.mb-3.mb-md-0
                            .form-group
                                //- Cash Customer Name - Desktop
                                div#cashCustomerDiv
                                    label(for='cashCustomerName') Customer Name
                                    input#cashCustomerName.form-control(
                                        type='text' 
                                        name='customer_name'
                                        maxlength='80'
                                        style='text-transform: uppercase'
                                        placeholder='Enter customer name'
                                    )
                                
                                //- Credit Customer Dropdown - Desktop
                                div#creditCustomerDiv.d-none
                                    label(for='creditCustomer') Customer *
                                    select#creditCustomer.form-control(name='creditlist_id')
                                        option(value='') Select Customer
                                        each credit in credits
                                            option(value=credit.creditlist_id) #{credit.Company_Name}

                        .col-md-4.mb-3.mb-md-0
                            .form-group
                                //- Cash Vehicle - Desktop
                                div#cashVehicleDiv
                                    label(for='cashVehicleNumber') Vehicle Number
                                    input#cashVehicleNumber.form-control(
                                        type='text'
                                        name='bill_vehicle_number'
                                        maxlength='12'
                                        style='text-transform: uppercase'
                                        placeholder='Enter vehicle number'
                                    )
                                
                                //- Credit Vehicle - Desktop
                                div#creditVehicleDiv.d-none
                                    label(for='creditVehicle') Vehicle Number
                                    select#creditVehicle.form-control(name='bill_vehicle_id')
                                        option(value='') Select Vehicle

                        .col-md-4.mb-3.mb-md-0
                            .form-group
                                label(for='odometerReading') Odometer Reading
                                input#odometerReading.form-control(
                                    type='number'
                                    name='bill_odometer_reading'
                                    step='0.01'
                                    min='0'
                                    placeholder='0.00'
                                )
                    
                    //- Items Table - Desktop View
                    .table-responsive
                        table.table.table-bordered#billItemsTable
                            thead.thead-light
                                tr
                                    th Product
                                    th.text-right Price
                                    th.text-right Quantity
                                    th.text-right Discount
                                    th.text-right Subtotal
                                    th.text-right CGST
                                    th.text-right SGST
                                    th.text-right Amount
                                    th Notes
                                    th.text-center Actions
                            tbody#billItems
                                tr.item-row
                                    td
                                        select.form-control.product-select(name='items[0][product_id]' required)
                                            option(value='') Select Product
                                            each product in products
                                                option(
                                                    value=product.product_id 
                                                    data-product-name=product.product_name 
                                                    data-price=product.price
                                                    data-cgst-percent=product.cgst_percent || 0
                                                    data-sgst-percent=product.sgst_percent || 0
                                                    data-unit=product.unit
                                                    data-hsn-code=product.hsn_code || ''
                                                ) #{product.product_name}
                                    td
                                        input.form-control.price-input.text-right(type='number' step="0.001" name='items[0][price]' readonly)
                                    td
                                        input.form-control.qty-input.text-right(type='number' step='0.001' name='items[0][qty]' required min='0')
                                    td
                                        input.form-control.discount-input.text-right(type='number' step='0.01' name='items[0][price_discount]' value="0" min='0')
                                    td.text-right
                                        span.subtotal-display 0.00
                                        input.subtotal-hidden(type='hidden' name='items[0][base_amount]')
                                    td.text-right
                                        span.cgst-display 0.00
                                        input.cgst-hidden(type='hidden' name='items[0][cgst_amount]')
                                    td.text-right
                                        span.sgst-display 0.00
                                        input.sgst-hidden(type='hidden' name='items[0][sgst_amount]')    
                                    td
                                        input.form-control.amount-input.text-right(type='number' step='0.001' name='items[0][amount]' required min='0')
                                    td
                                        input.form-control.notes-input(type='text' name='items[0][notes]')
                                    td.text-center
                                        button.btn.btn-danger.btn-sm.remove-row(type='button' disabled) 
                                            i.bi.bi-trash

                    //- Mobile Items List
                    #mobileItemsList.list-group.mb-3
                    
                    //- Total Amount Row
                    .row.mt-3
                        .col-12.col-md-6.offset-md-6
                            .card.bg-light
                                .card-body
                                    .d-flex.justify-content-between
                                        h5.mb-0 Total Amount:
                                        h5#totalAmount.mb-0 â‚¹ 0.00

                    //- Submit Button
                    .row.mt-3
                        .col-12.text-right
                            button.btn.btn-primary#saveBtn(type='submit') Save Bill
                            button.btn.btn-info.ms-2#printBtn(type='button' disabled)
                                i.bi.bi-printer
                                |  Print


    //- Embed data for JavaScript
    script.
        const products = !{JSON.stringify(products)};
        const userLocationCode = '#{user.location_code}';
        billsVehicleData = !{JSON.stringify(vehicleData)};

    script(src="/javascripts/bills.js")