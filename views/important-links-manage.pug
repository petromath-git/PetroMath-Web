extends layout

block content
    .container-fluid
        // Header
        .row.mb-4
            .col-12
                .d-flex.justify-content-between.align-items-center
                    h3.mb-0
                        i.bi.bi-link-45deg.me-2
                        | Manage Important Links
                    .d-flex.gap-2
                        button.btn.btn-primary(type="button" data-toggle="modal" data-target="#linkModal" onclick="openAddModal()")
                            i.bi.bi-plus-circle.me-1
                            | Add Link
                        button.btn.btn-info(type="button" onclick="location.reload()")
                            i.bi.bi-arrow-clockwise.me-1
                            | Refresh

        // Filters
        .row.mb-3
            .col-md-3
                input.form-control#searchInput(type="text" placeholder="Search links..." autocomplete="off")
            .col-md-2
                select.form-control#categoryFilter
                    option(value="") All Categories
                    each category in categories
                        option(value=category.lookup_id)= category.description
            .col-md-2
                select.form-control#scopeFilter
                    option(value="") All Scopes
                    option(value="GLOBAL") Global
                    option(value="COMPANY") Company
                    option(value="LOCATION") Location
            .col-md-2
                select.form-control#statusFilter
                    option(value="") All Status
                    option(value="1") Published
                    option(value="0") Unpublished

        // Links Table
        .row
            .col-12
                .table-responsive
                    table.table.table-hover.table-striped#linksTable
                        thead.thead-dark
                            tr
                                th Title
                                th Category
                                th Scope
                                th Visible To
                                th Status
                                th Actions
                        tbody
                            each link in links
                                tr(data-category=link.category_id data-scope=link.scope_type data-status=link.is_published)
                                    td
                                        a(href=link.url target="_blank")= link.title
                                        if link.description
                                            br
                                            small.text-muted= link.description
                                    td= link.category_name
                                    td
                                        if link.scope_type === 'GLOBAL'
                                            span.badge.bg-primary Global
                                        else if link.scope_type === 'COMPANY'
                                            span.badge.bg-info= link.company_name
                                        else
                                            span.badge.bg-secondary= link.location_name
                                    td
                                        small= link.visible_to_roles || 'None'
                                    td
                                        if link.is_published
                                            span.badge.bg-success Published
                                        else
                                            span.badge.bg-warning Unpublished
                                    td
                                        button.btn.btn-sm.btn-outline-primary.me-1(onclick=`editLink(${link.link_id})` title="Edit")
                                            i.bi.bi-pencil
                                        button.btn.btn-sm.btn-outline-secondary(onclick=`togglePublish(${link.link_id})` title="Toggle Status")
                                            if link.is_published
                                                i.bi.bi-eye-slash
                                            else
                                                i.bi.bi-eye
                            if links.length === 0
                                tr
                                    td.text-center.text-muted(colspan="6") No links found

    // Add/Edit Modal
    .modal.fade#linkModal(tabindex="-1" role="dialog")
        .modal-dialog.modal-lg(role="document")
            .modal-content
                .modal-header
                    h5.modal-title#modalTitle Add New Link
                    button.close(type="button" data-dismiss="modal" aria-label="Close")
                        span(aria-hidden="true") &times;
                .modal-body
                    form#linkForm
                        input#linkId(type="hidden" name="link_id")
                        
                        .row
                            .col-md-6
                                .form-group
                                    label.form-label Title *
                                    input.form-control#title(type="text" name="title" required maxlength="255")
                            .col-md-6
                                .form-group
                                    label.form-label URL *
                                    input.form-control#url(type="url" name="url" required maxlength="500" placeholder="https://")
                        
                        .row.mt-3
                            .col-12
                                .form-group
                                    label.form-label Description
                                    textarea.form-control#description(name="description" rows="2" maxlength="500")
                        
                        .row.mt-3
                            .col-md-6
                                .form-group
                                    label.form-label Category *
                                    select.form-control#category_id(name="category_id" required)
                                        option(value="") Select Category
                                        each category in categories
                                            option(value=category.lookup_id)= category.description
                            .col-md-6
                                .form-group
                                    label.form-label Display Order
                                    input.form-control#display_order(type="number" name="display_order" value="0" min="0")
                        
                        .row.mt-3
                            .col-md-4
                                .form-group
                                    label.form-label Scope *
                                    select.form-control#scope_type(name="scope_type" required onchange="handleScopeChange()")
                                        if userRole === 'SuperUser'
                                            option(value="GLOBAL") Global
                                            option(value="COMPANY") Company
                                        option(value="LOCATION") Location
                            .col-md-4#companyGroup(style="display:none")
                                .form-group
                                    label.form-label Company *
                                    select.form-control#company_id(name="company_id")
                                        option(value="") Select Company
                                        each company in oilCompanies
                                            option(value=company.lookup_id)= company.description
                            .col-md-4#locationGroup
                                .form-group
                                    label.form-label Location *
                                    select.form-control#location_id(name="location_id")
                                        option(value="") Select Location
                                        each loc in locations
                                            option(value=loc.location_id)= loc.location_name
                        
                        hr.my-3
                        
                        h6 Credentials (Optional)
                        .row
                            .col-md-6
                                .form-group
                                    label.form-label Username
                                    input.form-control#username(type="text" name="username" maxlength="255" autocomplete="off")
                            .col-md-6
                                .form-group
                                    label.form-label Password
                                    .input-group
                                        input.form-control#password(type="password" name="password" maxlength="255" autocomplete="new-password")
                                        .input-group-append
                                            button.btn.btn-outline-secondary(type="button" onclick="togglePasswordVisibility()")
                                                i.bi.bi-eye#passwordToggleIcon
                        
                        hr.my-3
                        
                        h6 Visibility
                        .row
                            .col-md-6
                                .form-group
                                    label.form-label Visible to Roles *
                                    .roles-checkboxes
                                        each role in roles
                                            .form-check
                                                input.form-check-input(type="checkbox" name="role_ids" value=role.role_id id=`role_${role.role_id}`)
                                                label.form-check-label(for=`role_${role.role_id}`)= role.role_display_name || role.role_name
                            .col-md-6
                                .form-group
                                    label.form-label Status
                                    .form-check.mt-2
                                        input.form-check-input#is_published(type="checkbox" name="is_published")
                                        label.form-check-label(for="is_published") Publish this link
                
                .modal-footer
                    button.btn.btn-secondary(type="button" data-dismiss="modal") Cancel
                    button.btn.btn-primary#saveBtn(type="button" onclick="saveLink()") Save Link

    // JavaScript
    script.
        const linksData = !{JSON.stringify(links)};
        const userRole = '#{userRole}';
        const userLocationId = #{userLocationId};
        let isEditMode = false;

        $(document).ready(function() {
            initializeFilters();
            handleScopeChange();
        });

        function initializeFilters() {
            $('#searchInput, #categoryFilter, #scopeFilter, #statusFilter').on('change keyup', function() {
                filterTable();
            });
        }

        function filterTable() {
            const search = $('#searchInput').val().toLowerCase();
            const category = $('#categoryFilter').val();
            const scope = $('#scopeFilter').val();
            const status = $('#statusFilter').val();

            $('#linksTable tbody tr').each(function() {
                const row = $(this);
                const text = row.text().toLowerCase();
                const rowCategory = row.data('category')?.toString();
                const rowScope = row.data('scope');
                const rowStatus = row.data('status')?.toString();

                let show = true;
                if (search && !text.includes(search)) show = false;
                if (category && rowCategory !== category) show = false;
                if (scope && rowScope !== scope) show = false;
                if (status && rowStatus !== status) show = false;

                row.toggle(show);
            });
        }

        function handleScopeChange() {
            const scope = $('#scope_type').val();
            
            if (scope === 'GLOBAL') {
                $('#companyGroup').hide();
                $('#locationGroup').hide();
                $('#company_id').prop('required', false);
                $('#location_id').prop('required', false);
            } else if (scope === 'COMPANY') {
                $('#companyGroup').show();
                $('#locationGroup').hide();
                $('#company_id').prop('required', true);
                $('#location_id').prop('required', false);
            } else {
                $('#companyGroup').hide();
                $('#locationGroup').show();
                $('#company_id').prop('required', false);
                $('#location_id').prop('required', true);
            }
        }

        function openAddModal() {
            isEditMode = false;
            $('#modalTitle').text('Add New Link');
            $('#linkForm')[0].reset();
            $('#linkId').val('');
            $('input[name="role_ids"]').prop('checked', false);
            
            // Set default scope based on role
            if (userRole === 'Manager') {
                $('#scope_type').val('LOCATION');
                $('#location_id').val(userLocationId);
            }
            handleScopeChange();
        }

        function editLink(linkId) {
            isEditMode = true;
            $('#modalTitle').text('Edit Link');
            
            $.get(`/important-links/api/${linkId}`, function(response) {
                if (response.success) {
                    const link = response.data;
                    
                    $('#linkId').val(link.link_id);
                    $('#title').val(link.title);
                    $('#url').val(link.url);
                    $('#description').val(link.description);
                    $('#category_id').val(link.category_id);
                    $('#display_order').val(link.display_order);
                    $('#scope_type').val(link.scope_type);
                    $('#company_id').val(link.company_id);
                    $('#location_id').val(link.location_id);
                    $('#username').val(link.username);
                    $('#password').val(link.password_decrypted || '');
                    $('#is_published').prop('checked', link.is_published == 1);
                    
                    // Set role checkboxes
                    $('input[name="role_ids"]').prop('checked', false);
                    if (link.role_ids) {
                        link.role_ids.forEach(roleId => {
                            $(`#role_${roleId}`).prop('checked', true);
                        });
                    }
                    
                    handleScopeChange();
                    $('#linkModal').modal('show');
                } else {
                    alert('Error loading link: ' + response.message);
                }
            });
        }

        function saveLink() {
            const form = $('#linkForm')[0];
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get selected roles
            const roleIds = [];
            $('input[name="role_ids"]:checked').each(function() {
                roleIds.push(parseInt($(this).val()));
            });

            if (roleIds.length === 0) {
                alert('Please select at least one role for visibility');
                return;
            }

            const data = {
                title: $('#title').val(),
                url: $('#url').val(),
                description: $('#description').val(),
                category_id: $('#category_id').val(),
                display_order: $('#display_order').val(),
                scope_type: $('#scope_type').val(),
                company_id: $('#company_id').val() || null,
                location_id: $('#location_id').val() || null,
                username: $('#username').val(),
                password: $('#password').val(),
                is_published: $('#is_published').is(':checked'),
                role_ids: roleIds
            };

            const linkId = $('#linkId').val();
            const url = isEditMode ? `/important-links/api/${linkId}` : '/important-links/api/create';
            const method = isEditMode ? 'PUT' : 'POST';

            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    if (response.success) {
                        $('#linkModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function(xhr) {
                    const msg = xhr.responseJSON?.message || 'Error saving link';
                    alert(msg);
                }
            });
        }

        function togglePublish(linkId) {
            if (!confirm('Are you sure you want to change the publish status?')) return;

            $.post(`/important-links/api/${linkId}/toggle-publish`, function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error: ' + response.message);
                }
            }).fail(function(xhr) {
                const msg = xhr.responseJSON?.message || 'Error updating status';
                alert(msg);
            });
        }

        function togglePasswordVisibility() {
            const input = $('#password');
            const icon = $('#passwordToggleIcon');
            
            if (input.attr('type') === 'password') {
                input.attr('type', 'text');
                icon.removeClass('bi-eye').addClass('bi-eye-slash');
            } else {
                input.attr('type', 'password');
                icon.removeClass('bi-eye-slash').addClass('bi-eye');
            }
        }

    // Styles
    style.
        .roles-checkboxes {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
        }
        .table th {
            white-space: nowrap;
        }