extends layout

block content
    
    form(method='POST' action='/reports-creditsummary')  

        script.
            
            // Javascript that gets table data
            var creditstmtFromServer = !{JSON.stringify(creditsummary)} 

            function renderTable(array, tabletitle, numberColumns = [], centerColumns = [], tableWidthClass = '') {
                var result = "<div class='card' style='margin-bottom: 10px;'>";
                result += "<div class='card-header text-center font-weight-bold' >" + tabletitle + "</div>";
                result += "<div class='card-body " + tableWidthClass + "' style='padding-bottom: 10px;'>";
                result += "<table class='table table-bordered table-sm' style='width: 100%; border: 1px solid #000;'>";
                
                // Build headers (exclude internal flags that start with _)
                if (array.length > 0 && typeof array[0] === 'object') {
                    result += "<thead class='thead-light text-center'><tr>";
                    Object.keys(array[0]).forEach(key => {
                        if (!key.startsWith('_')) {  // Skip internal flags
                            result += "<th style='border: 1px solid #000;'>" + key + "</th>";
                        }
                    });
                    result += "</tr></thead>";
                }
                
                result += "<tbody>";
                
                for (var i = 0; i < array.length; i++) {
                    let rowClass = '';
                    let cellBgColor = '';  // Background color for cells
                    
                    // Check for overdue flag
                    if (array[i]._isOverdue) {
                        cellBgColor = 'background-color: #ffcccc !important;';  // Light red with !important
                    }
                    
                    // Check if it's the last row and contains "Total"
                    if (i === array.length - 1) {
                        let isTotalRow = Object.values(array[i]).some(value => value && 
                            (value.toString().toLowerCase().includes("total") || value.toString().toLowerCase().includes("excess"))
                        );
                        if (isTotalRow) {
                            rowClass = 'font-weight-bold text-danger';
                        }
                    }
                    
                    result += "<tr>";
                    Object.keys(array[i]).forEach(key => {
                        // Skip internal flags
                        if (key.startsWith('_')) {
                            return;
                        }
                        
                        let dataValue = array[i][key];
                        let alignment = 'text-left'; // default
                        
                        // Determine alignment
                        if (numberColumns.includes(key) && dataValue !== "" && !isNaN(dataValue)) {
                            alignment = 'text-right';
                        } else if (centerColumns.includes(key)) {
                            alignment = 'text-center';
                        }
                        
                        // Build the cell style with background color
                        let cellStyle = 'border: 1px solid #000;';
                        if (cellBgColor) {
                            cellStyle += ' ' + cellBgColor;
                        }
                        
                        // Format number columns
                        if (numberColumns.includes(key) && dataValue !== "" && !isNaN(dataValue)) {
                            let printedValue = new Intl.NumberFormat('en-IN', {
                                style: 'decimal',
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }).format(dataValue);
                            result += "<td class='" + rowClass + " " + alignment + "' style='" + cellStyle + "'>" + printedValue + "</td>";
                        } else {
                            result += "<td class='" + rowClass + " " + alignment + "' style='" + cellStyle + "'>" + dataValue + "</td>";
                        }
                    });
                    result += "</tr>";
                }
                
                result += "</tbody></table></div></div>";
                return result;
            }

            document.addEventListener('DOMContentLoaded', function() {
                document.getElementById('creditsummary-table-container').innerHTML = 
                    renderTable(
                        creditstmtFromServer, 
                        '', 
                        ['Balance', 'Last Receipt Amount', 'Days Since Receipt'],  // right-aligned
                        ['S.no', 'Last Receipt Date']  // center-aligned
                    );
            });

        table.center
            tr              
                td Date:
                td
                    input#toclosingDate.form-control(type='date', name='toClosingDate', value=toClosingDate max=currentDate format="dd/mm/yyyy" required)
                td &nbsp; 
                include report-print-download.pug
    div &nbsp;
    div
        div.row &nbsp;
        h4.font-weight-bold.text-center= "Credit Summary Report"                             
        h4.text-center.text-muted= formattedtoDate
        h4.font-weight-bold.text-success.text-center    
        if creditsummary && creditsummary.length > 0                                      
            div.row
            div.col-md-12
                div.row &nbsp;                
                div(id="creditsummary-table-container") 
        else
            div.row &nbsp;
            div.row.bg-light No records to display.

    // Include the overlay
    include overlay.pug                           
                            

    
