extends layout

block content
    style.
        .table-responsive {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
        }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa;
        }

        .unreconciled-amount {
            color: #dc3545 !important;
            font-weight: 600;
        }

        /* Checkbox styling */
        .txn-checkbox {
            width: 15px;
            height: 15px;
            accent-color: #0d6efd; /* Bootstrap primary blue */
            cursor: pointer;
            transform: scale(1.05);
            border-radius: 4px;
        }

        /* Selected row (darker) */
        tr.selected-row {
            background-color: rgba(13, 110, 253, 0.20) !important; /* darker than before */
        }

        tr:hover {
            background-color: #f5faff !important;
        }

        /* Narration column narrower with ellipsis */
        td.narration-cell {
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Selected summary sticky */
        #selected-summary {
            position: sticky;
            bottom: 0;
            background: #fff3cd;
            z-index: 999;
            border-top: 2px solid #ffc107;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        @media print {
            .table-responsive {
                max-height: none !important;
                overflow-y: visible !important;
                overflow-x: visible !important;
            }
            
            table {
                page-break-inside: auto;
            }
            
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            thead {
                display: table-header-group;
            }
            
            tfoot {
                display: table-footer-group;
            }
            
            /* Hide checkboxes and interactive elements in print */
            .row-select,
            #selectAll,
            button,
            .btn {
                display: none !important;
            }
            
            /* Ensure selected summary is visible */
            #selected-summary {
                position: static !important;
                page-break-before: avoid;
            }
            
            /* Remove sticky positioning from headers */
            .table thead {
                position: static !important;
            }
        }

    script.
        var creditstmtFromServer = !{JSON.stringify(creditstmt)};
        var currentData = creditstmtFromServer;

        // Render table (checkbox column always visible)
        function renderTable(array, tabletitle, numberColumns = [], tableWidthClass = '') {
            var result = "<div class='table-responsive'>";
            result += "<table class='table table-bordered table-sm table-hover' style='width: 100%; border: 1px solid #dee2e6; margin-top: 10px;'>";

            if (array.length > 0 && typeof array[0] === 'object') {
                result += "<thead class='thead-light'><tr>";
                // Checkbox header column - wider
                result += "<th class='text-center' style='width: 80px; border: 1px solid #dee2e6;'>Select<br><input type='checkbox' id='selectAll' onclick='toggleSelectAll(this)' /></th>";
                result += "<th class='text-center' style='min-width:90px; border: 1px solid #dee2e6;'>Match ID</th>";

                Object.keys(array[0]).forEach(key => {
                    if (key !== 'companyName' && key !== 'reconciled' && key !== 'match_id' && key !== 'possibleMatch' && key !== 'reconciliation_pass' && key !== 'unique_id') {
                        // make Narration column narrower
                        let widthStyle = (key === 'Narration') ? "max-width:220px;" : "";
                        result += `<th class='text-center' style='border: 1px solid #dee2e6; ${widthStyle}'>${key}</th>`;
                    }
                });
                result += "<th class='text-center' style='width:120px; border: 1px solid #dee2e6;'>Status</th>";
                result += "</tr></thead>";
            }

            result += "<tbody>";

            for (var i = 0; i < array.length; i++) {
                let row = array[i];
                let rowClass = '';
                if (i === array.length - 1) {
                    let isTotalRow = Object.values(row).some(value => value &&
                        (value.toString().toLowerCase().includes('total') || value.toString().toLowerCase().includes('excess'))
                    );
                    if (isTotalRow) rowClass = 'font-weight-bold text-dark bg-light';
                }

                result += `<tr class='${rowClass}'>`;

                // Checkbox cell (always visible)
                result += `<td class='text-center' style='border: 1px solid #dee2e6; vertical-align: middle;'>
                             <input type='checkbox' class='row-select txn-checkbox' onchange='updateSelectedTotals()'
                             data-debit='${row.Debit || 0}' data-credit='${row.Credit || 0}'>
                           </td>`;

                // Match ID column
                const matchId = row.match_id || '';
                const matchIdClass = matchId ? 'text-primary font-weight-bold' : 'text-muted';
                result += `<td class='text-center ${matchIdClass}' style='border: 1px solid #dee2e6; vertical-align: middle;'>${matchId || '-'}</td>`;

                // Data columns
                Object.keys(row).forEach(key => {
                    if (key !== 'companyName' && key !== 'reconciled' && key !== 'match_id' && key !== 'possibleMatch' && key !== 'reconciliation_pass' && key !== 'unique_id') {
                        let dataValue = row[key];
                        const isAmount = numberColumns.includes(key);
                        const isUnreconciled = !row.reconciled;
                        const amountClass = isAmount && isUnreconciled ? 'unreconciled-amount' : '';
                        const tdClass = (key === 'Narration') ? 'narration-cell' : '';

                        if (isAmount && dataValue && !isNaN(dataValue)) {
                            const printedValue = new Intl.NumberFormat('en-IN', {
                                style: 'decimal',
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }).format(dataValue);
                            result += `<td class='text-right ${amountClass}' style='border: 1px solid #dee2e6; vertical-align: middle;'>${printedValue}</td>`;
                        } else {
                            result += `<td class='${tdClass}' style='border: 1px solid #dee2e6; vertical-align: middle;'>${dataValue || ''}</td>`;
                        }
                    }
                });

                // Status icon logic (preserve your pass colors)
                let statusIcon;
                if (row.reconciled) {
                    if (row.reconciliation_pass === 2)
                        statusIcon = "<i class='bi bi-check-circle-fill' style='color: #ffa500;' title='Extended match (±5 days)'></i>";
                    else if (row.reconciliation_pass === 3)
                        statusIcon = "<i class='bi bi-check-circle-fill' style='color: #9333ea;' title='Reverse match (1→N)'></i>";
                    else if (row.reconciliation_pass === 4)
                        statusIcon = "<i class='bi bi-check-circle-fill' style='color: #198754;' title='Adjustment/Commission reconciliation'></i>";
                    else if (row.reconciliation_pass === 5)
                        statusIcon = "<i class='bi bi-check-circle-fill' style='color: #0dcaf0;' title='Shift offset carryover'></i>";
                    else
                        statusIcon = "<i class='bi bi-check-circle-fill text-success' title='Matched (standard pass)'></i>";
                } else {
                    statusIcon = "<i class='bi bi-x-circle text-muted'></i>";
                }

                let statusCell = statusIcon;
                if (row.possibleMatch && !row.reconciled) {
                    const pm = row.possibleMatch;
                    statusCell += `<br><small class='text-warning'>
                        <i class='bi bi-exclamation-triangle-fill'></i> Found in ${pm.vendor}
                    </small>`;
                }

                result += `<td class='text-center' style='border: 1px solid #dee2e6; vertical-align: middle;'>${statusCell}</td>`;
                result += "</tr>";
            }

            result += "</tbody></table></div>";
            return result;
        }

        
        
        
        // Live search
        function liveSearch() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const transactionType = document.getElementById('transactionType').value;
            const showUnreconciledOnly = document.getElementById('showUnreconciled').checked;
            
            let filteredData = currentData;
            
            // First apply "Show Only Unreconciled" filter
            if (showUnreconciledOnly) {
                filteredData = filteredData.filter(row => !row.reconciled);
            }
            
            // Then apply transaction type filter
            if (transactionType === 'credit') {
                filteredData = filteredData.filter(row => {
                    return row.Credit && parseFloat(row.Credit) > 0;
                });
            } else if (transactionType === 'debit') {
                filteredData = filteredData.filter(row => {
                    return row.Debit && parseFloat(row.Debit) > 0;
                });
            }
            
            // Finally apply search filter
            if (searchValue) {
                filteredData = filteredData.filter(row => {
                    return Object.values(row).some(value => {
                        if (value === null || value === undefined) return false;
                        return value.toString().toLowerCase().includes(searchValue);
                    });
                });
            }
            
            document.getElementById('creditstmt').innerHTML = renderTable(filteredData, 'Digital Reconciliation', ['Debit', 'Credit']);
            updateTotals(filteredData);
            clearSelections();
        }



        // Filter by transaction type (Credit/Debit)
        function filterByTransactionType() {
           liveSearch(); // Just call liveSearch since it handles all filters now
        }

       function updateTotals(data) {
            let unreconciledDebit = 0, unreconciledCredit = 0;

            data.forEach(tx => {
                if (!tx.reconciled) {
                    if (tx.Debit) unreconciledDebit += parseFloat(tx.Debit);
                    if (tx.Credit) unreconciledCredit += parseFloat(tx.Credit);
                }
            });

            const diff = unreconciledDebit - unreconciledCredit;
            const absDiff = Math.abs(diff);

            const formatCurrency = num => new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);

            // Color logic
            const colorClass = diff > 0 ? 'text-danger' : (diff < 0 ? 'text-success' : 'text-muted');
            const labelText = diff > 0 ? 'Debit Excess' : (diff < 0 ? 'Credit Excess' : 'Perfectly Balanced');

            const totalsHTML = `
                <div class="card mt-3 mb-3 border-2 shadow-sm">
                    <div class="card-body py-3 text-center">
                        <div>
                            <small class="text-muted d-block mb-1">
                                <i class="bi bi-exclamation-diamond me-1 text-secondary"></i>
                                Unreconciled Difference
                            </small>
                            <h3 class="${colorClass}" style="font-weight:700;">₹${formatCurrency(absDiff)}</h3>
                            <div class="small text-muted">${labelText}</div>
                        </div>
                    </div>
                </div>
            `;

            let totalsDiv = document.getElementById('totals-summary');
            if (!totalsDiv) {
                totalsDiv = document.createElement('div');
                totalsDiv.id = 'totals-summary';
                const container = document.getElementById('creditstmt-table-container');
                container.parentNode.insertBefore(totalsDiv, container);
            }
            totalsDiv.innerHTML = totalsHTML;
        }


        // Inline calculator + row highlight (unchanged logic)
        function updateSelectedTotals() {
            const checkboxes = document.querySelectorAll('.row-select');
            let totalDebit = 0, totalCredit = 0, count = 0;

            checkboxes.forEach(cb => {
                const row = cb.closest('tr');
                if (cb.checked) {
                    totalDebit += parseFloat(cb.dataset.debit || 0);
                    totalCredit += parseFloat(cb.dataset.credit || 0);
                    count++;
                    row.classList.add('selected-row'); // highlight
                } else {
                    row.classList.remove('selected-row');
                }
            });

            const diff = totalDebit - totalCredit;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('selected-debit').textContent = totalDebit.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            document.getElementById('selected-credit').textContent = totalCredit.toLocaleString('en-IN', { minimumFractionDigits: 2 });
            document.getElementById('selected-diff').textContent = Math.abs(diff).toLocaleString('en-IN', { minimumFractionDigits: 2 });

            const diffElement = document.getElementById('selected-diff');
            if (diffElement && diffElement.parentNode) {
                diffElement.parentNode.classList.remove('text-success', 'text-danger');
                diffElement.parentNode.classList.add(diff >= 0 ? 'text-danger' : 'text-success');
            }

            const summary = document.getElementById('selected-summary');
            if (summary) summary.classList.toggle('d-none', count === 0);
        }

        // Select All toggle
        function toggleSelectAll(masterCheckbox) {
            const checkboxes = document.querySelectorAll('.row-select');
            checkboxes.forEach(cb => {
                cb.checked = masterCheckbox.checked;
                const row = cb.closest('tr');
                if (masterCheckbox.checked) {
                    row.classList.add('selected-row');
                } else {
                    row.classList.remove('selected-row');
                }
            });
            updateSelectedTotals();
        }

        // Clear selections
        function clearSelections() {
            document.querySelectorAll('.row-select').forEach(cb => {
                cb.checked = false;
                const row = cb.closest('tr');
                if (row) row.classList.remove('selected-row');
            });
            const master = document.getElementById('selectAll');
            if (master) master.checked = false;
            updateSelectedTotals();
        }

        document.addEventListener('DOMContentLoaded', function() {
            liveSearch();
        });

    // Filter + Controls (removed enable selection toggle)
    .card.mb-3
        .card-header(style='cursor: pointer; background-color: #f8f9fa;')
            .d-flex.justify-content-between.align-items-center
                h6.mb-0 
                    i.bi.bi-funnel.me-2
                    | Digital Reconciliation Filters
        .card-body
            form(method='POST' action='/reports-digital-recon')
                .row.g-3.align-items-end
                    .col-lg-2.col-md-3.col-6
                        label.form-label Date Range:
                        select#dateRange.form-control(onchange='updateDateRange()')
                            option(value='this_month') This Month
                            option(value='last_month') Last Month
                            option(value='custom' selected) Custom
                    .col-lg-2.col-md-3.col-6
                        label.form-label From:
                        input#fromclosingDate.form-control(type='date', name='fromClosingDate', value=fromClosingDate, max=currentDate, required)
                    .col-lg-2.col-md-3.col-6
                        label.form-label To:
                        input#toclosingDate.form-control(type='date', name='toClosingDate', value=toClosingDate, max=currentDate, required)
                    .col-lg-2.col-md-3.col-6
                        label.form-label Digital Vendor:
                        select#company_id.form-control(name='company_id' required)
                            if credits
                                each val in credits
                                    option(value=`${val.id}`, selected=company_id == val.id ? true : undefined)= val.name
                    .col-lg-2.col-md-3.col-6
                        label.form-label Transaction Type:
                        select#transactionType.form-control(onchange='filterByTransactionType()')
                            option(value='all') All
                            option(value='credit') Credit Only
                            option(value='debit') Debit Only
                    .col-lg-2.col-md-3.col-6
                        label.form-label Search:
                        input#searchInput.form-control(type='text', placeholder='Search...', oninput='liveSearch()')
                    .col-lg-2.col-md-3.col-6
                        label.form-label &nbsp;
                        .d-flex.gap-2
                            include report-print-download.pug
                .row.mt-3
                    .col-12
                        .form-check
                            input#showUnreconciled.form-check-input(type='checkbox', onchange='liveSearch()')
                            label.form-check-label(for='showUnreconciled')
                                i.bi.bi-filter-circle.me-1
                                | Show Only Unreconciled

    .container-fluid
        if creditstmt && creditstmt.length > 0
            - var companyName = creditstmt[0].companyName
            div
                h5.text-center.mb-1 Digital Reconciliation Report
                h6.text-center.text-primary.text-uppercase= companyName
                p.text-center.text-muted
                    i.bi.bi-calendar-range.me-2
                    = `${formattedFromDate} to ${formattedToDate}`

                .d-flex.justify-content-center.gap-4.mb-3.small
                    div
                        i.bi.bi-check-circle-fill.text-success.me-1
                        span Standard Match (±1d)
                    div
                        i.bi.bi-check-circle-fill.me-1(style='color:#ffa500;')
                        span Extended (±5d)
                    div
                        i.bi.bi-check-circle-fill.me-1(style='color:#9333ea;')
                        span Reverse (1→N)
                    div
                        i.bi.bi-x-circle.text-muted.me-1
                        span Unmatched
                
                div#creditstmt-table-container
                #selected-summary.card.shadow-sm.border.mt-2.px-3.py-2.d-none
                    .d-flex.justify-content-around.align-items-center.small
                        div
                            b Selected: 
                            span#selected-count 0
                        div
                            b Debit: 
                            span.text-danger ₹
                            span#selected-debit 0.00
                        div
                            b Credit: 
                            span.text-success ₹
                            span#selected-credit 0.00
                        div
                            b Difference: 
                            span#selected-diff 0.00
                        button.btn.btn-sm.btn-outline-secondary(onclick='clearSelections()')
                            i.bi.bi-x-circle.me-1
                            | Clear
        else
            .alert.alert-info.text-center.mt-4(role='alert')
                i.bi.bi-info-circle.me-2
                | No transactions found for the selected period.

    include overlay.pug
